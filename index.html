<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Th√©.OS Finance</title>
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='none' stroke='%23ff3b30' stroke-width='8'/><circle cx='50' cy='50' r='12' fill='%23ff3b30'/></svg>">
    <style>
:root {
    --bg-primary: #0a0a0a;
    --bg-secondary: #111111;
    --bg-tertiary: #1a1a1a;
    --bg-hover: #222222;
    --border: #2a2a2a;
    --border-light: #333333;
    --text-primary: #ffffff;
    --text-secondary: #888888;
    --text-muted: #555555;
    --accent: #ff3b30;
    --accent-hover: #ff5147;
    --green: #34c759;
    --green-dim: rgba(52, 199, 89, 0.15);
    --red: #ff3b30;
    --red-dim: rgba(255, 59, 48, 0.15);
    --blue: #007aff;
    --blue-dim: rgba(0, 122, 255, 0.15);
    --orange: #ff9500;
    --orange-dim: rgba(255, 149, 0, 0.15);
    --purple: #af52de;
    --purple-dim: rgba(175, 82, 222, 0.15);
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --sidebar-width: 260px;
    --font-mono: 'SF Mono', 'Fira Code', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-top: env(safe-area-inset-top, 0px);
}
[data-theme="light"] {
    --bg-primary: #f5f5f7;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e8e8ed;
    --bg-hover: #d1d1d6;
    --border: #d1d1d6;
    --border-light: #c7c7cc;
    --text-primary: #1d1d1f;
    --text-secondary: #6e6e73;
    --text-muted: #aeaeb2;
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { font-size: 16px; }
body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; overflow-x: hidden; min-height: 100vh; min-height: 100dvh; }
button, input, select, textarea { font-family: inherit; font-size: inherit; }
input, select { font-size: 16px !important; }

/* AUTH */
.auth-screen { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; padding-top: calc(20px + var(--safe-top)); }
.auth-container { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(24px, 6vw, 40px); width: 100%; max-width: 420px; max-height: calc(100vh - 40px); max-height: calc(100dvh - 40px); overflow-y: auto; }
.auth-logo { text-align: center; margin-bottom: 28px; }
.auth-logo .logo-icon { font-size: clamp(36px, 10vw, 48px); color: var(--accent); }
.auth-logo h1 { font-size: clamp(20px, 5vw, 24px); margin-top: 12px; font-weight: 600; }
.auth-logo p { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
.auth-tabs { display: flex; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
.auth-tab { flex: 1; padding: 12px 8px; background: none; border: none; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s; }
.auth-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.auth-form { display: none; flex-direction: column; gap: 16px; }
.auth-form.active { display: flex; }
.auth-form .form-group { display: flex; flex-direction: column; gap: 6px; }
.auth-form label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.auth-form input { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 16px; color: var(--text-primary); font-size: 16px !important; width: 100%; }
.auth-form input:focus { outline: none; border-color: var(--accent); }
.auth-form .btn-primary { margin-top: 8px; padding: 16px; font-size: 16px; width: 100%; }
.auth-info { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 12px; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
.auth-info strong { color: var(--text-primary); }
.password-strength { height: 4px; background: var(--bg-tertiary); border-radius: 2px; margin-top: 6px; overflow: hidden; }
.password-strength-bar { height: 100%; transition: all 0.3s; border-radius: 2px; width: 0; }
.strength-weak { width: 33%; background: var(--red); }
.strength-medium { width: 66%; background: var(--orange); }
.strength-strong { width: 100%; background: var(--green); }
.link-code-box { background: var(--bg-primary); border: 2px dashed var(--border); border-radius: var(--radius-md); padding: 20px; text-align: center; margin: 16px 0; }
.link-code { font-family: var(--font-mono); font-size: clamp(14px, 4vw, 18px); font-weight: 600; color: var(--accent); letter-spacing: 1px; word-break: break-all; }
.link-code-hint { font-size: 12px; color: var(--text-muted); margin-top: 8px; }
.auth-error { background: var(--red-dim); border: 1px solid var(--red); color: var(--red); padding: 12px; border-radius: var(--radius-md); font-size: 13px; display: none; }
.auth-error.show { display: block; }

/* APP LAYOUT */
.app { display: none; min-height: 100vh; min-height: 100dvh; }
.app.active { display: flex; }

/* SIDEBAR */
.sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; opacity: 0; visibility: hidden; transition: all 0.3s; }
.sidebar-overlay.active { opacity: 1; visibility: visible; }
.logo { padding: 20px 24px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
.logo-icon { font-size: 24px; color: var(--accent); }
.logo-text { font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
.user-info { padding: 16px 24px; border-bottom: 1px solid var(--border); }
.user-name { font-size: 14px; font-weight: 600; }
.user-sync { font-size: 12px; color: var(--text-muted); margin-top: 2px; display: flex; align-items: center; gap: 4px; }
.user-sync.synced { color: var(--green); }
.nav-links { list-style: none; padding: 12px; flex: 1; overflow-y: auto; }
.nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 16px; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all 0.2s; margin-bottom: 4px; font-size: 14px; font-weight: 500; }
.nav-link:hover { background: var(--bg-hover); color: var(--text-primary); }
.nav-link.active { background: var(--bg-tertiary); color: var(--text-primary); }
.nav-icon { font-size: 18px; width: 24px; text-align: center; }
.sidebar-footer { padding: 16px; border-top: 1px solid var(--border); padding-bottom: calc(16px + var(--safe-bottom)); }
.btn-logout { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px 16px; background: var(--red-dim); border: none; border-radius: var(--radius-md); color: var(--red); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-logout:hover { background: var(--red); color: white; }

/* MOBILE HEADER */
.mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); align-items: center; padding: 0 16px; padding-top: var(--safe-top); z-index: 90; }
.menu-toggle { background: none; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer; padding: 8px; margin-left: -8px; }
.mobile-title { flex: 1; text-align: center; font-weight: 600; font-size: 17px; }
.mobile-sync { font-size: 18px; padding: 8px; margin-right: -8px; }

/* MAIN CONTENT */
.main-content { flex: 1; margin-left: var(--sidebar-width); padding: 32px; min-height: 100vh; min-height: 100dvh; }
.section { display: none; animation: fadeIn 0.3s ease; max-width: 1400px; margin: 0 auto; }
.section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* SECTION HEADER */
.section-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 28px; gap: 16px; flex-wrap: wrap; }
.section-header h1 { font-size: clamp(24px, 5vw, 32px); font-weight: 700; letter-spacing: -0.5px; }
.today-date { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
.section-subheader { display: flex; justify-content: space-between; align-items: center; margin: 32px 0 20px; gap: 12px; flex-wrap: wrap; }
.section-subheader h2 { font-size: 18px; font-weight: 600; color: var(--text-secondary); }

/* PERIOD SELECTOR */
.period-selector { display: flex; gap: 8px; flex-wrap: wrap; }
.period-selector select { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px 14px; color: var(--text-primary); font-size: 14px; cursor: pointer; min-width: 100px; }
.period-selector select:focus { outline: none; border-color: var(--accent); }

/* STATS GRID */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
.stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 3vw, 24px); transition: all 0.2s; }
.stat-card:hover { border-color: var(--border-light); }
.stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600; }
.stat-value { font-family: var(--font-mono); font-size: clamp(20px, 4vw, 28px); font-weight: 700; margin-bottom: 4px; line-height: 1.2; }
.stat-value.hidden-amount { filter: blur(8px); user-select: none; }
.stat-detail { font-size: 12px; color: var(--text-muted); }
.stat-revenus .stat-value { color: var(--green); }
.stat-depenses .stat-value { color: var(--red); }
.stat-net.positive .stat-value { color: var(--green); }
.stat-net.negative .stat-value { color: var(--red); }
.stat-abonnements .stat-value { color: var(--orange); }

/* CHARTS */
.charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 28px; }
.chart-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 3vw, 24px); }
.chart-card h3 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; }
.chart-container { height: clamp(160px, 25vw, 200px); position: relative; }
.chart-legend { display: flex; flex-wrap: wrap; gap: 8px 16px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* BOTTOM GRID */
.bottom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 3vw, 24px); }
.card h3 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; }
.summary-list { display: flex; flex-direction: column; gap: 12px; }
.summary-item { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
.summary-label { font-size: 13px; color: var(--text-secondary); }
.summary-value { font-family: var(--font-mono); font-size: 13px; font-weight: 600; text-align: right; }
.upcoming-list { display: flex; flex-direction: column; gap: 10px; }
.upcoming-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md); gap: 12px; }
.upcoming-info { flex: 1; min-width: 0; }
.upcoming-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.upcoming-date { font-size: 12px; color: var(--text-muted); }
.upcoming-amount { font-family: var(--font-mono); font-size: 14px; color: var(--orange); font-weight: 600; flex-shrink: 0; }
.savings-summary { display: flex; flex-direction: column; gap: 12px; }
.savings-total { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.savings-label { font-size: 13px; color: var(--text-secondary); }
.savings-value { font-family: var(--font-mono); font-size: 18px; font-weight: 700; color: var(--blue); }
.savings-accounts { display: flex; flex-direction: column; gap: 8px; }
.savings-account-mini { display: flex; justify-content: space-between; font-size: 13px; }
.savings-account-mini span:last-child { font-family: var(--font-mono); color: var(--text-secondary); }

/* BUTTONS */
.btn-primary { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:active { transform: scale(0.98); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn-secondary:hover { background: var(--bg-hover); border-color: var(--border-light); }
.btn-secondary:active { transform: scale(0.98); }
.btn-danger { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-danger:hover { background: var(--red); color: white; }
.btn-icon { background: var(--bg-tertiary); border: none; width: 36px; height: 36px; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }
.btn-icon.delete:hover { background: var(--red-dim); color: var(--red); }

/* FILTERS */
.filters { display: flex; gap: 12px; margin-bottom: 20px; }
.filters input, .filters select { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px 16px; color: var(--text-primary); font-size: 14px; }
.filters input { flex: 1; min-width: 0; }
.filters input::placeholder { color: var(--text-muted); }
.filters input:focus, .filters select:focus { outline: none; border-color: var(--accent); }

/* LIST ITEMS */
.list-container { display: flex; flex-direction: column; gap: 8px; }
.list-item { display: flex; align-items: center; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; gap: 12px; transition: all 0.2s; }
.list-item:hover { border-color: var(--border-light); }
.list-item-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.list-item-icon.green { background: var(--green-dim); }
.list-item-icon.red { background: var(--red-dim); }
.list-item-icon.orange { background: var(--orange-dim); }
.list-item-icon.blue { background: var(--blue-dim); }
.list-item-icon.purple { background: var(--purple-dim); }
.list-item-info { flex: 1; min-width: 0; }
.list-item-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-item-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.list-item-amount { font-family: var(--font-mono); font-size: 15px; font-weight: 600; flex-shrink: 0; }
.list-item-amount.green { color: var(--green); }
.list-item-amount.red { color: var(--red); }
.list-item-amount.orange { color: var(--orange); }
.list-item-amount.blue { color: var(--blue); }
.list-item-actions { display: flex; gap: 6px; flex-shrink: 0; }
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; }

/* ABONNEMENTS */
.abonnements-summary { display: flex; gap: 24px; margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); flex-wrap: wrap; }
.abo-stat { display: flex; align-items: baseline; gap: 6px; }
.abo-stat-value { font-family: var(--font-mono); font-size: clamp(24px, 5vw, 32px); font-weight: 700; color: var(--orange); }
.abo-stat-label { font-size: 14px; color: var(--text-muted); }

/* EPARGNE */
.epargne-total { display: flex; justify-content: space-between; align-items: center; padding: 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
.epargne-total-label { font-size: 16px; color: var(--text-secondary); font-weight: 500; }
.epargne-total-value { font-family: var(--font-mono); font-size: clamp(28px, 6vw, 40px); font-weight: 700; color: var(--blue); }
.epargne-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 28px; }
.epargne-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; }
.epargne-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px; }
.epargne-card-name { font-size: 15px; font-weight: 600; }
.epargne-card-type { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: var(--radius-sm); }
.epargne-card-amount { font-family: var(--font-mono); font-size: clamp(22px, 5vw, 28px); font-weight: 700; color: var(--blue); margin-bottom: 12px; }
.epargne-card-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
.epargne-card-goal { font-size: 12px; color: var(--text-muted); }
.epargne-card-actions { display: flex; gap: 6px; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 16px; }
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); width: 100%; max-width: 480px; max-height: calc(100vh - 32px); max-height: calc(100dvh - 32px); overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95) translateY(20px); transition: transform 0.3s; }
.modal-overlay.active .modal { transform: scale(1) translateY(0); }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.modal-header h2 { font-size: 18px; font-weight: 600; }
.modal-close { background: none; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 4px; line-height: 1; }
.modal-close:hover { color: var(--text-primary); }
.modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; flex: 1; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.form-group input, .form-group select { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 16px; color: var(--text-primary); font-size: 16px !important; width: 100%; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 20px; border-top: 1px solid var(--border); flex-shrink: 0; }
.modal-footer button { flex: 1; }

/* SETTINGS */
.settings-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 4vw, 24px); margin-bottom: 16px; }
.settings-card h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.settings-card.danger { border-color: var(--red-dim); }
.settings-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border); gap: 16px; }
.settings-row:last-child { border-bottom: none; }
.settings-row > div:first-child { flex: 1; min-width: 0; }
.settings-row label { font-size: 14px; font-weight: 500; display: block; }
.settings-row select, .settings-row input[type="number"] { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px 14px; color: var(--text-primary); font-size: 14px; min-width: 140px; }
.settings-row select:focus, .settings-row input:focus { outline: none; border-color: var(--accent); }
.settings-hint { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.settings-actions { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
.settings-about { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
.account-box { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; }
.account-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; border-bottom: 1px solid var(--border); }
.account-row:last-child { border-bottom: none; }
.account-label { color: var(--text-secondary); }
.account-value { font-family: var(--font-mono); font-weight: 500; }
.toggle-switch { position: relative; width: 52px; height: 30px; flex-shrink: 0; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--bg-tertiary); border: 1px solid var(--border); transition: 0.3s; border-radius: 30px; }
.toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background: var(--text-secondary); transition: 0.3s; border-radius: 50%; }
.toggle-switch input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
.toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); background: white; }
.tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
.tag { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 20px; font-size: 13px; }
.tag-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 0; line-height: 1; margin-left: 2px; }
.tag-remove:hover { color: var(--red); }
.add-tag-row { display: flex; gap: 8px; }
.add-tag-row input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px 12px; color: var(--text-primary); font-size: 14px; min-width: 0; }
.add-tag-row button { padding: 10px 16px; white-space: nowrap; }

/* TOAST */
.toast { position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 24px; font-size: 14px; font-weight: 500; z-index: 2000; opacity: 0; transition: all 0.3s; white-space: nowrap; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

/* RESPONSIVE */
@media (max-width: 1200px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .bottom-grid { grid-template-columns: repeat(2, 1fr); }
    .bottom-grid .card:last-child { grid-column: span 2; }
}
@media (max-width: 1024px) {
    .charts-grid { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); width: 280px; }
    .sidebar.open { transform: translateX(0); }
    .mobile-header { display: flex; height: calc(60px + var(--safe-top)); padding-top: var(--safe-top); }
    .main-content { margin-left: 0; padding: calc(76px + var(--safe-top)) 16px calc(24px + var(--safe-bottom)); }
    .section-header { flex-direction: column; align-items: stretch; }
    .section-header .btn-primary { width: 100%; }
    .period-selector { width: 100%; }
    .period-selector select { flex: 1; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .stat-card { padding: 14px; }
    .stat-label { font-size: 11px; margin-bottom: 4px; }
    .stat-value { font-size: 20px; }
    .stat-detail { font-size: 11px; }
    .charts-grid { gap: 12px; }
    .chart-card { padding: 16px; }
    .chart-container { height: 180px; }
    .bottom-grid { grid-template-columns: 1fr; gap: 12px; }
    .bottom-grid .card:last-child { grid-column: span 1; }
    .card { padding: 16px; }
    .filters { flex-direction: column; gap: 10px; }
    .filters select { width: 100%; }
    .list-item { padding: 14px; }
    .list-item-icon { width: 40px; height: 40px; font-size: 18px; }
    .list-item-title { font-size: 14px; }
    .list-item-amount { font-size: 14px; }
    .list-item-actions { gap: 4px; }
    .btn-icon { width: 34px; height: 34px; }
    .abonnements-summary { flex-direction: column; gap: 12px; padding: 16px; }
    .epargne-total { flex-direction: column; text-align: center; padding: 20px; }
    .epargne-grid { grid-template-columns: 1fr; }
    .epargne-card { padding: 16px; }
    .modal { max-height: calc(100vh - 20px); max-height: calc(100dvh - 20px); border-radius: var(--radius-lg) var(--radius-lg) 0 0; margin-top: auto; }
    .modal-body { padding: 16px; }
    .modal-footer { padding: 16px; padding-bottom: calc(16px + var(--safe-bottom)); }
    .form-row { grid-template-columns: 1fr; }
    .settings-card { padding: 16px; }
    .settings-row { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 0; }
    .settings-row select, .settings-row input[type="number"] { width: 100%; min-width: auto; }
    .settings-actions { flex-direction: column; }
    .settings-actions button { width: 100%; }
    .add-tag-row { flex-direction: column; }
    .add-tag-row button { width: 100%; }
}
@media (max-width: 380px) {
    .stats-grid { grid-template-columns: 1fr; }
}
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- AUTH -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-logo">
                <span class="logo-icon">‚óâ</span>
                <h1>Th√©.OS Finance</h1>
                <p>G√©rez vos finances simplement</p>
            </div>
            <div class="auth-tabs" id="authTabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Connexion</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Inscription</button>
            </div>
            
            <div class="auth-error" id="authError"></div>
            
            <!-- LOGIN -->
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Identifiant</label>
                    <input type="text" id="loginUser" placeholder="Votre identifiant" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">Se connecter</button>
                <div class="auth-info">
                    üí° <strong>Nouvel appareil ?</strong><br>
                    <button type="button" onclick="showAuthTab('link')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;margin-top:8px;padding:0">‚Üí Lier cet appareil √† mon compte</button>
                </div>
            </form>
            
            <!-- REGISTER -->
            <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Identifiant</label>
                    <input type="text" id="regUser" placeholder="Choisissez un identifiant" required minlength="3" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="regPwd" placeholder="Minimum 6 caract√®res" required minlength="6" autocomplete="new-password" oninput="checkStrength(this.value)">
                    <div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
                </div>
                <div class="form-group">
                    <label>Confirmer</label>
                    <input type="password" id="regPwdConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary" id="regBtn">Cr√©er mon compte</button>
            </form>
            
            <!-- LINK DEVICE -->
            <form class="auth-form" id="linkForm" onsubmit="handleLink(event)">
                <div class="auth-info" style="margin-bottom:16px">
                    üì± Sur votre appareil principal, allez dans <strong>R√©glages ‚Üí Lier un appareil</strong> pour obtenir le code.
                </div>
                <div class="form-group">
                    <label>Code de liaison</label>
                    <input type="text" id="linkCode" placeholder="Collez le code ici" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe du compte</label>
                    <input type="password" id="linkPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-primary" id="linkBtn">Lier cet appareil</button>
                <button type="button" class="btn-secondary" onclick="showAuthTab('login')" style="margin-top:8px;width:100%">‚Üê Retour</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        <nav class="sidebar" id="sidebar">
            <div class="logo"><span class="logo-icon">‚óâ</span><span class="logo-text">Th√©.OS Finance</span></div>
            <div class="user-info">
                <div class="user-name" id="displayUserName">Utilisateur</div>
                <div class="user-sync" id="syncStatus">‚ü≥ Synchronisation...</div>
            </div>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-section="dashboard"><span class="nav-icon">‚ó´</span> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="revenus"><span class="nav-icon">‚Üë</span> Revenus</a></li>
                <li><a href="#" class="nav-link" data-section="depenses"><span class="nav-icon">‚Üì</span> D√©penses</a></li>
                <li><a href="#" class="nav-link" data-section="abonnements"><span class="nav-icon">‚Üª</span> Abonnements</a></li>
                <li><a href="#" class="nav-link" data-section="epargne"><span class="nav-icon">‚óà</span> √âpargne</a></li>
                <li><a href="#" class="nav-link" data-section="settings"><span class="nav-icon">‚öô</span> R√©glages</a></li>
            </ul>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">‚èª D√©connexion</button>
            </div>
        </nav>
        
        <header class="mobile-header">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <span class="mobile-title">Th√©.OS Finance</span>
            <button class="menu-toggle mobile-sync" onclick="manualSync()">‚Üª</button>
        </header>
        
        <main class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="section-header">
                    <div><h1>Dashboard</h1><p class="today-date" id="todayDate"></p></div>
                    <div class="period-selector">
                        <select id="periodType" onchange="updateDashboard()"><option value="month">Mois</option><option value="year">Ann√©e</option><option value="all">Tout</option></select>
                        <select id="periodMonth" onchange="updateDashboard()"></select>
                        <select id="periodYear" onchange="updateDashboard()"></select>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card stat-revenus"><div class="stat-label">Revenus</div><div class="stat-value" id="statRev">0 ‚Ç¨</div><div class="stat-detail" id="statRevD">0 entr√©es</div></div>
                    <div class="stat-card stat-depenses"><div class="stat-label">D√©penses</div><div class="stat-value" id="statDep">0 ‚Ç¨</div><div class="stat-detail" id="statDepD">0 entr√©es</div></div>
                    <div class="stat-card stat-net"><div class="stat-label">Net</div><div class="stat-value" id="statNet">0 ‚Ç¨</div><div class="stat-detail" id="statNetD">‚Äî</div></div>
                    <div class="stat-card stat-abonnements"><div class="stat-label">Abonnements</div><div class="stat-value" id="statAbo">0 ‚Ç¨</div><div class="stat-detail" id="statAboD">0 actifs</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>D√©penses par cat√©gorie</h3><div class="chart-container"><canvas id="chartDep"></canvas></div><div id="legDep" class="chart-legend"></div></div>
                    <div class="chart-card"><h3>Revenus par cat√©gorie</h3><div class="chart-container"><canvas id="chartRev"></canvas></div><div id="legRev" class="chart-legend"></div></div>
                </div>
                <div class="bottom-grid">
                    <div class="card"><h3>R√©sum√©</h3><div class="summary-list"><div class="summary-item"><span class="summary-label">Top d√©pense</span><span class="summary-value" id="sumTopD">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top revenu</span><span class="summary-value" id="sumTopR">‚Äî</span></div><div class="summary-item"><span class="summary-label">Moyenne</span><span class="summary-value" id="sumAvg">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top cat√©gorie</span><span class="summary-value" id="sumCat">‚Äî</span></div></div></div>
                    <div class="card"><h3>Prochains paiements</h3><div class="upcoming-list" id="upList"><div class="empty-state">Aucun</div></div></div>
                    <div class="card"><h3>√âpargne</h3><div class="savings-summary"><div class="savings-total"><span class="savings-label">Total</span><span class="savings-value" id="savTot">0 ‚Ç¨</span></div><div class="savings-accounts" id="savList"></div></div></div>
                </div>
            </section>

            <!-- Revenus -->
            <section id="revenus" class="section">
                <div class="section-header"><h1>Revenus</h1><button class="btn-primary" onclick="openModal('revenu')">+ Ajouter</button></div>
                <div class="filters"><input type="text" id="fRev" placeholder="Rechercher..." oninput="filter('revenus')"><select id="fRevC" onchange="filter('revenus')"><option value="">Toutes</option></select></div>
                <div class="list-container" id="lRev"></div>
            </section>

            <!-- D√©penses -->
            <section id="depenses" class="section">
                <div class="section-header"><h1>D√©penses</h1><button class="btn-primary" onclick="openModal('depense')">+ Ajouter</button></div>
                <div class="filters"><input type="text" id="fDep" placeholder="Rechercher..." oninput="filter('depenses')"><select id="fDepC" onchange="filter('depenses')"><option value="">Toutes</option></select></div>
                <div class="list-container" id="lDep"></div>
            </section>

            <!-- Abonnements -->
            <section id="abonnements" class="section">
                <div class="section-header"><h1>Abonnements</h1><button class="btn-primary" onclick="openModal('abonnement')">+ Ajouter</button></div>
                <div class="abonnements-summary"><div class="abo-stat"><span class="abo-stat-value" id="aboM">0 ‚Ç¨</span><span class="abo-stat-label">/ mois</span></div><div class="abo-stat"><span class="abo-stat-value" id="aboY">0 ‚Ç¨</span><span class="abo-stat-label">/ an</span></div></div>
                <div class="list-container" id="lAbo"></div>
            </section>

            <!-- √âpargne -->
            <section id="epargne" class="section">
                <div class="section-header"><h1>√âpargne</h1><button class="btn-primary" onclick="openModal('epargne')">+ Compte</button></div>
                <div class="epargne-total"><span class="epargne-total-label">Total √©pargn√©</span><span class="epargne-total-value" id="epTot">0 ‚Ç¨</span></div>
                <div class="epargne-grid" id="epGrid"></div>
                <div class="section-subheader"><h2>Mouvements</h2><button class="btn-secondary" onclick="openModal('mouvement')">+ Mouvement</button></div>
                <div class="list-container" id="lMvt"></div>
            </section>

            <!-- Settings -->
            <section id="settings" class="section">
                <div class="section-header"><h1>R√©glages</h1></div>
                
                <div class="settings-card">
                    <h3>üë§ Mon compte</h3>
                    <div class="account-box">
                        <div class="account-row"><span class="account-label">Identifiant</span><span class="account-value" id="accU">‚Äî</span></div>
                        <div class="account-row"><span class="account-label">Cr√©√© le</span><span class="account-value" id="accC">‚Äî</span></div>
                        <div class="account-row"><span class="account-label">Derni√®re sync</span><span class="account-value" id="accS">‚Äî</span></div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn-secondary" onclick="showLinkModal()">üì± Lier un appareil</button>
                        <button class="btn-secondary" onclick="manualSync()">‚Üª Synchroniser</button>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>üîê S√©curit√©</h3>
                    <div class="settings-row"><div><label>Changer mot de passe</label></div><button class="btn-secondary" onclick="openPwdModal()">Modifier</button></div>
                    <div class="settings-row"><div><label>Masquer montants</label></div><label class="toggle-switch"><input type="checkbox" id="sHide" onchange="tog('hideAmounts',this.checked)"><span class="toggle-slider"></span></label></div>
                </div>

                <div class="settings-card">
                    <h3>üé® Apparence</h3>
                    <div class="settings-row"><div><label>Th√®me</label></div><select id="sTheme" onchange="setTheme(this.value)"><option value="dark">üåô Sombre</option><option value="light">‚òÄÔ∏è Clair</option></select></div>
                    <div class="settings-row"><div><label>Couleur</label></div><select id="sAccent" onchange="setAccent(this.value)"><option value="#ff3b30">üî¥ Rouge</option><option value="#ff9500">üü† Orange</option><option value="#34c759">üü¢ Vert</option><option value="#007aff">üîµ Bleu</option><option value="#af52de">üü£ Violet</option></select></div>
                </div>

                <div class="settings-card">
                    <h3>üí∞ Format</h3>
                    <div class="settings-row"><div><label>Devise</label></div><select id="sCur" onchange="sav('currency',this.value);refresh()"><option value="EUR">‚Ç¨ Euro</option><option value="USD">$ Dollar</option><option value="GBP">¬£ Livre</option></select></div>
                    <div class="settings-row"><div><label>Centimes</label></div><label class="toggle-switch"><input type="checkbox" id="sCents" checked onchange="tog('showCents',this.checked);refresh()"><span class="toggle-slider"></span></label></div>
                </div>

                <div class="settings-card">
                    <h3>üè∑Ô∏è Cat√©gories</h3>
                    <div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Revenus</label><div class="tags-container" id="tRev"></div><div class="add-tag-row"><input type="text" id="nRev" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('revenus')">+</button></div></div>
                    <div class="settings-row" style="flex-direction:column;align-items:stretch"><label>D√©penses</label><div class="tags-container" id="tDep"></div><div class="add-tag-row"><input type="text" id="nDep" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('depenses')">+</button></div></div>
                    <div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Abonnements</label><div class="tags-container" id="tAbo"></div><div class="add-tag-row"><input type="text" id="nAbo" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('abonnements')">+</button></div></div>
                </div>

                <div class="settings-card">
                    <h3>üíæ Donn√©es</h3>
                    <div class="settings-row"><div><label>Export JSON</label></div><button class="btn-secondary" onclick="expJSON()">T√©l√©charger</button></div>
                    <div class="settings-row"><div><label>Export Excel</label></div><button class="btn-secondary" onclick="expXLS()">T√©l√©charger</button></div>
                    <div class="settings-row"><div><label>Importer</label></div><button class="btn-secondary" onclick="document.getElementById('impF').click()">Importer</button><input type="file" id="impF" accept=".json" style="display:none" onchange="impJSON(event)"></div>
                </div>

                <div class="settings-card danger">
                    <h3>‚ö†Ô∏è Danger</h3>
                    <div class="settings-row"><div><label>Effacer donn√©es</label></div><button class="btn-danger" onclick="clearData()">Effacer</button></div>
                    <div class="settings-row"><div><label>Supprimer compte</label></div><button class="btn-danger" onclick="delAccount()">Supprimer</button></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalO" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header"><h2 id="modalT">Ajouter</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form id="modalF" onsubmit="submitForm(event)">
                <div class="modal-body" id="modalB"></div>
                <div class="modal-footer" id="modalFoot"><button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button><button type="submit" class="btn-primary">OK</button></div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
// === GLOBALS ===
let data = { revenus:[], depenses:[], abonnements:[], epargne:[], mouvements:[], categories:{ revenus:['Salaire','Freelance','YouTube','Autre'], depenses:['Alimentation','Transport','Logement','Loisirs','Shopping','Tech','Sant√©','Autre'], abonnements:['Streaming','Cloud','Software','T√©l√©com','Autre'], epargne:['Livret A','PEA','Crypto','Autre'] }};
let settings = { currency:'EUR', accent:'#ff3b30', theme:'dark', hideAmounts:false, showCents:true };
let user = { username:'', pwdHash:'', code:'', created:'', lastSync:'' };
let charts = {};
const colors = ['#ff3b30','#ff9500','#ffcc00','#34c759','#007aff','#5856d6','#af52de','#ff2d55'];
const API = 'https://jsonblob.com/api/jsonBlob';

// === UTILS ===
async function sha256(s) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2,5); }
function fmt(n) {
    const opt = { style:'currency', currency:settings.currency||'EUR' };
    if (!settings.showCents) { opt.minimumFractionDigits=0; opt.maximumFractionDigits=0; }
    return new Intl.NumberFormat('fr-FR',opt).format(n);
}
function fmtD(d) { return new Date(d).toLocaleDateString('fr-FR'); }
function toast(msg, type='success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show ' + type;
    setTimeout(() => t.classList.remove('show'), 3000);
}
function showErr(msg) {
    const e = document.getElementById('authError');
    e.textContent = msg;
    e.classList.add('show');
    setTimeout(() => e.classList.remove('show'), 5000);
}

// === AUTH ===
function showAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    document.getElementById('authError').classList.remove('show');
    
    if (tab === 'login') {
        document.querySelector('.auth-tab:first-child').classList.add('active');
        document.getElementById('loginForm').classList.add('active');
        document.getElementById('authTabs').style.display = 'flex';
    } else if (tab === 'register') {
        document.querySelector('.auth-tab:last-child').classList.add('active');
        document.getElementById('registerForm').classList.add('active');
        document.getElementById('authTabs').style.display = 'flex';
    } else if (tab === 'link') {
        document.getElementById('linkForm').classList.add('active');
        document.getElementById('authTabs').style.display = 'none';
    }
}

function checkStrength(p) {
    const b = document.getElementById('strengthBar');
    if (p.length < 6) b.className = 'password-strength-bar strength-weak';
    else if (p.length < 10) b.className = 'password-strength-bar strength-medium';
    else b.className = 'password-strength-bar strength-strong';
}

async function handleRegister(e) {
    e.preventDefault();
    const btn = document.getElementById('regBtn');
    const username = document.getElementById('regUser').value.trim().toLowerCase();
    const pwd = document.getElementById('regPwd').value;
    const confirm = document.getElementById('regPwdConfirm').value;
    
    if (username.length < 3) { showErr('Identifiant trop court (min 3)'); return; }
    if (pwd.length < 6) { showErr('Mot de passe trop court (min 6)'); return; }
    if (pwd !== confirm) { showErr('Les mots de passe ne correspondent pas'); return; }
    
    btn.disabled = true;
    btn.textContent = 'Cr√©ation...';
    
    try {
        const pwdHash = await sha256(pwd);
        const now = new Date().toISOString();
        const payload = {
            user: { username, pwdHash, created: now, lastSync: now },
            data: data,
            settings: settings
        };
        
        console.log('Creating account...');
        const res = await fetch(API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        console.log('Response status:', res.status);
        
        if (!res.ok) {
            throw new Error('Erreur serveur: ' + res.status);
        }
        
        // Get the blob ID from the response URL or header
        const location = res.headers.get('Location') || res.headers.get('X-Jsonblob') || res.url;
        console.log('Location:', location);
        
        let code;
        if (location && location.includes('/')) {
            code = location.split('/').pop();
        } else {
            // Fallback: get from response body
            const body = await res.json();
            code = body.id || location;
        }
        
        if (!code || code.length < 10) {
            // Try to extract from URL
            const match = res.url.match(/jsonBlob\/([a-f0-9-]+)/i);
            if (match) code = match[1];
        }
        
        console.log('Code:', code);
        
        if (!code) {
            throw new Error('Impossible de r√©cup√©rer le code');
        }
        
        user = { username, pwdHash, code, created: now, lastSync: now };
        
        // Save to localStorage
        localStorage.setItem('theos_auth', JSON.stringify({ code, pwdHash, username }));
        
        toast('Compte cr√©√© avec succ√®s !', 'success');
        enterApp();
        
    } catch (err) {
        console.error('Register error:', err);
        showErr('Erreur: ' + err.message);
    }
    
    btn.disabled = false;
    btn.textContent = 'Cr√©er mon compte';
}

async function handleLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const username = document.getElementById('loginUser').value.trim().toLowerCase();
    const pwd = document.getElementById('loginPwd').value;
    
    btn.disabled = true;
    btn.textContent = 'Connexion...';
    
    try {
        const pwdHash = await sha256(pwd);
        const stored = localStorage.getItem('theos_auth');
        
        if (!stored) {
            showErr('Aucun compte sur cet appareil. Utilisez "Lier un appareil" pour vous connecter.');
            btn.disabled = false;
            btn.textContent = 'Se connecter';
            return;
        }
        
        const auth = JSON.parse(stored);
        
        if (auth.username !== username) {
            showErr('Identifiant incorrect');
            btn.disabled = false;
            btn.textContent = 'Se connecter';
            return;
        }
        
        if (auth.pwdHash !== pwdHash) {
            showErr('Mot de passe incorrect');
            btn.disabled = false;
            btn.textContent = 'Se connecter';
            return;
        }
        
        // Fetch data from cloud
        console.log('Fetching from cloud...');
        const res = await fetch(API + '/' + auth.code);
        
        if (!res.ok) {
            showErr('Erreur de synchronisation');
            btn.disabled = false;
            btn.textContent = 'Se connecter';
            return;
        }
        
        const cloud = await res.json();
        user = { ...cloud.user, code: auth.code };
        data = cloud.data || data;
        settings = { ...settings, ...cloud.settings };
        
        toast('Connect√© !', 'success');
        enterApp();
        
    } catch (err) {
        console.error('Login error:', err);
        showErr('Erreur de connexion');
    }
    
    btn.disabled = false;
    btn.textContent = 'Se connecter';
}

async function handleLink(e) {
    e.preventDefault();
    const btn = document.getElementById('linkBtn');
    const code = document.getElementById('linkCode').value.trim();
    const pwd = document.getElementById('linkPwd').value;
    
    if (!code) { showErr('Entrez le code'); return; }
    
    btn.disabled = true;
    btn.textContent = 'Liaison...';
    
    try {
        const pwdHash = await sha256(pwd);
        
        console.log('Linking device with code:', code);
        const res = await fetch(API + '/' + code);
        
        if (!res.ok) {
            showErr('Code invalide ou expir√©');
            btn.disabled = false;
            btn.textContent = 'Lier cet appareil';
            return;
        }
        
        const cloud = await res.json();
        
        if (cloud.user.pwdHash !== pwdHash) {
            showErr('Mot de passe incorrect');
            btn.disabled = false;
            btn.textContent = 'Lier cet appareil';
            return;
        }
        
        user = { ...cloud.user, code };
        data = cloud.data || data;
        settings = { ...settings, ...cloud.settings };
        
        localStorage.setItem('theos_auth', JSON.stringify({ code, pwdHash, username: user.username }));
        
        toast('Appareil li√© !', 'success');
        enterApp();
        
    } catch (err) {
        console.error('Link error:', err);
        showErr('Erreur: ' + err.message);
    }
    
    btn.disabled = false;
    btn.textContent = 'Lier cet appareil';
}

async function checkSession() {
    const stored = localStorage.getItem('theos_auth');
    if (!stored) return false;
    
    try {
        const auth = JSON.parse(stored);
        const res = await fetch(API + '/' + auth.code);
        if (!res.ok) return false;
        
        const cloud = await res.json();
        if (cloud.user.pwdHash !== auth.pwdHash) return false;
        
        user = { ...cloud.user, code: auth.code };
        data = cloud.data || data;
        settings = { ...settings, ...cloud.settings };
        return true;
    } catch {
        return false;
    }
}

function enterApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('app').classList.add('active');
    initApp();
}

function logout() {
    if (confirm('D√©connexion ?')) {
        localStorage.removeItem('theos_auth');
        location.reload();
    }
}

// === SYNC ===
let syncTimer;
function queueSync() {
    clearTimeout(syncTimer);
    syncTimer = setTimeout(doSync, 2000);
}

async function doSync() {
    if (!user.code) return;
    setSyncUI('syncing');
    try {
        user.lastSync = new Date().toISOString();
        await fetch(API + '/' + user.code, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user, data, settings })
        });
        setSyncUI('synced');
    } catch (err) {
        console.error('Sync error:', err);
        setSyncUI('error');
    }
}

function manualSync() {
    doSync();
    toast('Synchronisation...', 'success');
}

function setSyncUI(s) {
    const el = document.getElementById('syncStatus');
    const map = { syncing: '‚ü≥ Sync...', synced: '‚úì Synchronis√©', error: '‚úó Erreur' };
    el.textContent = map[s] || '';
    el.className = 'user-sync' + (s === 'synced' ? ' synced' : '');
}

// === APP INIT ===
document.addEventListener('DOMContentLoaded', async () => {
    if (await checkSession()) {
        enterApp();
    }
});

function initApp() {
    applyTheme();
    initNav();
    initPeriod();
    refresh();
    renderSettings();
    updateDate();
    document.getElementById('displayUserName').textContent = user.username || 'User';
    setSyncUI('synced');
}

function refresh() {
    renderAll();
    updateDashboard();
}

// === THEME ===
function applyTheme() {
    document.documentElement.style.setProperty('--accent', settings.accent);
    document.documentElement.setAttribute('data-theme', settings.theme || 'dark');
}
function setTheme(t) { settings.theme = t; applyTheme(); queueSync(); }
function setAccent(c) { settings.accent = c; applyTheme(); queueSync(); }

// === SETTINGS ===
function renderSettings() {
    document.getElementById('sTheme').value = settings.theme || 'dark';
    document.getElementById('sAccent').value = settings.accent || '#ff3b30';
    document.getElementById('sCur').value = settings.currency || 'EUR';
    document.getElementById('sHide').checked = settings.hideAmounts || false;
    document.getElementById('sCents').checked = settings.showCents !== false;
    document.getElementById('accU').textContent = user.username || '‚Äî';
    document.getElementById('accC').textContent = user.created ? fmtD(user.created) : '‚Äî';
    document.getElementById('accS').textContent = user.lastSync ? new Date(user.lastSync).toLocaleString('fr-FR') : '‚Äî';
    renderTags();
}

function sav(k,v) { settings[k]=v; queueSync(); }
function tog(k,v) { settings[k]=v; applyTheme(); queueSync(); refresh(); }

function showLinkModal() {
    document.getElementById('modalT').textContent = 'Lier un appareil';
    document.getElementById('modalB').innerHTML = `
        <p style="color:var(--text-secondary);margin-bottom:16px">Sur votre nouvel appareil, cliquez sur "Lier cet appareil" et entrez ce code :</p>
        <div class="link-code-box">
            <div class="link-code">${user.code}</div>
            <p class="link-code-hint">Code unique de votre compte</p>
        </div>
        <button type="button" class="btn-secondary" onclick="navigator.clipboard.writeText('${user.code}');toast('Copi√© !','success')" style="width:100%">üìã Copier</button>
    `;
    document.getElementById('modalFoot').style.display = 'none';
    document.getElementById('modalO').classList.add('active');
}

function openPwdModal() {
    document.getElementById('modalT').textContent = 'Changer mot de passe';
    document.getElementById('modalB').innerHTML = `
        <div class="form-group"><label>Actuel</label><input type="password" id="pwdOld" required></div>
        <div class="form-group"><label>Nouveau</label><input type="password" id="pwdNew" required minlength="6"></div>
        <div class="form-group"><label>Confirmer</label><input type="password" id="pwdConf" required></div>
    `;
    document.getElementById('modalFoot').style.display = 'flex';
    document.getElementById('modalF').onsubmit = changePwd;
    document.getElementById('modalO').classList.add('active');
}

async function changePwd(e) {
    e.preventDefault();
    const old = await sha256(document.getElementById('pwdOld').value);
    if (old !== user.pwdHash) { toast('Mot de passe incorrect','error'); return; }
    const n = document.getElementById('pwdNew').value;
    const c = document.getElementById('pwdConf').value;
    if (n !== c) { toast('Ne correspondent pas','error'); return; }
    if (n.length < 6) { toast('Trop court','error'); return; }
    
    user.pwdHash = await sha256(n);
    const auth = JSON.parse(localStorage.getItem('theos_auth'));
    auth.pwdHash = user.pwdHash;
    localStorage.setItem('theos_auth', JSON.stringify(auth));
    await doSync();
    closeModal();
    toast('Mot de passe chang√© !','success');
}

function clearData() {
    if (confirm('Effacer toutes les donn√©es ?')) {
        data = { revenus:[], depenses:[], abonnements:[], epargne:[], mouvements:[], categories:data.categories };
        queueSync(); refresh();
        toast('Donn√©es effac√©es','success');
    }
}

async function delAccount() {
    if (confirm('SUPPRIMER le compte ?') && prompt('Tapez SUPPRIMER') === 'SUPPRIMER') {
        try {
            await fetch(API + '/' + user.code, { method: 'DELETE' });
            localStorage.removeItem('theos_auth');
            toast('Compte supprim√©','success');
            setTimeout(() => location.reload(), 1000);
        } catch { toast('Erreur','error'); }
    }
}

// === TAGS ===
function renderTags() {
    ['revenus','depenses','abonnements'].forEach(t => {
        const m = { revenus:'Rev', depenses:'Dep', abonnements:'Abo' };
        const c = document.getElementById('t'+m[t]);
        if (c && data.categories[t]) {
            c.innerHTML = data.categories[t].map(x => `<span class="tag">${x}<button class="tag-remove" onclick="remCat('${t}','${x}')">√ó</button></span>`).join('');
        }
    });
}
function addCat(t) {
    const m = { revenus:'Rev', depenses:'Dep', abonnements:'Abo' };
    const i = document.getElementById('n'+m[t]);
    const v = i.value.trim();
    if (v && !data.categories[t].includes(v)) {
        data.categories[t].push(v);
        queueSync(); renderTags(); updateFilters(); i.value = '';
    }
}
function remCat(t,c) {
    if (data.categories[t].length > 1 && confirm(`Supprimer "${c}" ?`)) {
        data.categories[t] = data.categories[t].filter(x => x !== c);
        queueSync(); renderTags(); updateFilters();
    }
}

// === NAV ===
function initNav() {
    document.querySelectorAll('.nav-link').forEach(l => {
        l.addEventListener('click', e => { e.preventDefault(); goTo(l.dataset.section); });
    });
}
function goTo(s) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.section === s));
    document.querySelectorAll('.section').forEach(x => x.classList.toggle('active', x.id === s));
    closeSidebar();
    if (s === 'dashboard') updateDashboard();
    if (s === 'settings') renderSettings();
}
function toggleSidebar() {
    document.getElementById('sidebar').classList.add('open');
    document.getElementById('sidebarOverlay').classList.add('active');
}
function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('active');
}

// === PERIOD ===
function initPeriod() {
    const m = document.getElementById('periodMonth');
    ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c'].forEach((n,i) => {
        m.innerHTML += `<option value="${i}">${n}</option>`;
    });
    m.value = new Date().getMonth();
    const y = document.getElementById('periodYear');
    for (let i = 2024; i <= 2030; i++) y.innerHTML += `<option value="${i}">${i}</option>`;
    y.value = new Date().getFullYear();
}
function getPeriod() {
    return {
        type: document.getElementById('periodType').value,
        month: +document.getElementById('periodMonth').value,
        year: +document.getElementById('periodYear').value
    };
}
function updateDate() {
    const d = new Date();
    document.getElementById('todayDate').textContent = d.toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
}

// === DASHBOARD ===
function updateDashboard() {
    const t = document.getElementById('periodType').value;
    document.getElementById('periodMonth').style.display = t === 'month' ? '' : 'none';
    document.getElementById('periodYear').style.display = t === 'all' ? 'none' : '';
    
    const p = getPeriod();
    const fR = filterP(data.revenus, p);
    const fD = filterP(data.depenses, p);
    const tR = fR.reduce((s,x) => s + x.montant, 0);
    const tD = fD.reduce((s,x) => s + x.montant, 0);
    const net = tR - tD;
    const tA = data.abonnements.reduce((s,x) => s + x.montant, 0);
    
    const hc = settings.hideAmounts ? ' hidden-amount' : '';
    document.getElementById('statRev').className = 'stat-value' + hc;
    document.getElementById('statDep').className = 'stat-value' + hc;
    document.getElementById('statNet').className = 'stat-value' + hc;
    document.getElementById('statAbo').className = 'stat-value' + hc;
    
    document.getElementById('statRev').textContent = fmt(tR);
    document.getElementById('statRevD').textContent = fR.length + ' entr√©es';
    document.getElementById('statDep').textContent = fmt(tD);
    document.getElementById('statDepD').textContent = fD.length + ' entr√©es';
    document.getElementById('statNet').textContent = fmt(net);
    document.querySelector('.stat-net').className = 'stat-card stat-net ' + (net >= 0 ? 'positive' : 'negative');
    document.getElementById('statNetD').textContent = tR > 0 ? Math.round(net/tR*100) + '%' : '‚Äî';
    document.getElementById('statAbo').textContent = fmt(tA);
    document.getElementById('statAboD').textContent = data.abonnements.length + ' actifs';
    
    updateCharts(fD, fR);
    updateSummary(fD, fR);
    updateUpcoming();
    updateSavDash();
}

function filterP(items, p) {
    if (p.type === 'all') return items;
    return items.filter(i => {
        const d = new Date(i.date);
        return p.type === 'year' ? d.getFullYear() === p.year : (d.getFullYear() === p.year && d.getMonth() === p.month);
    });
}

function updateCharts(fD, fR) {
    if (charts.dep) charts.dep.destroy();
    if (charts.rev) charts.rev.destroy();
    const gD = group(fD), gR = group(fR);
    charts.dep = makeChart('chartDep', gD);
    charts.rev = makeChart('chartRev', gR);
    renderLeg('legDep', gD);
    renderLeg('legRev', gR);
}

function group(items) {
    const g = {};
    items.forEach(i => { const c = i.categorie || 'Autre'; g[c] = (g[c]||0) + i.montant; });
    return g;
}

function makeChart(id, d) {
    const ctx = document.getElementById(id).getContext('2d');
    const l = Object.keys(d), v = Object.values(d);
    if (!v.length) return new Chart(ctx, { type:'doughnut', data:{ labels:['Vide'], datasets:[{ data:[1], backgroundColor:['#2a2a2a'], borderWidth:0 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } } });
    return new Chart(ctx, { type:'doughnut', data:{ labels:l, datasets:[{ data:v, backgroundColor:colors.slice(0,l.length), borderWidth:0, spacing:2 }] }, options:{ responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c => `${c.label}: ${fmt(c.raw)}` } } } } });
}

function renderLeg(id, d) {
    const c = document.getElementById(id), l = Object.keys(d);
    c.innerHTML = l.length ? l.map((x,i) => `<span class="legend-item"><span class="legend-dot" style="background:${colors[i%colors.length]}"></span>${x}</span>`).join('') : '<span class="legend-item">‚Äî</span>';
}

function updateSummary(fD, fR) {
    const topD = fD.length ? fD.reduce((m,x) => x.montant > m.montant ? x : m) : null;
    document.getElementById('sumTopD').textContent = topD ? topD.description.substr(0,12) : '‚Äî';
    const topR = fR.length ? fR.reduce((m,x) => x.montant > m.montant ? x : m) : null;
    document.getElementById('sumTopR').textContent = topR ? topR.description.substr(0,12) : '‚Äî';
    document.getElementById('sumAvg').textContent = fD.length ? fmt(fD.reduce((s,x) => s + x.montant, 0) / fD.length) : '‚Äî';
    const g = group(fD), tc = Object.entries(g).sort((a,b) => b[1] - a[1])[0];
    document.getElementById('sumCat').textContent = tc ? tc[0] : '‚Äî';
}

function updateUpcoming() {
    const c = document.getElementById('upList');
    if (!data.abonnements.length) { c.innerHTML = '<div class="empty-state">Aucun</div>'; return; }
    const now = new Date();
    const u = data.abonnements.map(a => {
        let nd = new Date(now.getFullYear(), now.getMonth(), a.jour||1);
        if (nd <= now) nd = new Date(now.getFullYear(), now.getMonth()+1, a.jour||1);
        return { ...a, nd };
    }).sort((a,b) => a.nd - b.nd).slice(0,4);
    c.innerHTML = u.map(a => `<div class="upcoming-item"><div class="upcoming-info"><span class="upcoming-name">${a.description}</span><span class="upcoming-date">${fmtD(a.nd)}</span></div><span class="upcoming-amount">${fmt(a.montant)}</span></div>`).join('');
}

function updateSavDash() {
    const t = data.epargne.reduce((s,x) => s + x.solde, 0);
    document.getElementById('savTot').textContent = fmt(t);
    const c = document.getElementById('savList');
    c.innerHTML = data.epargne.length ? data.epargne.slice(0,3).map(x => `<div class="savings-account-mini"><span>${x.nom}</span><span>${fmt(x.solde)}</span></div>`).join('') : '<div class="empty-state">Aucun</div>';
}

// === LISTS ===
function renderAll() { renderRev(); renderDep(); renderAbo(); renderEp(); renderMvt(); updateFilters(); }

function renderRev() {
    const c = document.getElementById('lRev');
    const items = [...data.revenus].sort((a,b) => new Date(b.date) - new Date(a.date));
    c.innerHTML = items.length ? items.map(i => `<div class="list-item"><div class="list-item-icon green">‚Üë</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">${fmtD(i.date)} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount green${settings.hideAmounts?' hidden-amount':''}">+${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('revenu','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('revenus','${i.id}')">√ó</button></div></div>`).join('') : '<div class="empty-state">Aucun revenu</div>';
}

function renderDep() {
    const c = document.getElementById('lDep');
    const items = [...data.depenses].sort((a,b) => new Date(b.date) - new Date(a.date));
    c.innerHTML = items.length ? items.map(i => `<div class="list-item"><div class="list-item-icon red">‚Üì</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">${fmtD(i.date)} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount red${settings.hideAmounts?' hidden-amount':''}">-${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('depense','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('depenses','${i.id}')">√ó</button></div></div>`).join('') : '<div class="empty-state">Aucune d√©pense</div>';
}

function renderAbo() {
    const c = document.getElementById('lAbo');
    const tm = data.abonnements.reduce((s,a) => s + a.montant, 0);
    document.getElementById('aboM').textContent = fmt(tm);
    document.getElementById('aboY').textContent = fmt(tm * 12);
    c.innerHTML = data.abonnements.length ? data.abonnements.map(i => `<div class="list-item"><div class="list-item-icon orange">‚Üª</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">Le ${i.jour||1} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount orange${settings.hideAmounts?' hidden-amount':''}">${fmt(i.montant)}/mois</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('abonnement','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('abonnements','${i.id}')">√ó</button></div></div>`).join('') : '<div class="empty-state">Aucun abonnement</div>';
}

function renderEp() {
    const c = document.getElementById('epGrid');
    const t = data.epargne.reduce((s,x) => s + x.solde, 0);
    document.getElementById('epTot').textContent = fmt(t);
    c.innerHTML = data.epargne.length ? data.epargne.map(x => `<div class="epargne-card"><div class="epargne-card-header"><span class="epargne-card-name">${x.nom}</span><span class="epargne-card-type">${x.type}</span></div><div class="epargne-card-amount${settings.hideAmounts?' hidden-amount':''}">${fmt(x.solde)}</div><div class="epargne-card-footer"><span class="epargne-card-goal">${x.objectif ? 'Obj: '+fmt(x.objectif) : '‚Äî'}</span><div class="epargne-card-actions"><button class="btn-icon" onclick="edit('epargne','${x.id}')">‚úé</button><button class="btn-icon delete" onclick="del('epargne','${x.id}')">√ó</button></div></div></div>`).join('') : '<div class="empty-state">Aucun compte</div>';
}

function renderMvt() {
    const c = document.getElementById('lMvt');
    const items = [...data.mouvements].sort((a,b) => new Date(b.date) - new Date(a.date));
    c.innerHTML = items.length ? items.map(i => {
        const cp = data.epargne.find(e => e.id === i.compteId);
        const dep = i.type === 'depot';
        return `<div class="list-item"><div class="list-item-icon ${dep?'blue':'purple'}">${dep?'‚Üë':'‚Üì'}</div><div class="list-item-info"><span class="list-item-title">${i.description||(dep?'D√©p√¥t':'Retrait')}</span><span class="list-item-subtitle">${fmtD(i.date)} ‚Ä¢ ${cp?cp.nom:'?'}</span></div><span class="list-item-amount ${dep?'blue':'purple'}${settings.hideAmounts?' hidden-amount':''}">${dep?'+':'-'}${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon delete" onclick="del('mouvements','${i.id}')">√ó</button></div></div>`;
    }).join('') : '<div class="empty-state">Aucun mouvement</div>';
}

function updateFilters() {
    document.getElementById('fRevC').innerHTML = '<option value="">Toutes</option>' + data.categories.revenus.map(c => `<option>${c}</option>`).join('');
    document.getElementById('fDepC').innerHTML = '<option value="">Toutes</option>' + data.categories.depenses.map(c => `<option>${c}</option>`).join('');
}

function filter(t) {
    const m = { revenus:['fRev','fRevC','lRev'], depenses:['fDep','fDepC','lDep'] };
    const [fId, catId, listId] = m[t];
    const s = document.getElementById(fId).value.toLowerCase();
    const cat = document.getElementById(catId).value;
    document.querySelectorAll(`#${listId} .list-item`).forEach(i => {
        const ti = i.querySelector('.list-item-title').textContent.toLowerCase();
        const su = i.querySelector('.list-item-subtitle').textContent;
        i.style.display = ti.includes(s) && (!cat || su.includes(cat)) ? 'flex' : 'none';
    });
}

// === MODAL ===
let editId = null, editType = null;

function openModal(type, id = null) {
    editType = type; editId = id;
    const title = document.getElementById('modalT');
    const body = document.getElementById('modalB');
    document.getElementById('modalFoot').style.display = 'flex';
    document.getElementById('modalF').onsubmit = submitForm;
    let html = '';
    
    if (type === 'revenu') {
        const r = id ? data.revenus.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier' : 'Ajouter revenu';
        html = `<div class="form-group"><label>Description</label><input name="description" required value="${r?.description||''}" placeholder="Ex: Salaire"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="${r?.montant||''}" placeholder="0"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${r?.date||new Date().toISOString().split('T')[0]}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${data.categories.revenus.map(c => `<option ${r?.categorie===c?'selected':''}>${c}</option>`).join('')}</select></div>`;
    } else if (type === 'depense') {
        const d = id ? data.depenses.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier' : 'Ajouter d√©pense';
        html = `<div class="form-group"><label>Description</label><input name="description" required value="${d?.description||''}" placeholder="Ex: Courses"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="${d?.montant||''}" placeholder="0"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${d?.date||new Date().toISOString().split('T')[0]}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${data.categories.depenses.map(c => `<option ${d?.categorie===c?'selected':''}>${c}</option>`).join('')}</select></div>`;
    } else if (type === 'abonnement') {
        const a = id ? data.abonnements.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier' : 'Ajouter abonnement';
        html = `<div class="form-group"><label>Description</label><input name="description" required value="${a?.description||''}" placeholder="Ex: Netflix"></div><div class="form-row"><div class="form-group"><label>Montant/mois</label><input type="number" name="montant" step="0.01" required value="${a?.montant||''}" placeholder="0"></div><div class="form-group"><label>Jour</label><input type="number" name="jour" min="1" max="31" value="${a?.jour||1}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${data.categories.abonnements.map(c => `<option ${a?.categorie===c?'selected':''}>${c}</option>`).join('')}</select></div>`;
    } else if (type === 'epargne') {
        const e = id ? data.epargne.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier' : 'Ajouter compte';
        html = `<div class="form-group"><label>Nom</label><input name="nom" required value="${e?.nom||''}" placeholder="Ex: Livret A"></div><div class="form-row"><div class="form-group"><label>Type</label><select name="type">${data.categories.epargne.map(c => `<option ${e?.type===c?'selected':''}>${c}</option>`).join('')}</select></div><div class="form-group"><label>Solde</label><input type="number" name="solde" step="0.01" required value="${e?.solde||''}" placeholder="0"></div></div><div class="form-group"><label>Objectif</label><input type="number" name="objectif" step="0.01" value="${e?.objectif||''}" placeholder="Optionnel"></div>`;
    } else if (type === 'mouvement') {
        title.textContent = 'Mouvement';
        html = `<div class="form-group"><label>Compte</label><select name="compteId">${data.epargne.map(c => `<option value="${c.id}">${c.nom}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label>Type</label><select name="type"><option value="depot">D√©p√¥t</option><option value="retrait">Retrait</option></select></div><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required placeholder="0"></div></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label>Description</label><input name="description" placeholder="Optionnel"></div>`;
    }
    
    body.innerHTML = html;
    document.getElementById('modalO').classList.add('active');
}

function closeModal() {
    document.getElementById('modalO').classList.remove('active');
    editId = null; editType = null;
}

function submitForm(e) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const entry = Object.fromEntries(fd.entries());
    if (entry.montant) entry.montant = parseFloat(entry.montant);
    if (entry.solde) entry.solde = parseFloat(entry.solde);
    if (entry.objectif) entry.objectif = entry.objectif ? parseFloat(entry.objectif) : null;
    if (entry.jour) entry.jour = parseInt(entry.jour);
    
    if (editType === 'revenu') {
        if (editId) { const i = data.revenus.findIndex(x => x.id === editId); data.revenus[i] = { ...data.revenus[i], ...entry }; }
        else { entry.id = genId(); data.revenus.push(entry); }
        renderRev();
    } else if (editType === 'depense') {
        if (editId) { const i = data.depenses.findIndex(x => x.id === editId); data.depenses[i] = { ...data.depenses[i], ...entry }; }
        else { entry.id = genId(); data.depenses.push(entry); }
        renderDep();
    } else if (editType === 'abonnement') {
        if (editId) { const i = data.abonnements.findIndex(x => x.id === editId); data.abonnements[i] = { ...data.abonnements[i], ...entry }; }
        else { entry.id = genId(); data.abonnements.push(entry); }
        renderAbo();
    } else if (editType === 'epargne') {
        if (editId) { const i = data.epargne.findIndex(x => x.id === editId); data.epargne[i] = { ...data.epargne[i], ...entry }; }
        else { entry.id = genId(); data.epargne.push(entry); }
        renderEp();
    } else if (editType === 'mouvement') {
        entry.id = genId();
        data.mouvements.push(entry);
        const cp = data.epargne.find(x => x.id === entry.compteId);
        if (cp) cp.solde += entry.type === 'depot' ? entry.montant : -entry.montant;
        renderMvt(); renderEp();
    }
    
    queueSync(); updateDashboard(); closeModal();
    toast('Enregistr√© !','success');
}

function edit(t, id) { openModal(t, id); }
function del(col, id) {
    if (confirm('Supprimer ?')) {
        data[col] = data[col].filter(x => x.id !== id);
        queueSync(); renderAll(); updateDashboard();
        toast('Supprim√©','success');
    }
}

// === EXPORT/IMPORT ===
function expJSON() {
    const b = new Blob([JSON.stringify({ data, settings }, null, 2)], { type:'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(b);
    a.download = `theos_${new Date().toISOString().split('T')[0]}.json`; a.click();
    toast('Export√©','success');
}

function expXLS() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.revenus.map(r => ({ Description:r.description, Montant:r.montant, Date:r.date, Cat√©gorie:r.categorie }))), 'Revenus');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.depenses.map(d => ({ Description:d.description, Montant:d.montant, Date:d.date, Cat√©gorie:d.categorie }))), 'D√©penses');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.abonnements.map(a => ({ Description:a.description, Montant:a.montant, Jour:a.jour, Cat√©gorie:a.categorie }))), 'Abonnements');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.epargne.map(e => ({ Nom:e.nom, Type:e.type, Solde:e.solde, Objectif:e.objectif||'' }))), '√âpargne');
    XLSX.writeFile(wb, `theos_${new Date().toISOString().split('T')[0]}.xlsx`);
    toast('Excel export√©','success');
}

function impJSON(e) {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
        try {
            const imp = JSON.parse(ev.target.result);
            if (confirm('Remplacer ?')) {
                if (imp.data) data = imp.data;
                if (imp.settings) settings = { ...settings, ...imp.settings };
                queueSync(); applyTheme(); refresh(); renderSettings();
                toast('Import√©','success');
            }
        } catch { toast('Erreur','error'); }
    };
    r.readAsText(f);
    e.target.value = '';
}
    </script>
</body>
</html>
