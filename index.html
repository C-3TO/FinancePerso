<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Th√©.OS Finance</title>
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='none' stroke='%23ff3b30' stroke-width='8'/><circle cx='50' cy='50' r='12' fill='%23ff3b30'/></svg>">
    <style>
:root{--bg-primary:#0a0a0a;--bg-secondary:#111;--bg-tertiary:#1a1a1a;--bg-hover:#222;--border:#2a2a2a;--border-light:#333;--text-primary:#fff;--text-secondary:#888;--text-muted:#555;--accent:#ff3b30;--accent-hover:#ff5147;--green:#34c759;--green-dim:rgba(52,199,89,.15);--red:#ff3b30;--red-dim:rgba(255,59,48,.15);--blue:#007aff;--blue-dim:rgba(0,122,255,.15);--orange:#ff9500;--orange-dim:rgba(255,149,0,.15);--purple:#af52de;--purple-dim:rgba(175,82,222,.15);--radius-sm:6px;--radius-md:10px;--radius-lg:16px;--sidebar-width:260px;--font-mono:'SF Mono','Fira Code',monospace;--font-sans:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;--safe-bottom:env(safe-area-inset-bottom,0px);--safe-top:env(safe-area-inset-top,0px)}[data-theme=light]{--bg-primary:#f5f5f7;--bg-secondary:#fff;--bg-tertiary:#e8e8ed;--bg-hover:#d1d1d6;--border:#d1d1d6;--border-light:#c7c7cc;--text-primary:#1d1d1f;--text-secondary:#6e6e73;--text-muted:#aeaeb2}*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{font-family:var(--font-sans);background:var(--bg-primary);color:var(--text-primary);line-height:1.5;min-height:100vh;min-height:100dvh}button,input,select{font-family:inherit;font-size:16px!important}.auth-screen{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}.auth-container{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(24px,6vw,40px);width:100%;max-width:420px}.auth-logo{text-align:center;margin-bottom:28px}.auth-logo .logo-icon{font-size:48px;color:var(--accent)}.auth-logo h1{font-size:24px;margin-top:12px}.auth-logo p{color:var(--text-secondary);font-size:14px;margin-top:4px}.auth-tabs{display:flex;margin-bottom:24px;border-bottom:1px solid var(--border)}.auth-tab{flex:1;padding:12px;background:0 0;border:none;color:var(--text-secondary);font-weight:500;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}.auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}.auth-form{display:none;flex-direction:column;gap:16px}.auth-form.active{display:flex}.form-group{display:flex;flex-direction:column;gap:6px}.form-group label{font-size:13px;color:var(--text-secondary);font-weight:500}.form-group input,.form-group select{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px 16px;color:var(--text-primary);width:100%}.form-group input:focus,.form-group select:focus{outline:0;border-color:var(--accent)}.auth-error{background:var(--red-dim);border:1px solid var(--red);color:var(--red);padding:12px;border-radius:var(--radius-md);font-size:13px;display:none}.auth-error.show{display:block;margin-bottom:12px}.auth-loading{display:none;flex-direction:column;align-items:center;gap:12px;padding:40px;color:var(--text-secondary)}.auth-loading.show{display:flex}.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.btn-primary{background:var(--accent);color:#fff;border:none;padding:14px 20px;border-radius:var(--radius-md);font-weight:600;cursor:pointer}.btn-primary:hover{background:var(--accent-hover)}.btn-primary:disabled{opacity:.5}.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);padding:12px 20px;border-radius:var(--radius-md);font-weight:500;cursor:pointer}.btn-secondary:hover{background:var(--bg-hover)}.btn-danger{background:var(--red-dim);color:var(--red);border:1px solid var(--red);padding:12px 20px;border-radius:var(--radius-md);cursor:pointer}.btn-danger:hover{background:var(--red);color:#fff}.btn-icon{background:var(--bg-tertiary);border:none;width:36px;height:36px;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center}.btn-icon:hover{background:var(--bg-hover);color:var(--text-primary)}.btn-icon.delete:hover{background:var(--red-dim);color:var(--red)}.app{display:none;min-height:100vh}.app.active{display:flex}.sidebar{width:var(--sidebar-width);background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;bottom:0;left:0;z-index:100}.sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99;opacity:0;visibility:hidden}.sidebar-overlay.active{opacity:1;visibility:visible}.logo{padding:20px 24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}.logo-icon{font-size:24px;color:var(--accent)}.logo-text{font-size:17px;font-weight:600}.user-info{padding:16px 24px;border-bottom:1px solid var(--border)}.user-name{font-size:14px;font-weight:600}.user-status{font-size:12px;color:var(--green);margin-top:2px}.user-status.syncing{color:var(--orange)}.user-status.error{color:var(--red)}.nav-links{list-style:none;padding:12px;flex:1;overflow-y:auto}.nav-link{display:flex;align-items:center;gap:12px;padding:14px 16px;color:var(--text-secondary);text-decoration:none;border-radius:var(--radius-md);margin-bottom:4px;font-size:14px;font-weight:500}.nav-link:hover{background:var(--bg-hover);color:var(--text-primary)}.nav-link.active{background:var(--bg-tertiary);color:var(--text-primary)}.nav-icon{font-size:18px;width:24px;text-align:center}.sidebar-footer{padding:16px;border-top:1px solid var(--border);padding-bottom:calc(16px + var(--safe-bottom))}.btn-logout{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;background:var(--red-dim);border:none;border-radius:var(--radius-md);color:var(--red);font-weight:500;cursor:pointer}.btn-logout:hover{background:var(--red);color:#fff}.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:60px;background:var(--bg-secondary);border-bottom:1px solid var(--border);align-items:center;padding:0 16px;z-index:90}.menu-toggle{background:0 0;border:none;color:var(--text-primary);font-size:24px;cursor:pointer}.mobile-title{flex:1;text-align:center;font-weight:600}.main-content{flex:1;margin-left:var(--sidebar-width);padding:32px;min-height:100vh}.section{display:none;animation:fadeIn .3s;max-width:1400px;margin:0 auto}.section.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}.section-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;gap:16px;flex-wrap:wrap}.section-header h1{font-size:clamp(24px,5vw,32px);font-weight:700}.today-date{font-size:14px;color:var(--text-secondary);margin-top:4px}.section-subheader{display:flex;justify-content:space-between;align-items:center;margin:32px 0 20px;gap:12px}.section-subheader h2{font-size:18px;color:var(--text-secondary)}.period-selector{display:flex;gap:8px;flex-wrap:wrap}.period-selector select{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 14px;color:var(--text-primary);min-width:100px}.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}.stat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,3vw,24px)}.stat-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;font-weight:600}.stat-value{font-family:var(--font-mono);font-size:clamp(20px,4vw,28px);font-weight:700;margin-bottom:4px}.stat-value.hidden-amount{filter:blur(8px);user-select:none}.stat-detail{font-size:12px;color:var(--text-muted)}.stat-revenus .stat-value{color:var(--green)}.stat-depenses .stat-value{color:var(--red)}.stat-net.positive .stat-value{color:var(--green)}.stat-net.negative .stat-value{color:var(--red)}.stat-abonnements .stat-value{color:var(--orange)}.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:28px}.chart-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,3vw,24px)}.chart-card h3{font-size:14px;color:var(--text-secondary);margin-bottom:16px}.chart-container{height:clamp(160px,25vw,200px)}.chart-legend{display:flex;flex-wrap:wrap;gap:8px 16px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary)}.legend-dot{width:8px;height:8px;border-radius:50%}.bottom-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}.card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,3vw,24px)}.card h3{font-size:14px;color:var(--text-secondary);margin-bottom:16px}.summary-list{display:flex;flex-direction:column;gap:12px}.summary-item{display:flex;justify-content:space-between;gap:12px}.summary-label{font-size:13px;color:var(--text-secondary)}.summary-value{font-family:var(--font-mono);font-size:13px;font-weight:600}.upcoming-list{display:flex;flex-direction:column;gap:10px}.upcoming-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-tertiary);border-radius:var(--radius-md);gap:12px}.upcoming-info{flex:1;min-width:0}.upcoming-name{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.upcoming-date{font-size:12px;color:var(--text-muted)}.upcoming-amount{font-family:var(--font-mono);font-size:14px;color:var(--orange);font-weight:600}.savings-summary{display:flex;flex-direction:column;gap:12px}.savings-total{display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)}.savings-label{font-size:13px;color:var(--text-secondary)}.savings-value{font-family:var(--font-mono);font-size:18px;font-weight:700;color:var(--blue)}.savings-accounts{display:flex;flex-direction:column;gap:8px}.savings-account-mini{display:flex;justify-content:space-between;font-size:13px}.savings-account-mini span:last-child{font-family:var(--font-mono);color:var(--text-secondary)}.filters{display:flex;gap:12px;margin-bottom:20px}.filters input,.filters select{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px 16px;color:var(--text-primary)}.filters input{flex:1}.filters input::placeholder{color:var(--text-muted)}.list-container{display:flex;flex-direction:column;gap:8px}.list-item{display:flex;align-items:center;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;gap:12px}.list-item-icon{width:44px;height:44px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:20px}.list-item-icon.green{background:var(--green-dim)}.list-item-icon.red{background:var(--red-dim)}.list-item-icon.orange{background:var(--orange-dim)}.list-item-icon.blue{background:var(--blue-dim)}.list-item-icon.purple{background:var(--purple-dim)}.list-item-info{flex:1;min-width:0}.list-item-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.list-item-subtitle{font-size:12px;color:var(--text-muted);margin-top:2px}.list-item-amount{font-family:var(--font-mono);font-size:15px;font-weight:600}.list-item-amount.green{color:var(--green)}.list-item-amount.red{color:var(--red)}.list-item-amount.orange{color:var(--orange)}.list-item-amount.blue{color:var(--blue)}.list-item-actions{display:flex;gap:6px}.empty-state{text-align:center;padding:40px;color:var(--text-muted)}.abonnements-summary{display:flex;gap:24px;margin-bottom:24px;padding:20px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);flex-wrap:wrap}.abo-stat{display:flex;align-items:baseline;gap:6px}.abo-stat-value{font-family:var(--font-mono);font-size:clamp(24px,5vw,32px);font-weight:700;color:var(--orange)}.abo-stat-label{font-size:14px;color:var(--text-muted)}.epargne-total{display:flex;justify-content:space-between;align-items:center;padding:24px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:24px;flex-wrap:wrap;gap:12px}.epargne-total-label{font-size:16px;color:var(--text-secondary)}.epargne-total-value{font-family:var(--font-mono);font-size:clamp(28px,6vw,40px);font-weight:700;color:var(--blue)}.epargne-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:28px}.epargne-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px}.epargne-card-header{display:flex;justify-content:space-between;margin-bottom:12px;gap:12px}.epargne-card-name{font-size:15px;font-weight:600}.epargne-card-type{font-size:11px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;background:var(--bg-tertiary);border-radius:var(--radius-sm)}.epargne-card-amount{font-family:var(--font-mono);font-size:clamp(22px,5vw,28px);font-weight:700;color:var(--blue);margin-bottom:12px}.epargne-card-footer{display:flex;justify-content:space-between;padding-top:12px;border-top:1px solid var(--border)}.epargne-card-goal{font-size:12px;color:var(--text-muted)}.epargne-card-actions{display:flex;gap:6px}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;padding:16px}.modal-overlay.active{opacity:1;visibility:visible}.modal{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);width:100%;max-width:480px;max-height:calc(100vh - 32px);overflow:hidden;display:flex;flex-direction:column;transform:scale(.95) translateY(20px)}.modal-overlay.active .modal{transform:scale(1) translateY(0)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}.modal-header h2{font-size:18px;font-weight:600}.modal-close{background:0 0;border:none;color:var(--text-secondary);font-size:28px;cursor:pointer}.modal-body{padding:20px;display:flex;flex-direction:column;gap:16px;overflow-y:auto}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.modal-footer{display:flex;gap:12px;padding:20px;border-top:1px solid var(--border)}.modal-footer button{flex:1}.settings-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,4vw,24px);margin-bottom:16px}.settings-card h3{font-size:16px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}.settings-card.danger{border-color:var(--red-dim)}.settings-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);gap:16px}.settings-row:last-child{border-bottom:none}.settings-row>div:first-child{flex:1}.settings-row label{font-size:14px;font-weight:500}.settings-row select,.settings-row input{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 14px;color:var(--text-primary);min-width:140px}.settings-hint{font-size:12px;color:var(--text-muted);margin-top:2px}.account-box{background:var(--bg-tertiary);border-radius:var(--radius-md);padding:16px;margin-bottom:16px}.account-row{display:flex;justify-content:space-between;padding:10px 0;font-size:13px;border-bottom:1px solid var(--border)}.account-row:last-child{border-bottom:none}.account-label{color:var(--text-secondary)}.account-value{font-family:var(--font-mono);font-weight:500}.toggle-switch{position:relative;width:52px;height:30px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:30px}.toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:var(--text-secondary);border-radius:50%;transition:.3s}.toggle-switch input:checked+.toggle-slider{background:var(--accent);border-color:var(--accent)}.toggle-switch input:checked+.toggle-slider:before{transform:translateX(22px);background:#fff}.tags-container{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}.tag{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:var(--bg-tertiary);border-radius:20px;font-size:13px}.tag-remove{background:0 0;border:none;color:var(--text-muted);cursor:pointer;font-size:16px}.tag-remove:hover{color:var(--red)}.add-tag-row{display:flex;gap:8px}.add-tag-row input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 12px;color:var(--text-primary)}.toast{position:fixed;bottom:calc(24px + var(--safe-bottom));left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px 24px;font-size:14px;font-weight:500;z-index:2000;opacity:0}.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}.toast.success{border-color:var(--green);color:var(--green)}.toast.error{border-color:var(--red);color:var(--red)}@media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}.bottom-grid{grid-template-columns:repeat(2,1fr)}.bottom-grid .card:last-child{grid-column:span 2}}@media(max-width:1024px){.charts-grid{grid-template-columns:1fr}}@media(max-width:768px){.sidebar{transform:translateX(-100%);width:280px;transition:transform .3s}.sidebar.open{transform:translateX(0)}.mobile-header{display:flex}.main-content{margin-left:0;padding:calc(76px + var(--safe-top)) 16px calc(24px + var(--safe-bottom))}.section-header{flex-direction:column}.section-header .btn-primary{width:100%}.period-selector{width:100%}.period-selector select{flex:1}.stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}.stat-card{padding:14px}.charts-grid{gap:12px}.bottom-grid{grid-template-columns:1fr}.bottom-grid .card:last-child{grid-column:span 1}.filters{flex-direction:column}.list-item{padding:14px}.abonnements-summary{flex-direction:column;gap:12px}.epargne-total{flex-direction:column;text-align:center}.epargne-grid{grid-template-columns:1fr}.modal{max-height:calc(100vh - 20px);border-radius:var(--radius-lg) var(--radius-lg) 0 0;margin-top:auto}.form-row{grid-template-columns:1fr}.settings-row{flex-direction:column;align-items:stretch;gap:10px}.settings-row select,.settings-row input{width:100%}.add-tag-row{flex-direction:column}}@media(max-width:380px){.stats-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-logo"><span class="logo-icon">‚óâ</span><h1>Th√©.OS Finance</h1><p>G√©rez vos finances simplement</p></div>
            <div class="auth-tabs"><button class="auth-tab active" onclick="showTab('login')">Connexion</button><button class="auth-tab" onclick="showTab('register')">Inscription</button></div>
            <div class="auth-error" id="authError"></div>
            <div class="auth-loading" id="authLoading"><div class="spinner"></div><span>Connexion...</span></div>
            <form class="auth-form active" id="loginForm" onsubmit="doLogin(event)">
                <div class="form-group"><label>Identifiant</label><input type="text" id="loginUser" placeholder="Votre identifiant" required autocomplete="username"></div>
                <div class="form-group"><label>Mot de passe</label><input type="password" id="loginPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password"></div>
                <button type="submit" class="btn-primary">Se connecter</button>
            </form>
            <form class="auth-form" id="registerForm" onsubmit="doRegister(event)">
                <div class="form-group"><label>Identifiant</label><input type="text" id="regUser" placeholder="Choisissez un identifiant" required minlength="3" autocomplete="username"></div>
                <div class="form-group"><label>Mot de passe</label><input type="password" id="regPwd" placeholder="Minimum 6 caract√®res" required minlength="6" autocomplete="new-password"></div>
                <div class="form-group"><label>Confirmer</label><input type="password" id="regPwdC" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password"></div>
                <button type="submit" class="btn-primary">Cr√©er mon compte</button>
            </form>
        </div>
    </div>
    <div class="app" id="app">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        <nav class="sidebar" id="sidebar">
            <div class="logo"><span class="logo-icon">‚óâ</span><span class="logo-text">Th√©.OS Finance</span></div>
            <div class="user-info"><div class="user-name" id="userName">Utilisateur</div><div class="user-status" id="syncStatus">‚úì Synchronis√©</div></div>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-section="dashboard"><span class="nav-icon">‚ó´</span> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="revenus"><span class="nav-icon">‚Üë</span> Revenus</a></li>
                <li><a href="#" class="nav-link" data-section="depenses"><span class="nav-icon">‚Üì</span> D√©penses</a></li>
                <li><a href="#" class="nav-link" data-section="abonnements"><span class="nav-icon">‚Üª</span> Abonnements</a></li>
                <li><a href="#" class="nav-link" data-section="epargne"><span class="nav-icon">‚óà</span> √âpargne</a></li>
                <li><a href="#" class="nav-link" data-section="settings"><span class="nav-icon">‚öô</span> R√©glages</a></li>
            </ul>
            <div class="sidebar-footer"><button class="btn-logout" onclick="logout()">‚èª D√©connexion</button></div>
        </nav>
        <header class="mobile-header"><button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button><span class="mobile-title">Th√©.OS Finance</span><span style="width:40px"></span></header>
        <main class="main-content">
            <section id="dashboard" class="section active">
                <div class="section-header"><div><h1>Dashboard</h1><p class="today-date" id="todayDate"></p></div><div class="period-selector"><select id="periodType" onchange="updateDashboard()"><option value="month">Mois</option><option value="year">Ann√©e</option><option value="all">Tout</option></select><select id="periodMonth" onchange="updateDashboard()"></select><select id="periodYear" onchange="updateDashboard()"></select></div></div>
                <div class="stats-grid"><div class="stat-card stat-revenus"><div class="stat-label">Revenus</div><div class="stat-value" id="statRev">0 ‚Ç¨</div><div class="stat-detail" id="statRevD">0 entr√©es</div></div><div class="stat-card stat-depenses"><div class="stat-label">D√©penses</div><div class="stat-value" id="statDep">0 ‚Ç¨</div><div class="stat-detail" id="statDepD">0 entr√©es</div></div><div class="stat-card stat-net"><div class="stat-label">Net</div><div class="stat-value" id="statNet">0 ‚Ç¨</div><div class="stat-detail" id="statNetD">‚Äî</div></div><div class="stat-card stat-abonnements"><div class="stat-label">Abonnements</div><div class="stat-value" id="statAbo">0 ‚Ç¨</div><div class="stat-detail" id="statAboD">0 actifs</div></div></div>
                <div class="charts-grid"><div class="chart-card"><h3>D√©penses par cat√©gorie</h3><div class="chart-container"><canvas id="chartDep"></canvas></div><div id="legDep" class="chart-legend"></div></div><div class="chart-card"><h3>Revenus par cat√©gorie</h3><div class="chart-container"><canvas id="chartRev"></canvas></div><div id="legRev" class="chart-legend"></div></div></div>
                <div class="bottom-grid"><div class="card"><h3>R√©sum√©</h3><div class="summary-list"><div class="summary-item"><span class="summary-label">Top d√©pense</span><span class="summary-value" id="sumTopD">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top revenu</span><span class="summary-value" id="sumTopR">‚Äî</span></div><div class="summary-item"><span class="summary-label">Moyenne d√©p.</span><span class="summary-value" id="sumAvg">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top cat√©gorie</span><span class="summary-value" id="sumCat">‚Äî</span></div></div></div><div class="card"><h3>Prochains paiements</h3><div class="upcoming-list" id="upList"><div class="empty-state">Aucun</div></div></div><div class="card"><h3>√âpargne</h3><div class="savings-summary"><div class="savings-total"><span class="savings-label">Total</span><span class="savings-value" id="savTot">0 ‚Ç¨</span></div><div class="savings-accounts" id="savList"></div></div></div></div>
            </section>
            <section id="revenus" class="section"><div class="section-header"><h1>Revenus</h1><button class="btn-primary" onclick="openModal('revenu')">+ Ajouter</button></div><div class="filters"><input type="text" id="fRev" placeholder="Rechercher..." oninput="filter('revenus')"><select id="fRevC" onchange="filter('revenus')"><option value="">Toutes cat√©gories</option></select></div><div class="list-container" id="lRev"></div></section>
            <section id="depenses" class="section"><div class="section-header"><h1>D√©penses</h1><button class="btn-primary" onclick="openModal('depense')">+ Ajouter</button></div><div class="filters"><input type="text" id="fDep" placeholder="Rechercher..." oninput="filter('depenses')"><select id="fDepC" onchange="filter('depenses')"><option value="">Toutes cat√©gories</option></select></div><div class="list-container" id="lDep"></div></section>
            <section id="abonnements" class="section"><div class="section-header"><h1>Abonnements</h1><button class="btn-primary" onclick="openModal('abonnement')">+ Ajouter</button></div><div class="abonnements-summary"><div class="abo-stat"><span class="abo-stat-value" id="aboM">0 ‚Ç¨</span><span class="abo-stat-label">/ mois</span></div><div class="abo-stat"><span class="abo-stat-value" id="aboY">0 ‚Ç¨</span><span class="abo-stat-label">/ an</span></div></div><div class="list-container" id="lAbo"></div></section>
            <section id="epargne" class="section"><div class="section-header"><h1>√âpargne</h1><button class="btn-primary" onclick="openModal('epargne')">+ Compte</button></div><div class="epargne-total"><span class="epargne-total-label">Total √©pargn√©</span><span class="epargne-total-value" id="epTot">0 ‚Ç¨</span></div><div class="epargne-grid" id="epGrid"></div><div class="section-subheader"><h2>Mouvements</h2><button class="btn-secondary" onclick="openModal('mouvement')">+ Mouvement</button></div><div class="list-container" id="lMvt"></div></section>
            <section id="settings" class="section">
                <div class="section-header"><h1>R√©glages</h1></div>
                <div class="settings-card"><h3>üë§ Mon compte</h3><div class="account-box"><div class="account-row"><span class="account-label">Identifiant</span><span class="account-value" id="accU">‚Äî</span></div><div class="account-row"><span class="account-label">Cr√©√© le</span><span class="account-value" id="accC">‚Äî</span></div></div></div>
                <div class="settings-card"><h3>üîê S√©curit√©</h3><div class="settings-row"><div><label>Changer mot de passe</label></div><button class="btn-secondary" onclick="openPwdModal()">Modifier</button></div><div class="settings-row"><div><label>Masquer les montants</label><p class="settings-hint">Floute les valeurs</p></div><label class="toggle-switch"><input type="checkbox" id="sHide" onchange="tog('hideAmounts',this.checked)"><span class="toggle-slider"></span></label></div></div>
                <div class="settings-card"><h3>üé® Apparence</h3><div class="settings-row"><div><label>Th√®me</label></div><select id="sTheme" onchange="setTheme(this.value)"><option value="dark">üåô Sombre</option><option value="light">‚òÄÔ∏è Clair</option><option value="auto">üåì Auto</option></select></div><div class="settings-row"><div><label>Couleur d'accent</label></div><select id="sAccent" onchange="setAccent(this.value)"><option value="#ff3b30">üî¥ Rouge</option><option value="#ff9500">üü† Orange</option><option value="#34c759">üü¢ Vert</option><option value="#007aff">üîµ Bleu</option><option value="#af52de">üü£ Violet</option></select></div></div>
                <div class="settings-card"><h3>üí∞ Format</h3><div class="settings-row"><div><label>Devise</label></div><select id="sCur" onchange="sav('currency',this.value);refresh()"><option value="EUR">‚Ç¨ Euro</option><option value="USD">$ Dollar</option><option value="GBP">¬£ Livre</option></select></div><div class="settings-row"><div><label>Afficher centimes</label></div><label class="toggle-switch"><input type="checkbox" id="sCents" checked onchange="tog('showCents',this.checked);refresh()"><span class="toggle-slider"></span></label></div></div>
                <div class="settings-card"><h3>üè∑Ô∏è Cat√©gories</h3><div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Revenus</label><div class="tags-container" id="tRev"></div><div class="add-tag-row"><input type="text" id="nRev" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('revenus')">+</button></div></div><div class="settings-row" style="flex-direction:column;align-items:stretch"><label>D√©penses</label><div class="tags-container" id="tDep"></div><div class="add-tag-row"><input type="text" id="nDep" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('depenses')">+</button></div></div><div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Abonnements</label><div class="tags-container" id="tAbo"></div><div class="add-tag-row"><input type="text" id="nAbo" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('abonnements')">+</button></div></div></div>
                <div class="settings-card"><h3>üíæ Export</h3><div class="settings-row"><div><label>Export JSON</label></div><button class="btn-secondary" onclick="expJSON()">T√©l√©charger</button></div><div class="settings-row"><div><label>Export Excel</label></div><button class="btn-secondary" onclick="expXLS()">T√©l√©charger</button></div></div>
                <div class="settings-card danger"><h3>‚ö†Ô∏è Zone danger</h3><div class="settings-row"><div><label>Effacer mes donn√©es</label><p class="settings-hint">Conserve le compte</p></div><button class="btn-danger" onclick="clearData()">Effacer</button></div><div class="settings-row"><div><label>Supprimer mon compte</label></div><button class="btn-danger" onclick="delAccount()">Supprimer</button></div></div>
            </section>
        </main>
    </div>
    <div class="modal-overlay" id="modalO" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h2 id="modalT">Ajouter</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><form id="modalF" onsubmit="submitForm(event)"><div class="modal-body" id="modalB"></div><div class="modal-footer" id="modalFoot"><button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button><button type="submit" class="btn-primary">Enregistrer</button></div></form></div></div>
    <div class="toast" id="toast"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script>
const BUCKET='PAhBeK3j5G8FoxgNdSUq8F';
const API=k=>`https://kvdb.io/${BUCKET}/${k}`;
let currentUser=null,userCreated=null,data={revenus:[],depenses:[],abonnements:[],epargne:[],mouvements:[],categories:{revenus:['Salaire','Freelance','YouTube','Autre'],depenses:['Alimentation','Transport','Logement','Loisirs','Shopping','Tech','Sant√©','Autre'],abonnements:['Streaming','Cloud','Software','T√©l√©com','Autre'],epargne:['Livret A','PEA','Crypto','Autre']}},settings={currency:'EUR',accent:'#ff3b30',theme:'auto',hideAmounts:false,showCents:true},charts={};
const colors=['#ff3b30','#ff9500','#ffcc00','#34c759','#007aff','#5856d6','#af52de','#ff2d55'];
async function sha256(s){const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(s));return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('')}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function fmt(n){const o={style:'currency',currency:settings.currency||'EUR'};if(!settings.showCents){o.minimumFractionDigits=0;o.maximumFractionDigits=0}return new Intl.NumberFormat('fr-FR',o).format(n)}
function fmtD(d){return new Date(d).toLocaleDateString('fr-FR')}
function toast(m,t='success'){const e=document.getElementById('toast');e.textContent=m;e.className='toast show '+t;setTimeout(()=>e.classList.remove('show'),3000)}
function showErr(m){const e=document.getElementById('authError');e.textContent=m;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),5000)}
function setLoading(s){document.getElementById('authLoading').classList.toggle('show',s);document.querySelectorAll('.auth-form').forEach(f=>f.style.display=s?'none':'');if(!s)showTab(document.querySelector('.auth-tab.active').textContent==='Connexion'?'login':'register')}
function setSyncStatus(s){const e=document.getElementById('syncStatus');if(s==='syncing'){e.className='user-status syncing';e.innerHTML='‚Üª Sync...'}else if(s==='error'){e.className='user-status error';e.innerHTML='‚úó Erreur'}else{e.className='user-status';e.innerHTML='‚úì Synchronis√©'}}
async function kvGet(k){try{const r=await fetch(API(k));if(r.status===404)return null;if(!r.ok)throw new Error();return await r.json()}catch(e){return null}}
async function kvSet(k,v){setSyncStatus('syncing');try{const r=await fetch(API(k),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(v)});if(!r.ok)throw new Error();setSyncStatus('ok');return true}catch(e){console.error(e);setSyncStatus('error');return false}}
async function kvDel(k){try{await fetch(API(k),{method:'DELETE'})}catch(e){}}
function showTab(t){document.querySelectorAll('.auth-tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.auth-form').forEach(x=>x.classList.remove('active'));document.getElementById('authError').classList.remove('show');if(t==='login'){document.querySelector('.auth-tab:first-child').classList.add('active');document.getElementById('loginForm').classList.add('active')}else{document.querySelector('.auth-tab:last-child').classList.add('active');document.getElementById('registerForm').classList.add('active')}}
async function doRegister(e){e.preventDefault();const u=document.getElementById('regUser').value.trim().toLowerCase(),p=document.getElementById('regPwd').value,c=document.getElementById('regPwdC').value;if(u.length<3){showErr('Identifiant trop court');return}if(p.length<6){showErr('Mot de passe trop court');return}if(p!==c){showErr('Mots de passe diff√©rents');return}setLoading(true);try{const existing=await kvGet('user_'+u);if(existing){setLoading(false);showErr('Identifiant d√©j√† pris');return}const h=await sha256(p);const created=new Date().toISOString();const userData={pwdHash:h,created,data:{revenus:[],depenses:[],abonnements:[],epargne:[],mouvements:[],categories:{...data.categories}},settings:{...settings}};await kvSet('user_'+u,userData);currentUser=u;userCreated=created;data=userData.data;settings=userData.settings;localStorage.setItem('theos_session',JSON.stringify({u,h}));toast('Compte cr√©√© !');enterApp()}catch(err){console.error(err);setLoading(false);showErr('Erreur r√©seau')}}
async function doLogin(e){e.preventDefault();const u=document.getElementById('loginUser').value.trim().toLowerCase(),p=document.getElementById('loginPwd').value;setLoading(true);try{const userData=await kvGet('user_'+u);if(!userData){setLoading(false);showErr('Compte introuvable');return}const h=await sha256(p);if(userData.pwdHash!==h){setLoading(false);showErr('Mot de passe incorrect');return}currentUser=u;userCreated=userData.created;data=userData.data||data;settings={...settings,...userData.settings};localStorage.setItem('theos_session',JSON.stringify({u,h}));toast('Connect√© !');enterApp()}catch(err){console.error(err);setLoading(false);showErr('Erreur r√©seau')}}
async function tryAutoLogin(){const s=localStorage.getItem('theos_session');if(!s)return false;try{const{u,h}=JSON.parse(s);const userData=await kvGet('user_'+u);if(userData&&userData.pwdHash===h){currentUser=u;userCreated=userData.created;data=userData.data||data;settings={...settings,...userData.settings};return true}}catch(e){console.error(e)}return false}
function enterApp(){document.getElementById('authScreen').style.display='none';document.getElementById('app').classList.add('active');initApp()}
function logout(){if(confirm('D√©connexion ?')){localStorage.removeItem('theos_session');location.reload()}}
async function syncToCloud(){try{const userData=await kvGet('user_'+currentUser);if(userData){userData.data=data;userData.settings=settings;await kvSet('user_'+currentUser,userData)}}catch(e){console.error(e);setSyncStatus('error')}}
let syncTimeout=null;
function scheduleSync(){if(syncTimeout)clearTimeout(syncTimeout);syncTimeout=setTimeout(syncToCloud,1500)}
document.addEventListener('DOMContentLoaded',async()=>{applyTheme();setLoading(true);if(await tryAutoLogin()){enterApp()}else{setLoading(false)}});
function initApp(){applyTheme();initNav();initPeriod();refresh();renderSettings();updateDate();document.getElementById('userName').textContent=currentUser}
function refresh(){renderAll();updateDashboard();scheduleSync()}
function getSystemTheme(){return window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'}
function applyTheme(){document.documentElement.style.setProperty('--accent',settings.accent||'#ff3b30');let t=settings.theme||'auto';if(t==='auto')t=getSystemTheme();document.documentElement.setAttribute('data-theme',t)}
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{if(settings.theme==='auto')applyTheme()});
function setTheme(t){settings.theme=t;applyTheme();scheduleSync()}
function setAccent(c){settings.accent=c;applyTheme();scheduleSync()}
function renderSettings(){document.getElementById('sTheme').value=settings.theme||'auto';document.getElementById('sAccent').value=settings.accent||'#ff3b30';document.getElementById('sCur').value=settings.currency||'EUR';document.getElementById('sHide').checked=settings.hideAmounts||false;document.getElementById('sCents').checked=settings.showCents!==false;document.getElementById('accU').textContent=currentUser;document.getElementById('accC').textContent=userCreated?fmtD(userCreated):'‚Äî';renderTags()}
function sav(k,v){settings[k]=v;scheduleSync()}
function tog(k,v){settings[k]=v;applyTheme();scheduleSync();refresh()}
function openPwdModal(){document.getElementById('modalT').textContent='Changer mot de passe';document.getElementById('modalB').innerHTML='<div class="form-group"><label>Mot de passe actuel</label><input type="password" id="pwdOld" required></div><div class="form-group"><label>Nouveau mot de passe</label><input type="password" id="pwdNew" required minlength="6"></div><div class="form-group"><label>Confirmer</label><input type="password" id="pwdConf" required></div>';document.getElementById('modalFoot').style.display='flex';document.getElementById('modalF').onsubmit=changePwd;document.getElementById('modalO').classList.add('active')}
async function changePwd(e){e.preventDefault();const userData=await kvGet('user_'+currentUser);const old=await sha256(document.getElementById('pwdOld').value);if(old!==userData.pwdHash){toast('Mot de passe incorrect','error');return}const n=document.getElementById('pwdNew').value,c=document.getElementById('pwdConf').value;if(n!==c){toast('Ne correspondent pas','error');return}if(n.length<6){toast('Trop court','error');return}const h=await sha256(n);userData.pwdHash=h;await kvSet('user_'+currentUser,userData);localStorage.setItem('theos_session',JSON.stringify({u:currentUser,h}));closeModal();toast('Mot de passe chang√© !')}
async function clearData(){if(confirm('Effacer toutes les donn√©es ?')){data={revenus:[],depenses:[],abonnements:[],epargne:[],mouvements:[],categories:data.categories};await syncToCloud();refresh();toast('Donn√©es effac√©es')}}
async function delAccount(){if(confirm('SUPPRIMER le compte ?')&&prompt('Tapez SUPPRIMER')==='SUPPRIMER'){await kvDel('user_'+currentUser);localStorage.removeItem('theos_session');toast('Compte supprim√©');setTimeout(()=>location.reload(),1000)}}
function renderTags(){['revenus','depenses','abonnements'].forEach(t=>{const m={revenus:'Rev',depenses:'Dep',abonnements:'Abo'},c=document.getElementById('t'+m[t]);if(c&&data.categories&&data.categories[t])c.innerHTML=data.categories[t].map(x=>`<span class="tag">${x}<button class="tag-remove" onclick="remCat('${t}','${x}')">√ó</button></span>`).join('')})}
function addCat(t){const m={revenus:'Rev',depenses:'Dep',abonnements:'Abo'},i=document.getElementById('n'+m[t]),v=i.value.trim();if(v&&!data.categories[t].includes(v)){data.categories[t].push(v);scheduleSync();renderTags();updateFilters();i.value=''}}
function remCat(t,c){if(data.categories[t].length>1&&confirm(`Supprimer "${c}" ?`)){data.categories[t]=data.categories[t].filter(x=>x!==c);scheduleSync();renderTags();updateFilters()}}
function initNav(){document.querySelectorAll('.nav-link').forEach(l=>l.addEventListener('click',e=>{e.preventDefault();goTo(l.dataset.section)}))}
function goTo(s){document.querySelectorAll('.nav-link').forEach(l=>l.classList.toggle('active',l.dataset.section===s));document.querySelectorAll('.section').forEach(x=>x.classList.toggle('active',x.id===s));closeSidebar();if(s==='dashboard')updateDashboard();if(s==='settings')renderSettings()}
function toggleSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('sidebarOverlay').classList.add('active')}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('active')}
function initPeriod(){const m=document.getElementById('periodMonth');['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c'].forEach((n,i)=>m.innerHTML+=`<option value="${i}">${n}</option>`);m.value=new Date().getMonth();const y=document.getElementById('periodYear');for(let i=2024;i<=2030;i++)y.innerHTML+=`<option value="${i}">${i}</option>`;y.value=new Date().getFullYear()}
function getPeriod(){return{type:document.getElementById('periodType').value,month:+document.getElementById('periodMonth').value,year:+document.getElementById('periodYear').value}}
function updateDate(){document.getElementById('todayDate').textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}
function updateDashboard(){const t=document.getElementById('periodType').value;document.getElementById('periodMonth').style.display=t==='month'?'':'none';document.getElementById('periodYear').style.display=t==='all'?'none':'';const p=getPeriod(),fR=filterP(data.revenus||[],p),fD=filterP(data.depenses||[],p),tR=fR.reduce((s,x)=>s+x.montant,0),tD=fD.reduce((s,x)=>s+x.montant,0),net=tR-tD,tA=(data.abonnements||[]).reduce((s,x)=>s+x.montant,0),hc=settings.hideAmounts?' hidden-amount':'';document.getElementById('statRev').className='stat-value'+hc;document.getElementById('statDep').className='stat-value'+hc;document.getElementById('statNet').className='stat-value'+hc;document.getElementById('statAbo').className='stat-value'+hc;document.getElementById('statRev').textContent=fmt(tR);document.getElementById('statRevD').textContent=fR.length+' entr√©es';document.getElementById('statDep').textContent=fmt(tD);document.getElementById('statDepD').textContent=fD.length+' entr√©es';document.getElementById('statNet').textContent=fmt(net);document.querySelector('.stat-net').className='stat-card stat-net '+(net>=0?'positive':'negative');document.getElementById('statNetD').textContent=tR>0?Math.round(net/tR*100)+'%':'‚Äî';document.getElementById('statAbo').textContent=fmt(tA);document.getElementById('statAboD').textContent=(data.abonnements||[]).length+' actifs';updateCharts(fD,fR);updateSummary(fD,fR);updateUpcoming();updateSavDash()}
function filterP(items,p){if(p.type==='all')return items;return items.filter(i=>{const d=new Date(i.date);return p.type==='year'?d.getFullYear()===p.year:(d.getFullYear()===p.year&&d.getMonth()===p.month)})}
function updateCharts(fD,fR){if(charts.dep)charts.dep.destroy();if(charts.rev)charts.rev.destroy();charts.dep=makeChart('chartDep',group(fD));charts.rev=makeChart('chartRev',group(fR));renderLeg('legDep',group(fD));renderLeg('legRev',group(fR))}
function group(items){const g={};items.forEach(i=>{const c=i.categorie||'Autre';g[c]=(g[c]||0)+i.montant});return g}
function makeChart(id,d){const ctx=document.getElementById(id).getContext('2d'),l=Object.keys(d),v=Object.values(d);if(!v.length)return new Chart(ctx,{type:'doughnut',data:{labels:['Vide'],datasets:[{data:[1],backgroundColor:['#2a2a2a'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});return new Chart(ctx,{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:colors.slice(0,l.length),borderWidth:0,spacing:2}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.label}: ${fmt(c.raw)}`}}}}})}
function renderLeg(id,d){const c=document.getElementById(id),l=Object.keys(d);c.innerHTML=l.length?l.map((x,i)=>`<span class="legend-item"><span class="legend-dot" style="background:${colors[i%colors.length]}"></span>${x}</span>`).join(''):'<span class="legend-item">‚Äî</span>'}
function updateSummary(fD,fR){const topD=fD.length?fD.reduce((m,x)=>x.montant>m.montant?x:m):null;document.getElementById('sumTopD').textContent=topD?topD.description.substr(0,15):'‚Äî';const topR=fR.length?fR.reduce((m,x)=>x.montant>m.montant?x:m):null;document.getElementById('sumTopR').textContent=topR?topR.description.substr(0,15):'‚Äî';document.getElementById('sumAvg').textContent=fD.length?fmt(fD.reduce((s,x)=>s+x.montant,0)/fD.length):'‚Äî';const g=group(fD),tc=Object.entries(g).sort((a,b)=>b[1]-a[1])[0];document.getElementById('sumCat').textContent=tc?tc[0]:'‚Äî'}
function updateUpcoming(){const c=document.getElementById('upList');if(!data.abonnements||!data.abonnements.length){c.innerHTML='<div class="empty-state">Aucun</div>';return}const now=new Date(),u=data.abonnements.map(a=>{let nd=new Date(now.getFullYear(),now.getMonth(),a.jour||1);if(nd<=now)nd=new Date(now.getFullYear(),now.getMonth()+1,a.jour||1);return{...a,nd}}).sort((a,b)=>a.nd-b.nd).slice(0,4);c.innerHTML=u.map(a=>`<div class="upcoming-item"><div class="upcoming-info"><span class="upcoming-name">${a.description}</span><span class="upcoming-date">${fmtD(a.nd)}</span></div><span class="upcoming-amount">${fmt(a.montant)}</span></div>`).join('')}
function updateSavDash(){const t=(data.epargne||[]).reduce((s,x)=>s+x.solde,0);document.getElementById('savTot').textContent=fmt(t);const c=document.getElementById('savList');c.innerHTML=data.epargne&&data.epargne.length?data.epargne.slice(0,3).map(x=>`<div class="savings-account-mini"><span>${x.nom}</span><span>${fmt(x.solde)}</span></div>`).join(''):'<div class="empty-state">Aucun</div>'}
function renderAll(){renderRev();renderDep();renderAbo();renderEp();renderMvt();updateFilters()}
function renderRev(){const c=document.getElementById('lRev'),items=[...(data.revenus||[])].sort((a,b)=>new Date(b.date)-new Date(a.date));c.innerHTML=items.length?items.map(i=>`<div class="list-item"><div class="list-item-icon green">‚Üë</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">${fmtD(i.date)} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount green${settings.hideAmounts?' hidden-amount':''}">+${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('revenu','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('revenus','${i.id}')">√ó</button></div></div>`).join(''):'<div class="empty-state">Aucun revenu</div>'}
function renderDep(){const c=document.getElementById('lDep'),items=[...(data.depenses||[])].sort((a,b)=>new Date(b.date)-new Date(a.date));c.innerHTML=items.length?items.map(i=>`<div class="list-item"><div class="list-item-icon red">‚Üì</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">${fmtD(i.date)} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount red${settings.hideAmounts?' hidden-amount':''}">-${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('depense','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('depenses','${i.id}')">√ó</button></div></div>`).join(''):'<div class="empty-state">Aucune d√©pense</div>'}
function renderAbo(){const c=document.getElementById('lAbo'),tm=(data.abonnements||[]).reduce((s,a)=>s+a.montant,0);document.getElementById('aboM').textContent=fmt(tm);document.getElementById('aboY').textContent=fmt(tm*12);c.innerHTML=data.abonnements&&data.abonnements.length?data.abonnements.map(i=>`<div class="list-item"><div class="list-item-icon orange">‚Üª</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">Le ${i.jour||1} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount orange${settings.hideAmounts?' hidden-amount':''}">${fmt(i.montant)}/mois</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('abonnement','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('abonnements','${i.id}')">√ó</button></div></div>`).join(''):'<div class="empty-state">Aucun abonnement</div>'}
function renderEp(){const c=document.getElementById('epGrid'),t=(data.epargne||[]).reduce((s,x)=>s+x.solde,0);document.getElementById('epTot').textContent=fmt(t);c.innerHTML=data.epargne&&data.epargne.length?data.epargne.map(x=>`<div class="epargne-card"><div class="epargne-card-header"><span class="epargne-card-name">${x.nom}</span><span class="epargne-card-type">${x.type}</span></div><div class="epargne-card-amount${settings.hideAmounts?' hidden-amount':''}">${fmt(x.solde)}</div><div class="epargne-card-footer"><span class="epargne-card-goal">${x.objectif?'Obj: '+fmt(x.objectif):'‚Äî'}</span><div class="epargne-card-actions"><button class="btn-icon" onclick="edit('epargne','${x.id}')">‚úé</button><button class="btn-icon delete" onclick="del('epargne','${x.id}')">√ó</button></div></div></div>`).join(''):'<div class="empty-state">Aucun compte</div>'}
function renderMvt(){const c=document.getElementById('lMvt'),items=[...(data.mouvements||[])].sort((a,b)=>new Date(b.date)-new Date(a.date));c.innerHTML=items.length?items.map(i=>{const cp=(data.epargne||[]).find(e=>e.id===i.compteId),dep=i.type==='depot';return`<div class="list-item"><div class="list-item-icon ${dep?'blue':'purple'}">${dep?'‚Üë':'‚Üì'}</div><div class="list-item-info"><span class="list-item-title">${i.description||(dep?'D√©p√¥t':'Retrait')}</span><span class="list-item-subtitle">${fmtD(i.date)} ‚Ä¢ ${cp?cp.nom:'?'}</span></div><span class="list-item-amount ${dep?'blue':'purple'}${settings.hideAmounts?' hidden-amount':''}">${dep?'+':'-'}${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon delete" onclick="del('mouvements','${i.id}')">√ó</button></div></div>`}).join(''):'<div class="empty-state">Aucun mouvement</div>'}
function updateFilters(){document.getElementById('fRevC').innerHTML='<option value="">Toutes</option>'+(data.categories.revenus||[]).map(c=>`<option>${c}</option>`).join('');document.getElementById('fDepC').innerHTML='<option value="">Toutes</option>'+(data.categories.depenses||[]).map(c=>`<option>${c}</option>`).join('')}
function filter(t){const m={revenus:['fRev','fRevC','lRev'],depenses:['fDep','fDepC','lDep']},[fId,catId,listId]=m[t],s=document.getElementById(fId).value.toLowerCase(),cat=document.getElementById(catId).value;document.querySelectorAll(`#${listId} .list-item`).forEach(i=>{const ti=i.querySelector('.list-item-title').textContent.toLowerCase(),su=i.querySelector('.list-item-subtitle').textContent;i.style.display=ti.includes(s)&&(!cat||su.includes(cat))?'flex':'none'})}
let editId=null,editType=null;
function openModal(type,id=null){editType=type;editId=id;const title=document.getElementById('modalT'),body=document.getElementById('modalB');document.getElementById('modalFoot').style.display='flex';document.getElementById('modalF').onsubmit=submitForm;let html='';if(type==='revenu'){const r=id?(data.revenus||[]).find(x=>x.id===id):null;title.textContent=id?'Modifier revenu':'Ajouter revenu';html=`<div class="form-group"><label>Description</label><input name="description" required value="${r?.description||''}" placeholder="Ex: Salaire"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="${r?.montant||''}" placeholder="0"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${r?.date||new Date().toISOString().split('T')[0]}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${(data.categories.revenus||[]).map(c=>`<option ${r?.categorie===c?'selected':''}>${c}</option>`).join('')}</select></div>`}else if(type==='depense'){const d=id?(data.depenses||[]).find(x=>x.id===id):null;title.textContent=id?'Modifier d√©pense':'Ajouter d√©pense';html=`<div class="form-group"><label>Description</label><input name="description" required value="${d?.description||''}" placeholder="Ex: Courses"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="${d?.montant||''}" placeholder="0"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${d?.date||new Date().toISOString().split('T')[0]}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${(data.categories.depenses||[]).map(c=>`<option ${d?.categorie===c?'selected':''}>${c}</option>`).join('')}</select></div>`}else if(type==='abonnement'){const a=id?(data.abonnements||[]).find(x=>x.id===id):null;title.textContent=id?'Modifier abonnement':'Ajouter abonnement';html=`<div class="form-group"><label>Description</label><input name="description" required value="${a?.description||''}" placeholder="Ex: Netflix"></div><div class="form-row"><div class="form-group"><label>Montant/mois</label><input type="number" name="montant" step="0.01" required value="${a?.montant||''}" placeholder="0"></div><div class="form-group"><label>Jour du mois</label><input type="number" name="jour" min="1" max="31" value="${a?.jour||1}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${(data.categories.abonnements||[]).map(c=>`<option ${a?.categorie===c?'selected':''}>${c}</option>`).join('')}</select></div>`}else if(type==='epargne'){const e=id?(data.epargne||[]).find(x=>x.id===id):null;title.textContent=id?'Modifier compte':'Nouveau compte';html=`<div class="form-group"><label>Nom du compte</label><input name="nom" required value="${e?.nom||''}" placeholder="Ex: Livret A"></div><div class="form-row"><div class="form-group"><label>Type</label><select name="type">${(data.categories.epargne||[]).map(c=>`<option ${e?.type===c?'selected':''}>${c}</option>`).join('')}</select></div><div class="form-group"><label>Solde actuel</label><input type="number" name="solde" step="0.01" required value="${e?.solde||''}" placeholder="0"></div></div><div class="form-group"><label>Objectif (optionnel)</label><input type="number" name="objectif" step="0.01" value="${e?.objectif||''}" placeholder="Ex: 10000"></div>`}else if(type==='mouvement'){title.textContent='Nouveau mouvement';html=`<div class="form-group"><label>Compte</label><select name="compteId">${(data.epargne||[]).map(c=>`<option value="${c.id}">${c.nom}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label>Type</label><select name="type"><option value="depot">D√©p√¥t</option><option value="retrait">Retrait</option></select></div><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required placeholder="0"></div></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label>Description (optionnel)</label><input name="description" placeholder="Ex: Virement"></div>`}body.innerHTML=html;document.getElementById('modalO').classList.add('active')}
function closeModal(){document.getElementById('modalO').classList.remove('active');editId=null;editType=null}
function submitForm(e){e.preventDefault();const fd=new FormData(e.target),entry=Object.fromEntries(fd.entries());if(entry.montant)entry.montant=parseFloat(entry.montant);if(entry.solde)entry.solde=parseFloat(entry.solde);if(entry.objectif)entry.objectif=entry.objectif?parseFloat(entry.objectif):null;if(entry.jour)entry.jour=parseInt(entry.jour);if(editType==='revenu'){if(editId){const i=data.revenus.findIndex(x=>x.id===editId);data.revenus[i]={...data.revenus[i],...entry}}else{entry.id=genId();data.revenus.push(entry)}renderRev()}else if(editType==='depense'){if(editId){const i=data.depenses.findIndex(x=>x.id===editId);data.depenses[i]={...data.depenses[i],...entry}}else{entry.id=genId();data.depenses.push(entry)}renderDep()}else if(editType==='abonnement'){if(editId){const i=data.abonnements.findIndex(x=>x.id===editId);data.abonnements[i]={...data.abonnements[i],...entry}}else{entry.id=genId();data.abonnements.push(entry)}renderAbo()}else if(editType==='epargne'){if(editId){const i=data.epargne.findIndex(x=>x.id===editId);data.epargne[i]={...data.epargne[i],...entry}}else{entry.id=genId();data.epargne.push(entry)}renderEp()}else if(editType==='mouvement'){entry.id=genId();data.mouvements.push(entry);const cp=data.epargne.find(x=>x.id===entry.compteId);if(cp)cp.solde+=entry.type==='depot'?entry.montant:-entry.montant;renderMvt();renderEp()}scheduleSync();updateDashboard();closeModal();toast('Enregistr√© !')}
function edit(t,id){openModal(t,id)}
function del(col,id){if(confirm('Supprimer ?')){data[col]=data[col].filter(x=>x.id!==id);scheduleSync();renderAll();updateDashboard();toast('Supprim√©')}}
function expJSON(){const b=new Blob([JSON.stringify({data,settings},null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`theos-${new Date().toISOString().split('T')[0]}.json`;a.click();toast('Export√©')}
function expXLS(){const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.revenus||[]).map(r=>({Description:r.description,Montant:r.montant,Date:r.date,Cat√©gorie:r.categorie}))),'Revenus');XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.depenses||[]).map(d=>({Description:d.description,Montant:d.montant,Date:d.date,Cat√©gorie:d.categorie}))),'D√©penses');XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.abonnements||[]).map(a=>({Description:a.description,Montant:a.montant,Jour:a.jour,Cat√©gorie:a.categorie}))),'Abonnements');XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.epargne||[]).map(e=>({Nom:e.nom,Type:e.type,Solde:e.solde,Objectif:e.objectif||''}))),'√âpargne');XLSX.writeFile(wb,`theos-${new Date().toISOString().split('T')[0]}.xlsx`);toast('Excel export√©')}
</script>
</body>
</html>
