<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Th√©.OS Finance</title>
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Th%C3%A9.OS%20Finance%22%2C%22short_name%22%3A%22Finance%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0a%22%2C%22theme_color%22%3A%22%230a0a0a%22%7D">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='none' stroke='%23ff3b30' stroke-width='8'/><circle cx='50' cy='50' r='12' fill='%23ff3b30'/></svg>">
    <style>
:root{--bg-primary:#0a0a0a;--bg-secondary:#111;--bg-tertiary:#1a1a1a;--bg-hover:#222;--border:#2a2a2a;--border-light:#333;--text-primary:#fff;--text-secondary:#888;--text-muted:#555;--accent:#ff3b30;--accent-hover:#ff5147;--green:#34c759;--green-dim:rgba(52,199,89,.15);--red:#ff3b30;--red-dim:rgba(255,59,48,.15);--blue:#007aff;--blue-dim:rgba(0,122,255,.15);--orange:#ff9500;--orange-dim:rgba(255,149,0,.15);--purple:#af52de;--purple-dim:rgba(175,82,222,.15);--radius-sm:6px;--radius-md:10px;--radius-lg:16px;--sidebar-width:260px;--font-mono:'SF Mono','Fira Code',monospace;--font-sans:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;--safe-bottom:env(safe-area-inset-bottom,0px);--safe-top:env(safe-area-inset-top,0px)}
[data-theme=light]{--bg-primary:#f5f5f7;--bg-secondary:#fff;--bg-tertiary:#e8e8ed;--bg-hover:#d1d1d6;--border:#d1d1d6;--border-light:#c7c7cc;--text-primary:#1d1d1f;--text-secondary:#6e6e73;--text-muted:#aeaeb2}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:var(--font-sans);background:var(--bg-primary);color:var(--text-primary);line-height:1.5;min-height:100vh;min-height:100dvh}
button,input,select{font-family:inherit;font-size:16px!important}
.auth-screen{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
.auth-container{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(24px,6vw,40px);width:100%;max-width:420px}
.auth-logo{text-align:center;margin-bottom:28px}
.auth-logo .logo-icon{font-size:48px;color:var(--accent)}
.auth-logo h1{font-size:24px;margin-top:12px}
.auth-logo p{color:var(--text-secondary);font-size:14px;margin-top:4px}
.auth-tabs{display:flex;margin-bottom:24px;border-bottom:1px solid var(--border)}
.auth-tab{flex:1;padding:12px;background:0 0;border:none;color:var(--text-secondary);font-weight:500;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}
.auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.auth-form{display:none;flex-direction:column;gap:16px}
.auth-form.active{display:flex}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:13px;color:var(--text-secondary);font-weight:500}
.form-group input,.form-group select{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px 16px;color:var(--text-primary);width:100%}
.form-group input:focus,.form-group select:focus{outline:0;border-color:var(--accent)}
.auth-error{background:var(--red-dim);border:1px solid var(--red);color:var(--red);padding:12px;border-radius:var(--radius-md);font-size:13px;display:none}
.auth-error.show{display:block;margin-bottom:12px}
.auth-loading{display:none;flex-direction:column;align-items:center;gap:12px;padding:40px;color:var(--text-secondary)}
.auth-loading.show{display:flex}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.btn-primary{background:var(--accent);color:#fff;border:none;padding:14px 20px;border-radius:var(--radius-md);font-weight:600;cursor:pointer}
.btn-primary:hover{background:var(--accent-hover)}
.btn-primary:disabled{opacity:.5}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border);padding:12px 20px;border-radius:var(--radius-md);font-weight:500;cursor:pointer}
.btn-secondary:hover{background:var(--bg-hover)}
.btn-danger{background:var(--red-dim);color:var(--red);border:1px solid var(--red);padding:12px 20px;border-radius:var(--radius-md);cursor:pointer}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-icon{background:var(--bg-tertiary);border:none;width:36px;height:36px;border-radius:var(--radius-sm);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.btn-icon:hover{background:var(--bg-hover);color:var(--text-primary)}
.btn-icon.delete:hover{background:var(--red-dim);color:var(--red)}
.app{display:none;min-height:100vh}
.app.active{display:flex}
.sidebar{width:var(--sidebar-width);background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;bottom:0;left:0;z-index:100}
.sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99;opacity:0;visibility:hidden}
.sidebar-overlay.active{opacity:1;visibility:visible}
.logo{padding:20px 24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.logo-icon{font-size:24px;color:var(--accent)}
.logo-text{font-size:17px;font-weight:600}
.user-info{padding:16px 24px;border-bottom:1px solid var(--border)}
.user-name{font-size:14px;font-weight:600}
.user-status{font-size:12px;color:var(--green);margin-top:2px}
.user-status.syncing{color:var(--orange)}
.user-status.offline{color:var(--text-muted)}
.user-status.error{color:var(--red)}
.nav-links{list-style:none;padding:12px;flex:1;overflow-y:auto}
.nav-link{display:flex;align-items:center;gap:12px;padding:14px 16px;color:var(--text-secondary);text-decoration:none;border-radius:var(--radius-md);margin-bottom:4px;font-size:14px;font-weight:500}
.nav-link:hover{background:var(--bg-hover);color:var(--text-primary)}
.nav-link.active{background:var(--bg-tertiary);color:var(--text-primary)}
.nav-icon{font-size:18px;width:24px;text-align:center}
.sidebar-footer{padding:16px;border-top:1px solid var(--border);padding-bottom:calc(16px + var(--safe-bottom))}
.btn-logout{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;background:var(--red-dim);border:none;border-radius:var(--radius-md);color:var(--red);font-weight:500;cursor:pointer}
.btn-logout:hover{background:var(--red);color:#fff}
.mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:60px;background:var(--bg-secondary);border-bottom:1px solid var(--border);align-items:center;padding:0 16px;z-index:90}
.menu-toggle{background:0 0;border:none;color:var(--text-primary);font-size:24px;cursor:pointer}
.mobile-title{flex:1;text-align:center;font-weight:600}
.main-content{flex:1;margin-left:var(--sidebar-width);padding:32px;min-height:100vh}
.section{display:none;animation:fadeIn .3s;max-width:1400px;margin:0 auto}
.section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
.section-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;gap:16px;flex-wrap:wrap}
.section-header h1{font-size:clamp(24px,5vw,32px);font-weight:700}
.today-date{font-size:14px;color:var(--text-secondary);margin-top:4px}
.period-selector{display:flex;gap:8px;flex-wrap:wrap}
.period-selector select{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 14px;color:var(--text-primary);min-width:100px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,3vw,24px)}
.stat-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;font-weight:600}
.stat-value{font-family:var(--font-mono);font-size:clamp(18px,3.5vw,28px);font-weight:700;margin-bottom:4px;word-break:break-word}
.stat-value.hidden-amount{filter:blur(8px);user-select:none}
.stat-detail{font-size:12px;color:var(--text-muted)}
.stat-revenus .stat-value{color:var(--green)}
.stat-depenses .stat-value{color:var(--red)}
.stat-net.positive .stat-value{color:var(--green)}
.stat-net.negative .stat-value{color:var(--red)}
.stat-abonnements .stat-value{color:var(--orange)}
.charts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:28px}
.chart-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,3vw,24px)}
.chart-card h3{font-size:14px;color:var(--text-secondary);margin-bottom:16px}
.chart-container{height:clamp(160px,25vw,200px)}
.chart-legend{display:flex;flex-wrap:wrap;gap:8px 16px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary)}
.legend-dot{width:8px;height:8px;border-radius:50%}
.bottom-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,3vw,24px)}
.card h3{font-size:14px;color:var(--text-secondary);margin-bottom:16px}
.card.calendar-card{grid-column:1/-1}
.summary-list{display:flex;flex-direction:column;gap:12px}
.summary-item{display:flex;justify-content:space-between;gap:8px}
.summary-label{font-size:13px;color:var(--text-secondary);flex-shrink:0}
.summary-value{font-family:var(--font-mono);font-size:13px;font-weight:600;text-align:right;word-break:break-word}
.upcoming-list{display:flex;flex-direction:column;gap:10px}
.upcoming-item{display:flex;align-items:center;padding:12px;background:var(--bg-tertiary);border-radius:var(--radius-md);gap:10px}
.upcoming-info{flex:1;min-width:0;overflow:hidden}
.upcoming-name{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
.upcoming-date{font-size:12px;color:var(--text-muted)}
.upcoming-amount{font-family:var(--font-mono);font-size:14px;color:var(--orange);font-weight:600;flex-shrink:0}
.savings-summary{display:flex;flex-direction:column;gap:12px}
.savings-total{display:flex;justify-content:space-between;padding-bottom:12px;border-bottom:1px solid var(--border)}
.savings-label{font-size:13px;color:var(--text-secondary)}
.savings-value{font-family:var(--font-mono);font-size:18px;font-weight:700;color:var(--blue)}
.savings-accounts{display:flex;flex-direction:column;gap:8px}
.savings-account-mini{display:flex;justify-content:space-between;font-size:13px;gap:8px}
.savings-account-mini span:first-child{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.savings-account-mini span:last-child{font-family:var(--font-mono);color:var(--text-secondary);flex-shrink:0}
.calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.calendar-nav{display:flex;gap:8px;align-items:center}
.calendar-nav button{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);width:32px;height:32px;color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center}
.calendar-nav button:hover{background:var(--bg-hover)}
.calendar-title{font-size:15px;font-weight:600;min-width:140px;text-align:center}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.calendar-day-header{text-align:center;font-size:11px;color:var(--text-muted);padding:8px 0;font-weight:600}
.calendar-day{aspect-ratio:1;background:var(--bg-tertiary);border-radius:var(--radius-sm);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:13px;cursor:pointer;position:relative;min-height:50px;padding:4px}
.calendar-day:hover{background:var(--bg-hover)}
.calendar-day.other-month{opacity:.3}
.calendar-day.today{border:2px solid var(--accent)}
.calendar-day .day-num{font-weight:500;margin-bottom:2px}
.calendar-day .day-dots{display:flex;gap:2px;position:absolute;bottom:6px}
.calendar-day .dot{width:5px;height:5px;border-radius:50%}
.calendar-day .dot.green{background:var(--green)}
.calendar-day .dot.red{background:var(--red)}
.calendar-day .dot.orange{background:var(--orange)}
.calendar-day-detail{margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:var(--radius-md);display:none}
.calendar-day-detail.active{display:block}
.calendar-day-detail h4{font-size:14px;margin-bottom:12px;color:var(--text-secondary)}
.calendar-detail-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.calendar-detail-item:last-child{border-bottom:none}
.filters{display:flex;gap:12px;margin-bottom:20px}
.filters input,.filters select{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px 16px;color:var(--text-primary)}
.filters input{flex:1}
.filters input::placeholder{color:var(--text-muted)}
.list-container{display:flex;flex-direction:column;gap:8px}
.list-item{display:flex;align-items:center;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;gap:12px}
.list-item-icon{width:44px;height:44px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.list-item-icon.green{background:var(--green-dim)}
.list-item-icon.red{background:var(--red-dim)}
.list-item-icon.orange{background:var(--orange-dim)}
.list-item-icon.blue{background:var(--blue-dim)}
.list-item-info{flex:1;min-width:0}
.list-item-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.list-item-subtitle{font-size:12px;color:var(--text-muted);margin-top:2px}
.list-item-amount{font-family:var(--font-mono);font-size:15px;font-weight:600;flex-shrink:0}
.list-item-amount.green{color:var(--green)}
.list-item-amount.red{color:var(--red)}
.list-item-amount.orange{color:var(--orange)}
.list-item-amount.blue{color:var(--blue)}
.list-item-actions{display:flex;gap:6px;flex-shrink:0}
.empty-state{text-align:center;padding:40px;color:var(--text-muted)}
.abonnements-summary{display:flex;gap:24px;margin-bottom:24px;padding:20px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);flex-wrap:wrap}
.abo-stat{display:flex;align-items:baseline;gap:6px}
.abo-stat-value{font-family:var(--font-mono);font-size:clamp(24px,5vw,32px);font-weight:700;color:var(--orange)}
.abo-stat-label{font-size:14px;color:var(--text-muted)}
.epargne-total{display:flex;justify-content:space-between;align-items:center;padding:24px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:24px;flex-wrap:wrap;gap:12px}
.epargne-total-label{font-size:16px;color:var(--text-secondary)}
.epargne-total-value{font-family:var(--font-mono);font-size:clamp(28px,6vw,40px);font-weight:700;color:var(--blue)}
.epargne-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.epargne-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px}
.epargne-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;gap:12px}
.epargne-card-name{font-size:16px;font-weight:600}
.epargne-card-type{font-size:11px;color:var(--text-muted);text-transform:uppercase;padding:4px 8px;background:var(--bg-tertiary);border-radius:var(--radius-sm);flex-shrink:0}
.epargne-card-amount{font-family:var(--font-mono);font-size:clamp(24px,5vw,32px);font-weight:700;color:var(--blue);margin-bottom:16px}
.epargne-progress-container{margin-bottom:16px}
.epargne-progress-header{display:flex;justify-content:space-between;font-size:12px;color:var(--text-secondary);margin-bottom:8px}
.epargne-progress-bar{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden}
.epargne-progress-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--green));border-radius:4px;transition:width .5s ease}
.epargne-card-footer{display:flex;justify-content:flex-end;padding-top:12px;border-top:1px solid var(--border)}
.epargne-card-actions{display:flex;gap:6px}
.epargne-no-goal{font-size:12px;color:var(--text-muted);font-style:italic;margin-bottom:16px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;padding:16px}
.modal-overlay.active{opacity:1;visibility:visible}
.modal{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);width:100%;max-width:480px;max-height:calc(100vh - 32px);overflow:hidden;display:flex;flex-direction:column;transform:scale(.95) translateY(20px)}
.modal-overlay.active .modal{transform:scale(1) translateY(0)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border)}
.modal-header h2{font-size:18px;font-weight:600}
.modal-close{background:0 0;border:none;color:var(--text-secondary);font-size:28px;cursor:pointer}
.modal-body{padding:20px;display:flex;flex-direction:column;gap:16px;overflow-y:auto}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.modal-footer{display:flex;gap:12px;padding:20px;border-top:1px solid var(--border)}
.modal-footer button{flex:1}
.settings-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);padding:clamp(16px,4vw,24px);margin-bottom:16px}
.settings-card h3{font-size:16px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.settings-card.danger{border-color:var(--red-dim)}
.settings-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);gap:16px}
.settings-row:last-child{border-bottom:none}
.settings-row>div:first-child{flex:1}
.settings-row label{font-size:14px;font-weight:500}
.settings-row select,.settings-row input{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 14px;color:var(--text-primary);min-width:140px}
.settings-hint{font-size:12px;color:var(--text-muted);margin-top:2px}
.account-box{background:var(--bg-tertiary);border-radius:var(--radius-md);padding:16px;margin-bottom:16px}
.account-row{display:flex;justify-content:space-between;padding:10px 0;font-size:13px;border-bottom:1px solid var(--border)}
.account-row:last-child{border-bottom:none}
.account-label{color:var(--text-secondary)}
.account-value{font-family:var(--font-mono);font-weight:500}
.toggle-switch{position:relative;width:52px;height:30px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;inset:0;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:30px}
.toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:var(--text-secondary);border-radius:50%;transition:.3s}
.toggle-switch input:checked+.toggle-slider{background:var(--accent);border-color:var(--accent)}
.toggle-switch input:checked+.toggle-slider:before{transform:translateX(22px);background:#fff}
.tags-container{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
.tag{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:var(--bg-tertiary);border-radius:20px;font-size:13px}
.tag-remove{background:0 0;border:none;color:var(--text-muted);cursor:pointer;font-size:16px}
.tag-remove:hover{color:var(--red)}
.add-tag-row{display:flex;gap:8px}
.add-tag-row input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px 12px;color:var(--text-primary)}
.toast{position:fixed;bottom:calc(24px + var(--safe-bottom));left:50%;transform:translateX(-50%) translateY(100px);background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px 24px;font-size:14px;font-weight:500;z-index:2000;opacity:0}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.success{border-color:var(--green);color:var(--green)}
.toast.error{border-color:var(--red);color:var(--red)}
.fab-container{display:none;position:fixed;bottom:calc(24px + var(--safe-bottom));right:20px;z-index:80;flex-direction:column;align-items:flex-end;gap:12px}
.fab-menu{display:flex;flex-direction:column;gap:8px;opacity:0;visibility:hidden;transform:translateY(20px);transition:all .2s}
.fab-container.open .fab-menu{opacity:1;visibility:visible;transform:translateY(0)}
.fab-menu-item{display:flex;align-items:center;gap:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px 16px;color:var(--text-primary);font-size:14px;font-weight:500;cursor:pointer;white-space:nowrap}
.fab-menu-item:hover{background:var(--bg-hover)}
.fab-menu-item .fab-icon{width:24px;text-align:center}
.fab-main{width:56px;height:56px;border-radius:50%;background:var(--accent);border:none;color:#fff;font-size:28px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;transition:transform .2s}
.fab-main:hover{transform:scale(1.05)}
.fab-container.open .fab-main{transform:rotate(45deg)}
.offline-banner{display:none;background:var(--orange-dim);border:1px solid var(--orange);color:var(--orange);padding:8px 16px;text-align:center;font-size:13px;font-weight:500}
.offline-banner.show{display:block}
@media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}.bottom-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:1024px){.charts-grid{grid-template-columns:1fr}}
@media(max-width:768px){
.sidebar{transform:translateX(-100%);width:280px;transition:transform .3s}
.sidebar.open{transform:translateX(0)}
.mobile-header{display:flex}
.main-content{margin-left:0;padding:calc(76px + var(--safe-top)) 16px calc(100px + var(--safe-bottom))}
.section-header{flex-direction:column}
.section-header .btn-primary{display:none}
.period-selector{width:100%}
.period-selector select{flex:1}
.stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}
.stat-card{padding:14px}
.stat-value{font-size:clamp(16px,4vw,20px)}
.charts-grid{gap:12px}
.bottom-grid{grid-template-columns:1fr}
.filters{flex-direction:column}
.list-item{padding:14px}
.abonnements-summary{flex-direction:column;gap:12px}
.epargne-total{flex-direction:column;text-align:center}
.epargne-grid{grid-template-columns:1fr}
.modal{max-height:calc(100vh - 20px);border-radius:var(--radius-lg) var(--radius-lg) 0 0;margin-top:auto}
.form-row{grid-template-columns:1fr}
.settings-row{flex-direction:column;align-items:stretch;gap:10px}
.settings-row select,.settings-row input{width:100%}
.add-tag-row{flex-direction:column}
.fab-container{display:flex}
.calendar-day{min-height:40px}
.calendar-day .day-num{font-size:12px}
}
@media(max-width:380px){.stats-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="offline-banner" id="offlineBanner">üì° Mode hors-ligne ‚Äî Les modifications seront synchronis√©es au retour</div>
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-logo"><span class="logo-icon">‚óâ</span><h1>Th√©.OS Finance</h1><p>G√©rez vos finances simplement</p></div>
            <div class="auth-tabs"><button class="auth-tab active" onclick="showTab('login')">Connexion</button><button class="auth-tab" onclick="showTab('register')">Inscription</button></div>
            <div class="auth-error" id="authError"></div>
            <div class="auth-loading" id="authLoading"><div class="spinner"></div><span>Connexion...</span></div>
            <form class="auth-form active" id="loginForm" onsubmit="doLogin(event)">
                <div class="form-group"><label>Identifiant</label><input type="text" id="loginUser" placeholder="Votre identifiant" required autocomplete="username"></div>
                <div class="form-group"><label>Mot de passe</label><input type="password" id="loginPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password"></div>
                <button type="submit" class="btn-primary">Se connecter</button>
            </form>
            <form class="auth-form" id="registerForm" onsubmit="doRegister(event)">
                <div class="form-group"><label>Identifiant</label><input type="text" id="regUser" placeholder="Choisissez un identifiant" required minlength="3" autocomplete="username"></div>
                <div class="form-group"><label>Mot de passe</label><input type="password" id="regPwd" placeholder="Minimum 6 caract√®res" required minlength="6" autocomplete="new-password"></div>
                <div class="form-group"><label>Confirmer</label><input type="password" id="regPwdC" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password"></div>
                <button type="submit" class="btn-primary">Cr√©er mon compte</button>
            </form>
        </div>
    </div>
    <div class="app" id="app">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        <nav class="sidebar" id="sidebar">
            <div class="logo"><span class="logo-icon">‚óâ</span><span class="logo-text">Th√©.OS Finance</span></div>
            <div class="user-info"><div class="user-name" id="userName">Utilisateur</div><div class="user-status" id="syncStatus">‚úì Synchronis√©</div></div>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-section="dashboard"><span class="nav-icon">‚ó´</span> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="revenus"><span class="nav-icon">‚Üë</span> Revenus</a></li>
                <li><a href="#" class="nav-link" data-section="depenses"><span class="nav-icon">‚Üì</span> D√©penses</a></li>
                <li><a href="#" class="nav-link" data-section="abonnements"><span class="nav-icon">‚Üª</span> Abonnements</a></li>
                <li><a href="#" class="nav-link" data-section="epargne"><span class="nav-icon">‚óà</span> √âpargne</a></li>
                <li><a href="#" class="nav-link" data-section="settings"><span class="nav-icon">‚öô</span> R√©glages</a></li>
            </ul>
            <div class="sidebar-footer"><button class="btn-logout" onclick="logout()">‚èª D√©connexion</button></div>
        </nav>
        <header class="mobile-header"><button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button><span class="mobile-title">Th√©.OS Finance</span><span style="width:40px"></span></header>
        <main class="main-content">
            <section id="dashboard" class="section active">
                <div class="section-header"><div><h1>Dashboard</h1><p class="today-date" id="todayDate"></p></div><div class="period-selector"><select id="periodType" onchange="updateDashboard()"><option value="month">Mois</option><option value="year">Ann√©e</option><option value="all">Tout</option></select><select id="periodMonth" onchange="updateDashboard()"></select><select id="periodYear" onchange="updateDashboard()"></select></div></div>
                <div class="stats-grid"><div class="stat-card stat-revenus"><div class="stat-label">Revenus</div><div class="stat-value" id="statRev">0 ‚Ç¨</div><div class="stat-detail" id="statRevD">0 entr√©es</div></div><div class="stat-card stat-depenses"><div class="stat-label">D√©penses</div><div class="stat-value" id="statDep">0 ‚Ç¨</div><div class="stat-detail" id="statDepD">0 entr√©es</div></div><div class="stat-card stat-net"><div class="stat-label">Net</div><div class="stat-value" id="statNet">0 ‚Ç¨</div><div class="stat-detail" id="statNetD">‚Äî</div></div><div class="stat-card stat-abonnements"><div class="stat-label">Abonnements</div><div class="stat-value" id="statAbo">0 ‚Ç¨</div><div class="stat-detail" id="statAboD">0 actifs</div></div></div>
                <div class="charts-grid"><div class="chart-card"><h3>D√©penses par cat√©gorie</h3><div class="chart-container"><canvas id="chartDep"></canvas></div><div id="legDep" class="chart-legend"></div></div><div class="chart-card"><h3>Revenus par cat√©gorie</h3><div class="chart-container"><canvas id="chartRev"></canvas></div><div id="legRev" class="chart-legend"></div></div></div>
                <div class="bottom-grid">
                    <div class="card"><h3>R√©sum√©</h3><div class="summary-list"><div class="summary-item"><span class="summary-label">Top d√©pense</span><span class="summary-value" id="sumTopD">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top revenu</span><span class="summary-value" id="sumTopR">‚Äî</span></div><div class="summary-item"><span class="summary-label">Moyenne d√©p.</span><span class="summary-value" id="sumAvg">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top cat√©gorie</span><span class="summary-value" id="sumCat">‚Äî</span></div></div></div>
                    <div class="card"><h3>Prochains pr√©l√®vements</h3><div class="upcoming-list" id="upList"><div class="empty-state">Aucun</div></div></div>
                    <div class="card"><h3>√âpargne</h3><div class="savings-summary"><div class="savings-total"><span class="savings-label">Total</span><span class="savings-value" id="savTot">0 ‚Ç¨</span></div><div class="savings-accounts" id="savList"></div></div></div>
                    <div class="card calendar-card">
                        <div class="calendar-header"><h3>üìÖ Calendrier</h3><div class="calendar-nav"><button onclick="calNav(-1)">‚Äπ</button><span class="calendar-title" id="calTitle">Janvier 2025</span><button onclick="calNav(1)">‚Ä∫</button></div></div>
                        <div class="calendar-grid" id="calGrid"></div>
                        <div class="calendar-day-detail" id="calDetail"><h4 id="calDetailTitle">‚Äî</h4><div id="calDetailList"></div></div>
                    </div>
                </div>
            </section>
            <section id="revenus" class="section"><div class="section-header"><h1>Revenus</h1><button class="btn-primary" onclick="openModal('revenu')">+ Ajouter</button></div><div class="filters"><input type="text" id="fRev" placeholder="Rechercher..." oninput="filter('revenus')"><select id="fRevC" onchange="filter('revenus')"><option value="">Toutes cat√©gories</option></select></div><div class="list-container" id="lRev"></div></section>
            <section id="depenses" class="section"><div class="section-header"><h1>D√©penses</h1><button class="btn-primary" onclick="openModal('depense')">+ Ajouter</button></div><div class="filters"><input type="text" id="fDep" placeholder="Rechercher..." oninput="filter('depenses')"><select id="fDepC" onchange="filter('depenses')"><option value="">Toutes cat√©gories</option></select></div><div class="list-container" id="lDep"></div></section>
            <section id="abonnements" class="section"><div class="section-header"><h1>Abonnements</h1><button class="btn-primary" onclick="openModal('abonnement')">+ Ajouter</button></div><div class="abonnements-summary"><div class="abo-stat"><span class="abo-stat-value" id="aboM">0 ‚Ç¨</span><span class="abo-stat-label">/ mois</span></div><div class="abo-stat"><span class="abo-stat-value" id="aboY">0 ‚Ç¨</span><span class="abo-stat-label">/ an</span></div></div><div class="list-container" id="lAbo"></div></section>
            <section id="epargne" class="section"><div class="section-header"><h1>√âpargne</h1><button class="btn-primary" onclick="openModal('epargne')">+ Compte</button></div><div class="epargne-total"><span class="epargne-total-label">Total √©pargn√©</span><span class="epargne-total-value" id="epTot">0 ‚Ç¨</span></div><div class="epargne-grid" id="epGrid"></div></section>
            <section id="settings" class="section">
                <div class="section-header"><h1>R√©glages</h1></div>
                <div class="settings-card"><h3>üë§ Mon compte</h3><div class="account-box"><div class="account-row"><span class="account-label">Identifiant</span><span class="account-value" id="accU">‚Äî</span></div><div class="account-row"><span class="account-label">Cr√©√© le</span><span class="account-value" id="accC">‚Äî</span></div></div></div>
                <div class="settings-card"><h3>üîê S√©curit√©</h3><div class="settings-row"><div><label>Changer mot de passe</label></div><button class="btn-secondary" onclick="openPwdModal()">Modifier</button></div><div class="settings-row"><div><label>Masquer les montants</label><p class="settings-hint">Floute les valeurs</p></div><label class="toggle-switch"><input type="checkbox" id="sHide" onchange="tog('hideAmounts',this.checked)"><span class="toggle-slider"></span></label></div></div>
                <div class="settings-card"><h3>üé® Apparence</h3><div class="settings-row"><div><label>Th√®me</label></div><select id="sTheme" onchange="setTheme(this.value)"><option value="dark">üåô Sombre</option><option value="light">‚òÄÔ∏è Clair</option><option value="auto">üåì Auto</option></select></div><div class="settings-row"><div><label>Couleur d'accent</label></div><select id="sAccent" onchange="setAccent(this.value)"><option value="#ff3b30">üî¥ Rouge</option><option value="#ff9500">üü† Orange</option><option value="#34c759">üü¢ Vert</option><option value="#007aff">üîµ Bleu</option><option value="#af52de">üü£ Violet</option></select></div></div>
                <div class="settings-card"><h3>üí∞ Format</h3><div class="settings-row"><div><label>Devise</label></div><select id="sCur" onchange="sav('currency',this.value);refresh()"><option value="EUR">‚Ç¨ Euro</option><option value="USD">$ Dollar</option><option value="GBP">¬£ Livre</option></select></div><div class="settings-row"><div><label>Afficher centimes</label></div><label class="toggle-switch"><input type="checkbox" id="sCents" checked onchange="tog('showCents',this.checked);refresh()"><span class="toggle-slider"></span></label></div></div>
                <div class="settings-card"><h3>üè∑Ô∏è Cat√©gories</h3><div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Revenus</label><div class="tags-container" id="tRev"></div><div class="add-tag-row"><input type="text" id="nRev" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('revenus')">+</button></div></div><div class="settings-row" style="flex-direction:column;align-items:stretch"><label>D√©penses</label><div class="tags-container" id="tDep"></div><div class="add-tag-row"><input type="text" id="nDep" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('depenses')">+</button></div></div><div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Abonnements</label><div class="tags-container" id="tAbo"></div><div class="add-tag-row"><input type="text" id="nAbo" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('abonnements')">+</button></div></div></div>
                <div class="settings-card"><h3>üíæ Export</h3><div class="settings-row"><div><label>Export JSON</label></div><button class="btn-secondary" onclick="expJSON()">T√©l√©charger</button></div><div class="settings-row"><div><label>Export Excel</label></div><button class="btn-secondary" onclick="expXLS()">T√©l√©charger</button></div></div>
                <div class="settings-card danger"><h3>‚ö†Ô∏è Zone danger</h3><div class="settings-row"><div><label>Effacer mes donn√©es</label><p class="settings-hint">Conserve le compte</p></div><button class="btn-danger" onclick="clearData()">Effacer</button></div><div class="settings-row"><div><label>Supprimer mon compte</label></div><button class="btn-danger" onclick="delAccount()">Supprimer</button></div></div>
            </section>
        </main>
        <div class="fab-container" id="fab">
            <div class="fab-menu">
                <button class="fab-menu-item" onclick="openModal('revenu');closeFab()"><span class="fab-icon">‚Üë</span> Revenu</button>
                <button class="fab-menu-item" onclick="openModal('depense');closeFab()"><span class="fab-icon">‚Üì</span> D√©pense</button>
                <button class="fab-menu-item" onclick="openModal('abonnement');closeFab()"><span class="fab-icon">‚Üª</span> Abonnement</button>
            </div>
            <button class="fab-main" onclick="toggleFab()">+</button>
        </div>
    </div>
    <div class="modal-overlay" id="modalO" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-header"><h2 id="modalT">Ajouter</h2><button class="modal-close" onclick="closeModal()">√ó</button></div><form id="modalF" onsubmit="submitForm(event)"><div class="modal-body" id="modalB"></div><div class="modal-footer" id="modalFoot"><button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button><button type="submit" class="btn-primary">Enregistrer</button></div></form></div></div>
    <div class="toast" id="toast"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
a,b)=>new Date(b.date)-new Date(a.date));c.innerHTML=items.length?items.map(i=>'<div class="list-item"><div class="list-item-icon red">‚Üì</div><div class="list-item-info"><span class="list-item-title">'+i.description+'</span><span class="list-item-subtitle">'+fmtD(i.date)+' ‚Ä¢ '+i.categorie+'</span></div><span class="list-item-amount red'+(settings.hideAmounts?' hidden-amount':'')+'">-'+fmt(i.montant)+'</span><div class="list-item-actions"><button class="btn-icon" onclick="duplicate(\'depenses\',\''+i.id+'\')" title="Dupliquer">‚ßâ</button><button class="btn-icon" onclick="edit(\'depense\',\''+i.id+'\')">‚úé</button><button class="btn-icon delete" onclick="del(\'depenses\',\''+i.id+'\')">√ó</button></div></div>').join(''):'<div class="empty-state">Aucune d√©pense</div>'}
function renderAbo(){const c=document.getElementById('lAbo');const abos=data.abonnements||[];const tmMonth=abos.reduce((s,a)=>s+(a.frequence==='annuel'?a.montant/12:a.montant),0);const tmYear=abos.reduce((s,a)=>s+(a.frequence==='annuel'?a.montant:a.montant*12),0);document.getElementById('aboM').textContent=fmt(tmMonth);document.getElementById('aboY').textContent=fmt(tmYear);c.innerHTML=abos.length?abos.map(i=>{const dateObj=new Date(i.datePrelevement);const jour=dateObj.getDate();const freqLabel=i.frequence==='annuel'?'Le '+fmtD(i.datePrelevement)+' (annuel)':'Le '+jour+' de chaque mois';return'<div class="list-item"><div class="list-item-icon orange">‚Üª</div><div class="list-item-info"><span class="list-item-title">'+i.description+'</span><span class="list-item-subtitle">'+freqLabel+' ‚Ä¢ '+i.categorie+'</span></div><span class="list-item-amount orange'+(settings.hideAmounts?' hidden-amount':'')+'">'+fmt(i.montant)+(i.frequence==='annuel'?'/an':'/mois')+'</span><div class="list-item-actions"><button class="btn-icon" onclick="duplicate(\'abonnements\',\''+i.id+'\')" title="Dupliquer">‚ßâ</button><button class="btn-icon" onclick="edit(\'abonnement\',\''+i.id+'\')">‚úé</button><button class="btn-icon delete" onclick="del(\'abonnements\',\''+i.id+'\')">√ó</button></div></div>'}).join(''):'<div class="empty-state">Aucun abonnement</div>'}
function renderEp(){const c=document.getElementById('epGrid');const t=(data.epargne||[]).reduce((s,x)=>s+x.solde,0);document.getElementById('epTot').textContent=fmt(t);c.innerHTML=data.epargne&&data.epargne.length?data.epargne.map(x=>{const hasGoal=x.objectif&&x.objectif>0;const progress=hasGoal?Math.min(100,Math.round(x.solde/x.objectif*100)):0;const progressHtml=hasGoal?'<div class="epargne-progress-container"><div class="epargne-progress-header"><span>Objectif: '+fmt(x.objectif)+'</span><span>'+progress+'%</span></div><div class="epargne-progress-bar"><div class="epargne-progress-fill" style="width:'+progress+'%"></div></div></div>':'<div class="epargne-no-goal">Aucun objectif d√©fini</div>';return'<div class="epargne-card"><div class="epargne-card-header"><span class="epargne-card-name">'+x.nom+'</span><span class="epargne-card-type">'+x.type+'</span></div><div class="epargne-card-amount'+(settings.hideAmounts?' hidden-amount':'')+'">'+fmt(x.solde)+'</div>'+progressHtml+'<div class="epargne-card-footer"><div class="epargne-card-actions"><button class="btn-icon" onclick="openModal(\'ajustement\',\''+x.id+'\')" title="Ajuster">‚Üï</button><button class="btn-icon" onclick="edit(\'epargne\',\''+x.id+'\')">‚úé</button><button class="btn-icon delete" onclick="del(\'epargne\',\''+x.id+'\')">√ó</button></div></div></div>'}).join(''):'<div class="empty-state">Aucun compte</div>'}
function updateFilters(){document.getElementById('fRevC').innerHTML='<option value="">Toutes</option>'+(data.categories.revenus||[]).map(c=>'<option>'+c+'</option>').join('');document.getElementById('fDepC').innerHTML='<option value="">Toutes</option>'+(data.categories.depenses||[]).map(c=>'<option>'+c+'</option>').join('')}
function filter(t){const m={revenus:['fRev','fRevC','lRev'],depenses:['fDep','fDepC','lDep']};const[fId,catId,listId]=m[t],s=document.getElementById(fId).value.toLowerCase(),cat=document.getElementById(catId).value;document.querySelectorAll('#'+listId+' .list-item').forEach(i=>{const ti=i.querySelector('.list-item-title').textContent.toLowerCase(),su=i.querySelector('.list-item-subtitle').textContent;i.style.display=ti.includes(s)&&(!cat||su.includes(cat))?'flex':'none'})}

function duplicate(col,id){const item=data[col].find(x=>x.id===id);if(!item)return;const newItem={...item,id:genId(),date:new Date().toISOString().split('T')[0]};data[col].push(newItem);scheduleSync();renderAll();updateDashboard();renderCalendar();toast('Dupliqu√© !')}

let editId=null,editType=null;
function openModal(type,id){editType=type;editId=id||null;const title=document.getElementById('modalT'),body=document.getElementById('modalB');document.getElementById('modalFoot').style.display='flex';document.getElementById('modalF').onsubmit=submitForm;let html='';
if(type==='revenu'){const r=id?(data.revenus||[]).find(x=>x.id===id):null;title.textContent=id?'Modifier revenu':'Ajouter revenu';html='<div class="form-group"><label>Description</label><input name="description" required value="'+(r?.description||'')+'" placeholder="Ex: Salaire"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="'+(r?.montant||'')+'" placeholder="0"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="'+(r?.date||new Date().toISOString().split('T')[0])+'"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">'+(data.categories.revenus||[]).map(c=>'<option'+(r?.categorie===c?' selected':'')+'>'+c+'</option>').join('')+'</select></div>'}
else if(type==='depense'){const d=id?(data.depenses||[]).find(x=>x.id===id):null;title.textContent=id?'Modifier d√©pense':'Ajouter d√©pense';html='<div class="form-group"><label>Description</label><input name="description" required value="'+(d?.description||'')+'" placeholder="Ex: Courses"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="'+(d?.montant||'')+'" placeholder="0"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="'+(d?.date||new Date().toISOString().split('T')[0])+'"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">'+(data.categories.depenses||[]).map(c=>'<option'+(d?.categorie===c?' selected':'')+'>'+c+'</option>').join('')+'</select></div>'}
else if(type==='abonnement'){const a=id?(data.abonnements||[]).find(x=>x.id===id):null;const defaultDate=a?.datePrelevement||new Date().toISOString().split('T')[0];const freq=a?.frequence||'mensuel';title.textContent=id?'Modifier abonnement':'Ajouter abonnement';html='<div class="form-group"><label>Description</label><input name="description" required value="'+(a?.description||'')+'" placeholder="Ex: Netflix"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="'+(a?.montant||'')+'" placeholder="0"></div><div class="form-group"><label>Fr√©quence</label><select name="frequence"><option value="mensuel"'+(freq==='mensuel'?' selected':'')+'>Mensuel</option><option value="annuel"'+(freq==='annuel'?' selected':'')+'>Annuel</option></select></div></div><div class="form-group"><label>Date de pr√©l√®vement</label><input type="date" name="datePrelevement" required value="'+defaultDate+'"><p class="settings-hint">Pour les mensuels, seul le jour sera utilis√©</p></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">'+(data.categories.abonnements||[]).map(c=>'<option'+(a?.categorie===c?' selected':'')+'>'+c+'</option>').join('')+'</select></div>'}
else if(type==='epargne'){const e=id?(data.epargne||[]).find(x=>x.id===id):null;title.textContent=id?'Modifier compte':'Nouveau compte';html='<div class="form-group"><label>Nom du compte</label><input name="nom" required value="'+(e?.nom||'')+'" placeholder="Ex: Livret A"></div><div class="form-row"><div class="form-group"><label>Type</label><select name="type">'+(data.categories.epargne||[]).map(c=>'<option'+(e?.type===c?' selected':'')+'>'+c+'</option>').join('')+'</select></div><div class="form-group"><label>Solde actuel</label><input type="number" name="solde" step="0.01" required value="'+(e?.solde||'')+'" placeholder="0"></div></div><div class="form-group"><label>Objectif (optionnel)</label><input type="number" name="objectif" step="0.01" value="'+(e?.objectif||'')+'" placeholder="Ex: 10000"></div>'}
else if(type==='ajustement'){const e=(data.epargne||[]).find(x=>x.id===id);title.textContent='Ajuster le solde';html='<div class="form-group"><label>Compte</label><input type="text" value="'+(e?.nom||'')+'" disabled></div><div class="form-group"><label>Solde actuel</label><input type="text" value="'+fmt(e?.solde||0)+'" disabled></div><div class="form-group"><label>Nouveau solde</label><input type="number" name="nouveauSolde" step="0.01" required value="'+(e?.solde||0)+'" placeholder="0"></div>'}
body.innerHTML=html;document.getElementById('modalO').classList.add('active')}
function closeModal(){document.getElementById('modalO').classList.remove('active');editId=null;editType=null}
function submitForm(e){e.preventDefault();const fd=new FormData(e.target),entry=Object.fromEntries(fd.entries());if(entry.montant)entry.montant=parseFloat(entry.montant);if(entry.solde)entry.solde=parseFloat(entry.solde);if(entry.objectif)entry.objectif=entry.objectif?parseFloat(entry.objectif):null;if(entry.nouveauSolde)entry.nouveauSolde=parseFloat(entry.nouveauSolde);
if(editType==='revenu'){if(editId){const i=data.revenus.findIndex(x=>x.id===editId);data.revenus[i]={...data.revenus[i],...entry}}else{entry.id=genId();data.revenus.push(entry)}renderRev()}
else if(editType==='depense'){if(editId){const i=data.depenses.findIndex(x=>x.id===editId);data.depenses[i]={...data.depenses[i],...entry}}else{entry.id=genId();data.depenses.push(entry)}renderDep()}
else if(editType==='abonnement'){if(editId){const i=data.abonnements.findIndex(x=>x.id===editId);data.abonnements[i]={...data.abonnements[i],...entry}}else{entry.id=genId();data.abonnements.push(entry)}renderAbo()}
else if(editType==='epargne'){if(editId){const i=data.epargne.findIndex(x=>x.id===editId);data.epargne[i]={...data.epargne[i],...entry}}else{entry.id=genId();data.epargne.push(entry)}renderEp()}
else if(editType==='ajustement'){const i=data.epargne.findIndex(x=>x.id===editId);if(i>=0)data.epargne[i].solde=entry.nouveauSolde;renderEp()}
scheduleSync();updateDashboard();renderCalendar();closeModal();toast('Enregistr√© !')}
function edit(t,id){openModal(t,id)}
function del(col,id){if(confirm('Supprimer ?')){data[col]=data[col].filter(x=>x.id!==id);scheduleSync();renderAll();updateDashboard();renderCalendar();toast('Supprim√©')}}
function expJSON(){const b=new Blob([JSON.stringify({data,settings},null,2)],{type:'application/json'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='theos-'+new Date().toISOString().split('T')[0]+'.json';a.click();toast('Export√©')}
function expXLS(){const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.revenus||[]).map(r=>({Description:r.description,Montant:r.montant,Date:r.date,Cat√©gorie:r.categorie}))),'Revenus');XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.depenses||[]).map(d=>({Description:d.description,Montant:d.montant,Date:d.date,Cat√©gorie:d.categorie}))),'D√©penses');XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.abonnements||[]).map(a=>({Description:a.description,Montant:a.montant,Fr√©quence:a.frequence,DatePrelevement:a.datePrelevement,Cat√©gorie:a.categorie}))),'Abonnements');XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet((data.epargne||[]).map(e=>({Nom:e.nom,Type:e.type,Solde:e.solde,Objectif:e.objectif||''}))),'√âpargne');XLSX.writeFile(wb,'theos-'+new Date().toISOString().split('T')[0]+'.xlsx');toast('Excel export√©')}

if('serviceWorker' in navigator){const sw=`const CACHE='theos-v2';self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>Promise.all(['https://cdn.jsdelivr.net/npm/chart.js','https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js'].map(u=>fetch(u).then(r=>c.put(u,r)).catch(()=>{})))).then(()=>self.skipWaiting())));self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(fetch(e.request).then(r=>{if(r.status===200){const cl=r.clone();caches.open(CACHE).then(c=>c.put(e.request,cl))}return r}).catch(()=>caches.match(e.request)))});`;navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'}))).catch(()=>{})}
</script>
</body>
</html>
