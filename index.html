<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Th√©.OS Finance</title>
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='none' stroke='%23ff3b30' stroke-width='8'/><circle cx='50' cy='50' r='12' fill='%23ff3b30'/></svg>">
    <style>
:root {
    --bg-primary: #0a0a0a;
    --bg-secondary: #111111;
    --bg-tertiary: #1a1a1a;
    --bg-hover: #222222;
    --border: #2a2a2a;
    --border-light: #333333;
    --text-primary: #ffffff;
    --text-secondary: #888888;
    --text-muted: #555555;
    --accent: #ff3b30;
    --accent-hover: #ff5147;
    --green: #34c759;
    --green-dim: rgba(52, 199, 89, 0.15);
    --red: #ff3b30;
    --red-dim: rgba(255, 59, 48, 0.15);
    --blue: #007aff;
    --blue-dim: rgba(0, 122, 255, 0.15);
    --orange: #ff9500;
    --orange-dim: rgba(255, 149, 0, 0.15);
    --purple: #af52de;
    --purple-dim: rgba(175, 82, 222, 0.15);
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --sidebar-width: 260px;
    --font-mono: 'SF Mono', 'Fira Code', monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-top: env(safe-area-inset-top, 0px);
}
[data-theme="light"] {
    --bg-primary: #f5f5f7;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e8e8ed;
    --bg-hover: #d1d1d6;
    --border: #d1d1d6;
    --border-light: #c7c7cc;
    --text-primary: #1d1d1f;
    --text-secondary: #6e6e73;
    --text-muted: #aeaeb2;
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { font-size: 16px; }
body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; overflow-x: hidden; min-height: 100vh; min-height: 100dvh; }
button, input, select, textarea { font-family: inherit; font-size: inherit; }
input, select { font-size: 16px !important; }

/* AUTH */
.auth-screen { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; padding-top: calc(20px + var(--safe-top)); }
.auth-container { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(24px, 6vw, 40px); width: 100%; max-width: 420px; max-height: calc(100vh - 40px); max-height: calc(100dvh - 40px); overflow-y: auto; }
.auth-logo { text-align: center; margin-bottom: 28px; }
.auth-logo .logo-icon { font-size: clamp(36px, 10vw, 48px); color: var(--accent); }
.auth-logo h1 { font-size: clamp(20px, 5vw, 24px); margin-top: 12px; font-weight: 600; }
.auth-logo p { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
.auth-tabs { display: flex; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
.auth-tab { flex: 1; padding: 12px 8px; background: none; border: none; color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s; }
.auth-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.auth-form { display: none; flex-direction: column; gap: 16px; }
.auth-form.active { display: flex; }
.auth-form .form-group { display: flex; flex-direction: column; gap: 6px; }
.auth-form label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.auth-form input { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 16px; color: var(--text-primary); font-size: 16px !important; width: 100%; }
.auth-form input:focus { outline: none; border-color: var(--accent); }
.auth-form .btn-primary { margin-top: 8px; padding: 16px; font-size: 16px; width: 100%; }
.auth-info { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 12px; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
.auth-info strong { color: var(--text-primary); }
.password-strength { height: 4px; background: var(--bg-tertiary); border-radius: 2px; margin-top: 6px; overflow: hidden; }
.password-strength-bar { height: 100%; transition: all 0.3s; border-radius: 2px; }
.strength-weak { width: 33%; background: var(--red); }
.strength-medium { width: 66%; background: var(--orange); }
.strength-strong { width: 100%; background: var(--green); }
.link-code-box { background: var(--bg-primary); border: 2px dashed var(--border); border-radius: var(--radius-md); padding: 20px; text-align: center; margin: 16px 0; }
.link-code { font-family: var(--font-mono); font-size: clamp(18px, 5vw, 24px); font-weight: 600; color: var(--accent); letter-spacing: 2px; word-break: break-all; }
.link-code-hint { font-size: 12px; color: var(--text-muted); margin-top: 8px; }

/* APP LAYOUT */
.app { display: none; min-height: 100vh; min-height: 100dvh; }
.app.active { display: flex; }

/* SIDEBAR */
.sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; opacity: 0; visibility: hidden; transition: all 0.3s; }
.sidebar-overlay.active { opacity: 1; visibility: visible; }
.logo { padding: 20px 24px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
.logo-icon { font-size: 24px; color: var(--accent); }
.logo-text { font-size: 17px; font-weight: 600; letter-spacing: -0.3px; }
.user-info { padding: 16px 24px; border-bottom: 1px solid var(--border); }
.user-name { font-size: 14px; font-weight: 600; }
.user-sync { font-size: 12px; color: var(--text-muted); margin-top: 2px; display: flex; align-items: center; gap: 4px; }
.user-sync.synced { color: var(--green); }
.nav-links { list-style: none; padding: 12px; flex: 1; overflow-y: auto; }
.nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 16px; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all 0.2s; margin-bottom: 4px; font-size: 14px; font-weight: 500; }
.nav-link:hover { background: var(--bg-hover); color: var(--text-primary); }
.nav-link.active { background: var(--bg-tertiary); color: var(--text-primary); }
.nav-icon { font-size: 18px; width: 24px; text-align: center; }
.sidebar-footer { padding: 16px; border-top: 1px solid var(--border); padding-bottom: calc(16px + var(--safe-bottom)); }
.btn-logout { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px 16px; background: var(--red-dim); border: none; border-radius: var(--radius-md); color: var(--red); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-logout:hover { background: var(--red); color: white; }

/* MOBILE HEADER */
.mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 60px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); align-items: center; padding: 0 16px; padding-top: var(--safe-top); z-index: 90; }
.menu-toggle { background: none; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer; padding: 8px; margin-left: -8px; }
.mobile-title { flex: 1; text-align: center; font-weight: 600; font-size: 17px; }
.mobile-sync { font-size: 18px; padding: 8px; margin-right: -8px; }

/* MAIN CONTENT */
.main-content { flex: 1; margin-left: var(--sidebar-width); padding: 32px; min-height: 100vh; min-height: 100dvh; }
.section { display: none; animation: fadeIn 0.3s ease; max-width: 1400px; margin: 0 auto; }
.section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* SECTION HEADER */
.section-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 28px; gap: 16px; flex-wrap: wrap; }
.section-header h1 { font-size: clamp(24px, 5vw, 32px); font-weight: 700; letter-spacing: -0.5px; }
.today-date { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
.section-subheader { display: flex; justify-content: space-between; align-items: center; margin: 32px 0 20px; gap: 12px; flex-wrap: wrap; }
.section-subheader h2 { font-size: 18px; font-weight: 600; color: var(--text-secondary); }

/* PERIOD SELECTOR */
.period-selector { display: flex; gap: 8px; flex-wrap: wrap; }
.period-selector select { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px 14px; color: var(--text-primary); font-size: 14px; cursor: pointer; min-width: 100px; }
.period-selector select:focus { outline: none; border-color: var(--accent); }

/* STATS GRID */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
.stat-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 3vw, 24px); transition: all 0.2s; }
.stat-card:hover { border-color: var(--border-light); }
.stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600; }
.stat-value { font-family: var(--font-mono); font-size: clamp(20px, 4vw, 28px); font-weight: 700; margin-bottom: 4px; line-height: 1.2; }
.stat-value.hidden-amount { filter: blur(8px); user-select: none; }
.stat-detail { font-size: 12px; color: var(--text-muted); }
.stat-revenus .stat-value { color: var(--green); }
.stat-depenses .stat-value { color: var(--red); }
.stat-net.positive .stat-value { color: var(--green); }
.stat-net.negative .stat-value { color: var(--red); }
.stat-abonnements .stat-value { color: var(--orange); }

/* CHARTS */
.charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 28px; }
.chart-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 3vw, 24px); }
.chart-card h3 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; }
.chart-container { height: clamp(160px, 25vw, 200px); position: relative; }
.chart-legend { display: flex; flex-wrap: wrap; gap: 8px 16px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* BOTTOM GRID */
.bottom-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 3vw, 24px); }
.card h3 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; }
.summary-list { display: flex; flex-direction: column; gap: 12px; }
.summary-item { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
.summary-label { font-size: 13px; color: var(--text-secondary); }
.summary-value { font-family: var(--font-mono); font-size: 13px; font-weight: 600; text-align: right; }
.upcoming-list { display: flex; flex-direction: column; gap: 10px; }
.upcoming-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md); gap: 12px; }
.upcoming-info { flex: 1; min-width: 0; }
.upcoming-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.upcoming-date { font-size: 12px; color: var(--text-muted); }
.upcoming-amount { font-family: var(--font-mono); font-size: 14px; color: var(--orange); font-weight: 600; flex-shrink: 0; }
.savings-summary { display: flex; flex-direction: column; gap: 12px; }
.savings-total { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
.savings-label { font-size: 13px; color: var(--text-secondary); }
.savings-value { font-family: var(--font-mono); font-size: 18px; font-weight: 700; color: var(--blue); }
.savings-accounts { display: flex; flex-direction: column; gap: 8px; }
.savings-account-mini { display: flex; justify-content: space-between; font-size: 13px; }
.savings-account-mini span:last-child { font-family: var(--font-mono); color: var(--text-secondary); }

/* BUTTONS */
.btn-primary { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:active { transform: scale(0.98); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn-secondary:hover { background: var(--bg-hover); border-color: var(--border-light); }
.btn-secondary:active { transform: scale(0.98); }
.btn-danger { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); padding: 12px 20px; border-radius: var(--radius-md); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-danger:hover { background: var(--red); color: white; }
.btn-icon { background: var(--bg-tertiary); border: none; width: 36px; height: 36px; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }
.btn-icon.delete:hover { background: var(--red-dim); color: var(--red); }

/* FILTERS */
.filters { display: flex; gap: 12px; margin-bottom: 20px; }
.filters input, .filters select { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px 16px; color: var(--text-primary); font-size: 14px; }
.filters input { flex: 1; min-width: 0; }
.filters input::placeholder { color: var(--text-muted); }
.filters input:focus, .filters select:focus { outline: none; border-color: var(--accent); }

/* LIST ITEMS */
.list-container { display: flex; flex-direction: column; gap: 8px; }
.list-item { display: flex; align-items: center; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; gap: 12px; transition: all 0.2s; }
.list-item:hover { border-color: var(--border-light); }
.list-item-icon { width: 44px; height: 44px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
.list-item-icon.green { background: var(--green-dim); }
.list-item-icon.red { background: var(--red-dim); }
.list-item-icon.orange { background: var(--orange-dim); }
.list-item-icon.blue { background: var(--blue-dim); }
.list-item-icon.purple { background: var(--purple-dim); }
.list-item-info { flex: 1; min-width: 0; }
.list-item-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-item-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.list-item-amount { font-family: var(--font-mono); font-size: 15px; font-weight: 600; flex-shrink: 0; }
.list-item-amount.green { color: var(--green); }
.list-item-amount.red { color: var(--red); }
.list-item-amount.orange { color: var(--orange); }
.list-item-amount.blue { color: var(--blue); }
.list-item-actions { display: flex; gap: 6px; flex-shrink: 0; }
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 14px; }

/* ABONNEMENTS */
.abonnements-summary { display: flex; gap: 24px; margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); flex-wrap: wrap; }
.abo-stat { display: flex; align-items: baseline; gap: 6px; }
.abo-stat-value { font-family: var(--font-mono); font-size: clamp(24px, 5vw, 32px); font-weight: 700; color: var(--orange); }
.abo-stat-label { font-size: 14px; color: var(--text-muted); }

/* EPARGNE */
.epargne-total { display: flex; justify-content: space-between; align-items: center; padding: 24px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
.epargne-total-label { font-size: 16px; color: var(--text-secondary); font-weight: 500; }
.epargne-total-value { font-family: var(--font-mono); font-size: clamp(28px, 6vw, 40px); font-weight: 700; color: var(--blue); }
.epargne-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 28px; }
.epargne-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; }
.epargne-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px; }
.epargne-card-name { font-size: 15px; font-weight: 600; }
.epargne-card-type { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: var(--radius-sm); }
.epargne-card-amount { font-family: var(--font-mono); font-size: clamp(22px, 5vw, 28px); font-weight: 700; color: var(--blue); margin-bottom: 12px; }
.epargne-card-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
.epargne-card-goal { font-size: 12px; color: var(--text-muted); }
.epargne-card-actions { display: flex; gap: 6px; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 16px; }
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); width: 100%; max-width: 480px; max-height: calc(100vh - 32px); max-height: calc(100dvh - 32px); overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95) translateY(20px); transition: transform 0.3s; }
.modal-overlay.active .modal { transform: scale(1) translateY(0); }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.modal-header h2 { font-size: 18px; font-weight: 600; }
.modal-close { background: none; border: none; color: var(--text-secondary); font-size: 28px; cursor: pointer; padding: 4px; line-height: 1; }
.modal-close:hover { color: var(--text-primary); }
.modal-body { padding: 20px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; flex: 1; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.form-group input, .form-group select { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 16px; color: var(--text-primary); font-size: 16px !important; width: 100%; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 20px; border-top: 1px solid var(--border); flex-shrink: 0; }
.modal-footer button { flex: 1; }

/* SETTINGS */
.settings-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: clamp(16px, 4vw, 24px); margin-bottom: 16px; }
.settings-card h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.settings-card.danger { border-color: var(--red-dim); }
.settings-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border); gap: 16px; }
.settings-row:last-child { border-bottom: none; }
.settings-row > div:first-child { flex: 1; min-width: 0; }
.settings-row label { font-size: 14px; font-weight: 500; display: block; }
.settings-row select, .settings-row input[type="number"] { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px 14px; color: var(--text-primary); font-size: 14px; min-width: 140px; }
.settings-row select:focus, .settings-row input:focus { outline: none; border-color: var(--accent); }
.settings-hint { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.settings-actions { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
.settings-about { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }
.account-box { background: var(--bg-tertiary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; }
.account-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 13px; border-bottom: 1px solid var(--border); }
.account-row:last-child { border-bottom: none; }
.account-label { color: var(--text-secondary); }
.account-value { font-family: var(--font-mono); font-weight: 500; }
.toggle-switch { position: relative; width: 52px; height: 30px; flex-shrink: 0; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--bg-tertiary); border: 1px solid var(--border); transition: 0.3s; border-radius: 30px; }
.toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background: var(--text-secondary); transition: 0.3s; border-radius: 50%; }
.toggle-switch input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
.toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); background: white; }
.tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
.tag { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 20px; font-size: 13px; }
.tag-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 0; line-height: 1; margin-left: 2px; }
.tag-remove:hover { color: var(--red); }
.add-tag-row { display: flex; gap: 8px; }
.add-tag-row input { flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px 12px; color: var(--text-primary); font-size: 14px; min-width: 0; }
.add-tag-row button { padding: 10px 16px; white-space: nowrap; }

/* TOAST */
.toast { position: fixed; bottom: calc(24px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 14px 24px; font-size: 14px; font-weight: 500; z-index: 2000; opacity: 0; transition: all 0.3s; white-space: nowrap; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--green); color: var(--green); }
.toast.error { border-color: var(--red); color: var(--red); }

/* RESPONSIVE - Tablet */
@media (max-width: 1200px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .bottom-grid { grid-template-columns: repeat(2, 1fr); }
    .bottom-grid .card:last-child { grid-column: span 2; }
}

@media (max-width: 1024px) {
    .charts-grid { grid-template-columns: 1fr; }
}

/* RESPONSIVE - Mobile */
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); width: 280px; }
    .sidebar.open { transform: translateX(0); }
    .mobile-header { display: flex; height: calc(60px + var(--safe-top)); padding-top: var(--safe-top); }
    .main-content { margin-left: 0; padding: calc(76px + var(--safe-top)) 16px calc(24px + var(--safe-bottom)); }
    
    .section-header { flex-direction: column; align-items: stretch; }
    .section-header .btn-primary { width: 100%; }
    .period-selector { width: 100%; }
    .period-selector select { flex: 1; }
    
    .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .stat-card { padding: 14px; }
    .stat-label { font-size: 11px; margin-bottom: 4px; }
    .stat-value { font-size: 20px; }
    .stat-detail { font-size: 11px; }
    
    .charts-grid { gap: 12px; }
    .chart-card { padding: 16px; }
    .chart-container { height: 180px; }
    
    .bottom-grid { grid-template-columns: 1fr; gap: 12px; }
    .bottom-grid .card:last-child { grid-column: span 1; }
    .card { padding: 16px; }
    
    .filters { flex-direction: column; gap: 10px; }
    .filters select { width: 100%; }
    
    .list-item { padding: 14px; }
    .list-item-icon { width: 40px; height: 40px; font-size: 18px; }
    .list-item-title { font-size: 14px; }
    .list-item-amount { font-size: 14px; }
    .list-item-actions { gap: 4px; }
    .btn-icon { width: 34px; height: 34px; }
    
    .abonnements-summary { flex-direction: column; gap: 12px; padding: 16px; }
    .epargne-total { flex-direction: column; text-align: center; padding: 20px; }
    .epargne-grid { grid-template-columns: 1fr; }
    .epargne-card { padding: 16px; }
    
    .modal { max-height: calc(100vh - 20px); max-height: calc(100dvh - 20px); border-radius: var(--radius-lg) var(--radius-lg) 0 0; margin-top: auto; }
    .modal-body { padding: 16px; }
    .modal-footer { padding: 16px; padding-bottom: calc(16px + var(--safe-bottom)); }
    .form-row { grid-template-columns: 1fr; }
    
    .settings-card { padding: 16px; }
    .settings-row { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 0; }
    .settings-row select, .settings-row input[type="number"] { width: 100%; min-width: auto; }
    .settings-actions { flex-direction: column; }
    .settings-actions button { width: 100%; }
    .add-tag-row { flex-direction: column; }
    .add-tag-row button { width: 100%; }
}

/* RESPONSIVE - Small Mobile */
@media (max-width: 380px) {
    .stats-grid { grid-template-columns: 1fr; }
    .stat-card { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; }
    .stat-card > div:first-child { display: flex; flex-direction: column; }
    .stat-value { font-size: 22px; text-align: right; margin-bottom: 0; }
    .stat-detail { display: none; }
    
    .list-item { flex-wrap: wrap; }
    .list-item-info { width: calc(100% - 56px); }
    .list-item-amount { margin-left: 56px; margin-top: -8px; }
    .list-item-actions { margin-left: auto; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

/* Safe areas for notch devices */
@supports (padding: max(0px)) {
    .mobile-header { padding-top: max(var(--safe-top), 0px); }
    .main-content { padding-top: calc(76px + max(var(--safe-top), 0px)); }
    .sidebar-footer { padding-bottom: calc(16px + max(var(--safe-bottom), 0px)); }
}
    </style>
</head>
<body>
    <!-- AUTH -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-logo">
                <span class="logo-icon">‚óâ</span>
                <h1>Th√©.OS Finance</h1>
                <p>G√©rez vos finances simplement</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Connexion</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Inscription</button>
            </div>
            
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Identifiant</label>
                    <input type="text" id="loginUsername" placeholder="Votre identifiant" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">Se connecter</button>
                <div class="auth-info">
                    üí° <strong>Nouvel appareil ?</strong> Utilisez "Lier un appareil" depuis l'app sur votre appareil principal.
                </div>
            </form>
            
            <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Identifiant</label>
                    <input type="text" id="registerUsername" placeholder="Choisissez un identifiant" required minlength="3" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="registerPassword" placeholder="Minimum 6 caract√®res" required minlength="6" autocomplete="new-password" oninput="checkStrength(this.value)">
                    <div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
                </div>
                <div class="form-group">
                    <label>Confirmer</label>
                    <input type="password" id="registerConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary" id="registerBtn">Cr√©er mon compte</button>
            </form>
            
            <div class="auth-form" id="linkForm">
                <div class="form-group">
                    <label>Code de liaison</label>
                    <input type="text" id="linkCode" placeholder="Entrez le code" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe du compte</label>
                    <input type="password" id="linkPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="button" class="btn-primary" onclick="handleLink()">Lier cet appareil</button>
                <button type="button" class="btn-secondary" onclick="showAuthTab('login')" style="margin-top:8px;width:100%">‚Üê Retour</button>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        <nav class="sidebar" id="sidebar">
            <div class="logo"><span class="logo-icon">‚óâ</span><span class="logo-text">Th√©.OS Finance</span></div>
            <div class="user-info">
                <div class="user-name" id="displayUserName">Utilisateur</div>
                <div class="user-sync" id="syncStatus">‚ü≥ Synchronisation...</div>
            </div>
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-section="dashboard"><span class="nav-icon">‚ó´</span> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="revenus"><span class="nav-icon">‚Üë</span> Revenus</a></li>
                <li><a href="#" class="nav-link" data-section="depenses"><span class="nav-icon">‚Üì</span> D√©penses</a></li>
                <li><a href="#" class="nav-link" data-section="abonnements"><span class="nav-icon">‚Üª</span> Abonnements</a></li>
                <li><a href="#" class="nav-link" data-section="epargne"><span class="nav-icon">‚óà</span> √âpargne</a></li>
                <li><a href="#" class="nav-link" data-section="settings"><span class="nav-icon">‚öô</span> R√©glages</a></li>
            </ul>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">‚èª D√©connexion</button>
            </div>
        </nav>
        
        <header class="mobile-header">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <span class="mobile-title">Th√©.OS Finance</span>
            <button class="menu-toggle mobile-sync" onclick="syncNow()">‚Üª</button>
        </header>
        
        <main class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="section-header">
                    <div><h1>Dashboard</h1><p class="today-date" id="todayDate"></p></div>
                    <div class="period-selector">
                        <select id="periodType" onchange="updateDashboard()"><option value="month">Mois</option><option value="year">Ann√©e</option><option value="all">Tout</option></select>
                        <select id="periodMonth" onchange="updateDashboard()"></select>
                        <select id="periodYear" onchange="updateDashboard()"></select>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card stat-revenus"><div class="stat-label">Revenus</div><div class="stat-value" id="statRevenus">0 ‚Ç¨</div><div class="stat-detail" id="statRevenusDetail">0 entr√©es</div></div>
                    <div class="stat-card stat-depenses"><div class="stat-label">D√©penses</div><div class="stat-value" id="statDepenses">0 ‚Ç¨</div><div class="stat-detail" id="statDepensesDetail">0 entr√©es</div></div>
                    <div class="stat-card stat-net"><div class="stat-label">Net</div><div class="stat-value" id="statNet">0 ‚Ç¨</div><div class="stat-detail" id="statNetDetail">‚Äî</div></div>
                    <div class="stat-card stat-abonnements"><div class="stat-label">Abonnements</div><div class="stat-value" id="statAbo">0 ‚Ç¨</div><div class="stat-detail" id="statAboDetail">0 actifs</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>D√©penses par cat√©gorie</h3><div class="chart-container"><canvas id="chartDep"></canvas></div><div id="legendDep" class="chart-legend"></div></div>
                    <div class="chart-card"><h3>Revenus par cat√©gorie</h3><div class="chart-container"><canvas id="chartRev"></canvas></div><div id="legendRev" class="chart-legend"></div></div>
                </div>
                <div class="bottom-grid">
                    <div class="card"><h3>R√©sum√©</h3><div class="summary-list"><div class="summary-item"><span class="summary-label">Top d√©pense</span><span class="summary-value" id="sumTopDep">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top revenu</span><span class="summary-value" id="sumTopRev">‚Äî</span></div><div class="summary-item"><span class="summary-label">Moyenne d√©penses</span><span class="summary-value" id="sumAvgDep">‚Äî</span></div><div class="summary-item"><span class="summary-label">Top cat√©gorie</span><span class="summary-value" id="sumTopCat">‚Äî</span></div></div></div>
                    <div class="card"><h3>Prochains paiements</h3><div class="upcoming-list" id="upcomingList"><div class="empty-state">Aucun abonnement</div></div></div>
                    <div class="card"><h3>√âpargne</h3><div class="savings-summary"><div class="savings-total"><span class="savings-label">Total</span><span class="savings-value" id="savTotal">0 ‚Ç¨</span></div><div class="savings-accounts" id="savAccounts"></div></div></div>
                </div>
            </section>

            <!-- Revenus -->
            <section id="revenus" class="section">
                <div class="section-header"><h1>Revenus</h1><button class="btn-primary" onclick="openModal('revenu')">+ Ajouter</button></div>
                <div class="filters"><input type="text" id="filterRev" placeholder="Rechercher..." oninput="filterList('revenus')"><select id="filterRevCat" onchange="filterList('revenus')"><option value="">Toutes</option></select></div>
                <div class="list-container" id="listRevenus"></div>
            </section>

            <!-- D√©penses -->
            <section id="depenses" class="section">
                <div class="section-header"><h1>D√©penses</h1><button class="btn-primary" onclick="openModal('depense')">+ Ajouter</button></div>
                <div class="filters"><input type="text" id="filterDep" placeholder="Rechercher..." oninput="filterList('depenses')"><select id="filterDepCat" onchange="filterList('depenses')"><option value="">Toutes</option></select></div>
                <div class="list-container" id="listDepenses"></div>
            </section>

            <!-- Abonnements -->
            <section id="abonnements" class="section">
                <div class="section-header"><h1>Abonnements</h1><button class="btn-primary" onclick="openModal('abonnement')">+ Ajouter</button></div>
                <div class="abonnements-summary"><div class="abo-stat"><span class="abo-stat-value" id="aboMonth">0 ‚Ç¨</span><span class="abo-stat-label">/ mois</span></div><div class="abo-stat"><span class="abo-stat-value" id="aboYear">0 ‚Ç¨</span><span class="abo-stat-label">/ an</span></div></div>
                <div class="list-container" id="listAbonnements"></div>
            </section>

            <!-- √âpargne -->
            <section id="epargne" class="section">
                <div class="section-header"><h1>√âpargne</h1><button class="btn-primary" onclick="openModal('epargne')">+ Compte</button></div>
                <div class="epargne-total"><span class="epargne-total-label">Total √©pargn√©</span><span class="epargne-total-value" id="epTotal">0 ‚Ç¨</span></div>
                <div class="epargne-grid" id="epGrid"></div>
                <div class="section-subheader"><h2>Mouvements</h2><button class="btn-secondary" onclick="openModal('mouvement')">+ Mouvement</button></div>
                <div class="list-container" id="listMouvements"></div>
            </section>

            <!-- Settings -->
            <section id="settings" class="section">
                <div class="section-header"><h1>R√©glages</h1></div>
                
                <div class="settings-card">
                    <h3>üë§ Mon compte</h3>
                    <div class="account-box">
                        <div class="account-row"><span class="account-label">Identifiant</span><span class="account-value" id="accUser">‚Äî</span></div>
                        <div class="account-row"><span class="account-label">Cr√©√© le</span><span class="account-value" id="accCreated">‚Äî</span></div>
                        <div class="account-row"><span class="account-label">Derni√®re sync</span><span class="account-value" id="accSync">‚Äî</span></div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn-secondary" onclick="showLinkCode()">üì± Lier un appareil</button>
                        <button class="btn-secondary" onclick="syncNow()">‚Üª Synchroniser</button>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>üîê S√©curit√©</h3>
                    <div class="settings-row"><div><label>Changer le mot de passe</label></div><button class="btn-secondary" onclick="openChangePwd()">Modifier</button></div>
                    <div class="settings-row"><div><label>Masquer les montants</label><p class="settings-hint">Floute les montants</p></div><label class="toggle-switch"><input type="checkbox" id="setHide" onchange="toggle('hideAmounts',this.checked)"><span class="toggle-slider"></span></label></div>
                </div>

                <div class="settings-card">
                    <h3>üé® Apparence</h3>
                    <div class="settings-row"><div><label>Th√®me</label></div><select id="setTheme" onchange="changeTheme(this.value)"><option value="dark">üåô Sombre</option><option value="light">‚òÄÔ∏è Clair</option><option value="auto">üåì Auto</option></select></div>
                    <div class="settings-row"><div><label>Couleur d'accent</label></div><select id="setAccent" onchange="changeAccent(this.value)"><option value="#ff3b30">üî¥ Rouge</option><option value="#ff9500">üü† Orange</option><option value="#ffcc00">üü° Jaune</option><option value="#34c759">üü¢ Vert</option><option value="#007aff">üîµ Bleu</option><option value="#af52de">üü£ Violet</option><option value="#ff2d55">üíó Rose</option></select></div>
                </div>

                <div class="settings-card">
                    <h3>üí∞ Format</h3>
                    <div class="settings-row"><div><label>Devise</label></div><select id="setCurrency" onchange="save('currency',this.value);refresh()"><option value="EUR">‚Ç¨ Euro</option><option value="USD">$ Dollar</option><option value="GBP">¬£ Livre</option><option value="CHF">CHF</option></select></div>
                    <div class="settings-row"><div><label>Format date</label></div><select id="setDate" onchange="save('dateFormat',this.value);refresh()"><option value="DD/MM/YYYY">DD/MM/YYYY</option><option value="MM/DD/YYYY">MM/DD/YYYY</option><option value="YYYY-MM-DD">YYYY-MM-DD</option></select></div>
                    <div class="settings-row"><div><label>Afficher centimes</label></div><label class="toggle-switch"><input type="checkbox" id="setCents" checked onchange="toggle('showCents',this.checked);refresh()"><span class="toggle-slider"></span></label></div>
                </div>

                <div class="settings-card">
                    <h3>üìä Objectifs</h3>
                    <div class="settings-row"><div><label>Budget mensuel</label></div><input type="number" id="setBudget" placeholder="2000" onchange="save('budget',this.value)"></div>
                    <div class="settings-row"><div><label>√âpargne mensuelle</label></div><input type="number" id="setSavings" placeholder="500" onchange="save('savingsGoal',this.value)"></div>
                </div>

                <div class="settings-card">
                    <h3>üè∑Ô∏è Cat√©gories</h3>
                    <div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Revenus</label><div class="tags-container" id="tagsRev"></div><div class="add-tag-row"><input type="text" id="newTagRev" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('revenus')">+</button></div></div>
                    <div class="settings-row" style="flex-direction:column;align-items:stretch"><label>D√©penses</label><div class="tags-container" id="tagsDep"></div><div class="add-tag-row"><input type="text" id="newTagDep" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('depenses')">+</button></div></div>
                    <div class="settings-row" style="flex-direction:column;align-items:stretch"><label>Abonnements</label><div class="tags-container" id="tagsAbo"></div><div class="add-tag-row"><input type="text" id="newTagAbo" placeholder="Nouvelle..."><button class="btn-secondary" onclick="addCat('abonnements')">+</button></div></div>
                </div>

                <div class="settings-card">
                    <h3>üíæ Donn√©es</h3>
                    <div class="settings-row"><div><label>Export JSON</label></div><button class="btn-secondary" onclick="exportJSON()">T√©l√©charger</button></div>
                    <div class="settings-row"><div><label>Export Excel</label></div><button class="btn-secondary" onclick="exportXLS()">T√©l√©charger</button></div>
                    <div class="settings-row"><div><label>Importer</label></div><button class="btn-secondary" onclick="document.getElementById('importFile').click()">Importer</button><input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)"></div>
                </div>

                <div class="settings-card danger">
                    <h3>‚ö†Ô∏è Zone danger</h3>
                    <div class="settings-row"><div><label>Effacer les donn√©es</label><p class="settings-hint">Garde le compte, supprime les donn√©es</p></div><button class="btn-danger" onclick="clearData()">Effacer</button></div>
                    <div class="settings-row"><div><label>Supprimer le compte</label><p class="settings-hint">Supprime tout d√©finitivement</p></div><button class="btn-danger" onclick="deleteAccount()">Supprimer</button></div>
                </div>

                <div class="settings-card"><h3>‚ÑπÔ∏è √Ä propos</h3><p class="settings-about"><strong>Th√©.OS Finance</strong> v2.0<br>Cr√©√© avec ‚ù§Ô∏è</p></div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header"><h2 id="modalTitle">Ajouter</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <form id="modalForm" onsubmit="submitModal(event)">
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button><button type="submit" class="btn-primary">Enregistrer</button></div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
// === DATA ===
let data = { revenus: [], depenses: [], abonnements: [], epargne: [], mouvements: [], categories: { revenus: ['Salaire','Freelance','YouTube','Templates','Investissements','Autre'], depenses: ['Alimentation','Transport','Logement','Loisirs','Shopping','Tech','Auto','Sant√©','Autre'], abonnements: ['Streaming','Cloud','Software','Gaming','T√©l√©com','Sport','Autre'], epargne: ['Livret A','LDDS','PEA','Assurance-Vie','Crypto','Autre'] }};
let settings = { currency:'EUR', accent:'#ff3b30', theme:'dark', hideAmounts:false, showCents:true, dateFormat:'DD/MM/YYYY', budget:'', savingsGoal:'' };
let user = { username:'', passwordHash:'', code:'', createdAt:'', lastSync:'' };
let charts = { dep: null, rev: null };
const colors = ['#ff3b30','#ff9500','#ffcc00','#34c759','#007aff','#5856d6','#af52de','#ff2d55','#a2845e','#8e8e93'];
const API = 'https://jsonblob.com/api/jsonBlob';

// === AUTH ===
async function hash(s) { const e = new TextEncoder().encode(s); const h = await crypto.subtle.digest('SHA-256', e); return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2,'0')).join(''); }

function showAuthTab(t) {
    document.querySelectorAll('.auth-tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(x => x.classList.remove('active'));
    if (t === 'login') { document.querySelector('.auth-tab:first-child').classList.add('active'); document.getElementById('loginForm').classList.add('active'); }
    else if (t === 'register') { document.querySelector('.auth-tab:last-child').classList.add('active'); document.getElementById('registerForm').classList.add('active'); }
    else if (t === 'link') { document.getElementById('linkForm').classList.add('active'); }
}

function checkStrength(p) { const b = document.getElementById('strengthBar'); b.className = 'password-strength-bar ' + (p.length < 6 ? 'strength-weak' : p.length < 10 ? 'strength-medium' : 'strength-strong'); }

async function handleRegister(e) {
    e.preventDefault();
    const username = document.getElementById('registerUsername').value.trim().toLowerCase();
    const pwd = document.getElementById('registerPassword').value;
    const confirm = document.getElementById('registerConfirm').value;
    if (pwd !== confirm) { toast('Mots de passe diff√©rents', 'error'); return; }
    if (pwd.length < 6) { toast('Mot de passe trop court', 'error'); return; }
    if (username.length < 3) { toast('Identifiant trop court', 'error'); return; }
    
    document.getElementById('registerBtn').disabled = true;
    document.getElementById('registerBtn').textContent = 'Cr√©ation...';
    
    try {
        const ph = await hash(pwd);
        const newUser = { username, passwordHash: ph, createdAt: new Date().toISOString(), lastSync: new Date().toISOString() };
        const payload = { user: newUser, data, settings };
        
        const res = await fetch(API, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (res.ok) {
            const code = res.headers.get('Location').split('/').pop();
            user = { ...newUser, code };
            localStorage.setItem('theos_auth', JSON.stringify({ code, passwordHash: ph, username }));
            toast('Compte cr√©√© !', 'success');
            enterApp();
        } else { throw new Error('Erreur'); }
    } catch (err) { toast('Erreur cr√©ation', 'error'); }
    
    document.getElementById('registerBtn').disabled = false;
    document.getElementById('registerBtn').textContent = 'Cr√©er mon compte';
}

async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value.trim().toLowerCase();
    const pwd = document.getElementById('loginPassword').value;
    
    document.getElementById('loginBtn').disabled = true;
    document.getElementById('loginBtn').textContent = 'Connexion...';
    
    const auth = localStorage.getItem('theos_auth');
    if (auth) {
        try {
            const { code, passwordHash, username: storedUser } = JSON.parse(auth);
            const ph = await hash(pwd);
            if (storedUser === username && passwordHash === ph) {
                const res = await fetch(`${API}/${code}`);
                if (res.ok) {
                    const cloud = await res.json();
                    user = { ...cloud.user, code };
                    data = cloud.data || data;
                    settings = { ...settings, ...cloud.settings };
                    enterApp();
                    document.getElementById('loginBtn').disabled = false;
                    document.getElementById('loginBtn').textContent = 'Se connecter';
                    return;
                }
            }
        } catch {}
    }
    
    toast('Identifiants incorrects ou appareil non li√©', 'error');
    document.getElementById('loginBtn').disabled = false;
    document.getElementById('loginBtn').textContent = 'Se connecter';
}

async function handleLink() {
    const code = document.getElementById('linkCode').value.trim();
    const pwd = document.getElementById('linkPassword').value;
    
    try {
        const res = await fetch(`${API}/${code}`);
        if (!res.ok) { toast('Code invalide', 'error'); return; }
        
        const cloud = await res.json();
        const ph = await hash(pwd);
        
        if (cloud.user.passwordHash !== ph) { toast('Mot de passe incorrect', 'error'); return; }
        
        user = { ...cloud.user, code };
        data = cloud.data || data;
        settings = { ...settings, ...cloud.settings };
        
        localStorage.setItem('theos_auth', JSON.stringify({ code, passwordHash: ph, username: user.username }));
        toast('Appareil li√© !', 'success');
        enterApp();
    } catch (err) { toast('Erreur', 'error'); }
}

function showLinkCode() {
    document.getElementById('modalTitle').textContent = 'Lier un appareil';
    document.getElementById('modalBody').innerHTML = `
        <p style="color:var(--text-secondary);font-size:14px;margin-bottom:16px">Sur votre nouvel appareil, cliquez sur "Lier un appareil" dans l'√©cran de connexion et entrez ce code :</p>
        <div class="link-code-box">
            <div class="link-code">${user.code}</div>
            <p class="link-code-hint">Ce code est unique √† votre compte</p>
        </div>
        <button type="button" class="btn-secondary" onclick="navigator.clipboard.writeText('${user.code}');toast('Copi√© !','success')" style="width:100%">üìã Copier le code</button>
    `;
    document.getElementById('modalForm').onsubmit = (e) => { e.preventDefault(); closeModal(); };
    document.querySelector('.modal-footer').style.display = 'none';
    document.getElementById('modalOverlay').classList.add('active');
}

async function checkSession() {
    const auth = localStorage.getItem('theos_auth');
    if (!auth) return false;
    
    try {
        const { code, passwordHash } = JSON.parse(auth);
        const res = await fetch(`${API}/${code}`);
        if (!res.ok) return false;
        
        const cloud = await res.json();
        if (cloud.user.passwordHash !== passwordHash) return false;
        
        user = { ...cloud.user, code };
        data = cloud.data || data;
        settings = { ...settings, ...cloud.settings };
        return true;
    } catch { return false; }
}

function enterApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('app').classList.add('active');
    initApp();
}

function logout() {
    if (confirm('D√©connexion ?')) {
        localStorage.removeItem('theos_auth');
        location.reload();
    }
}

// === SYNC ===
let syncTimer = null;
function queueSync() { if (syncTimer) clearTimeout(syncTimer); syncTimer = setTimeout(syncNow, 2000); }

async function syncNow() {
    if (!user.code) return;
    setSyncStatus('syncing');
    try {
        user.lastSync = new Date().toISOString();
        await fetch(`${API}/${user.code}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user, data, settings }) });
        setSyncStatus('synced');
    } catch { setSyncStatus('error'); }
}

function setSyncStatus(s) {
    const el = document.getElementById('syncStatus');
    const icons = { syncing: '‚ü≥', synced: '‚úì', error: '‚úó' };
    const texts = { syncing: 'Sync...', synced: 'Synchronis√©', error: 'Erreur' };
    el.innerHTML = `${icons[s]} ${texts[s]}`;
    el.className = 'user-sync' + (s === 'synced' ? ' synced' : '');
}

// === INIT ===
document.addEventListener('DOMContentLoaded', async () => {
    if (await checkSession()) enterApp();
    
    // Link device button in login form
    document.querySelector('.auth-info').innerHTML += '<br><button type="button" onclick="showAuthTab(\'link\')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:13px;margin-top:8px">‚Üí Lier un appareil existant</button>';
});

function initApp() {
    applySettings();
    initNav();
    initPeriod();
    updateDashboard();
    renderAll();
    renderSettings();
    updateDate();
    document.getElementById('displayUserName').textContent = user.username || 'Utilisateur';
    setSyncStatus('synced');
}

function refresh() { renderAll(); updateDashboard(); }

// === SETTINGS ===
function applySettings() {
    document.documentElement.style.setProperty('--accent', settings.accent);
    const theme = settings.theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : settings.theme;
    document.documentElement.setAttribute('data-theme', theme);
}

function renderSettings() {
    document.getElementById('setTheme').value = settings.theme;
    document.getElementById('setAccent').value = settings.accent;
    document.getElementById('setCurrency').value = settings.currency;
    document.getElementById('setDate').value = settings.dateFormat;
    document.getElementById('setHide').checked = settings.hideAmounts;
    document.getElementById('setCents').checked = settings.showCents;
    document.getElementById('setBudget').value = settings.budget;
    document.getElementById('setSavings').value = settings.savingsGoal;
    document.getElementById('accUser').textContent = user.username || '‚Äî';
    document.getElementById('accCreated').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString('fr-FR') : '‚Äî';
    document.getElementById('accSync').textContent = user.lastSync ? new Date(user.lastSync).toLocaleString('fr-FR') : '‚Äî';
    renderTags();
}

function save(k, v) { settings[k] = v; queueSync(); }
function toggle(k, v) { settings[k] = v; applySettings(); queueSync(); refresh(); }
function changeTheme(t) { settings.theme = t; applySettings(); queueSync(); }
function changeAccent(c) { settings.accent = c; applySettings(); queueSync(); }

function openChangePwd() {
    document.getElementById('modalTitle').textContent = 'Changer mot de passe';
    document.getElementById('modalBody').innerHTML = '<div class="form-group"><label>Actuel</label><input type="password" id="pwdOld" required></div><div class="form-group"><label>Nouveau</label><input type="password" id="pwdNew" required minlength="6"></div><div class="form-group"><label>Confirmer</label><input type="password" id="pwdConfirm" required></div>';
    document.getElementById('modalForm').onsubmit = changePwd;
    document.querySelector('.modal-footer').style.display = 'flex';
    document.getElementById('modalOverlay').classList.add('active');
}

async function changePwd(e) {
    e.preventDefault();
    const old = await hash(document.getElementById('pwdOld').value);
    if (old !== user.passwordHash) { toast('Mot de passe incorrect', 'error'); return; }
    const n = document.getElementById('pwdNew').value;
    const c = document.getElementById('pwdConfirm').value;
    if (n !== c) { toast('Ne correspondent pas', 'error'); return; }
    if (n.length < 6) { toast('Trop court', 'error'); return; }
    user.passwordHash = await hash(n);
    const auth = JSON.parse(localStorage.getItem('theos_auth'));
    auth.passwordHash = user.passwordHash;
    localStorage.setItem('theos_auth', JSON.stringify(auth));
    await syncNow();
    closeModal();
    toast('Mot de passe modifi√©', 'success');
}

function clearData() {
    if (confirm('Effacer toutes les donn√©es ?') && confirm('S√ªr ?')) {
        data = { revenus: [], depenses: [], abonnements: [], epargne: [], mouvements: [], categories: data.categories };
        queueSync(); refresh();
        toast('Donn√©es effac√©es', 'success');
    }
}

async function deleteAccount() {
    if (confirm('SUPPRIMER le compte ?') && prompt('Tapez SUPPRIMER') === 'SUPPRIMER') {
        try {
            await fetch(`${API}/${user.code}`, { method: 'DELETE' });
            localStorage.removeItem('theos_auth');
            toast('Compte supprim√©', 'success');
            setTimeout(() => location.reload(), 1000);
        } catch { toast('Erreur', 'error'); }
    }
}

// === CATEGORIES ===
function renderTags() {
    const map = { revenus: 'Rev', depenses: 'Dep', abonnements: 'Abo' };
    ['revenus', 'depenses', 'abonnements'].forEach(t => {
        const c = document.getElementById('tags' + map[t]);
        if (c) c.innerHTML = data.categories[t].map(x => `<span class="tag">${x}<button class="tag-remove" onclick="removeCat('${t}','${x}')">√ó</button></span>`).join('');
    });
}

function addCat(t) {
    const map = { revenus: 'Rev', depenses: 'Dep', abonnements: 'Abo' };
    const i = document.getElementById('newTag' + map[t]);
    const v = i.value.trim();
    if (v && !data.categories[t].includes(v)) {
        data.categories[t].push(v);
        queueSync(); renderTags(); updateFilters(); i.value = '';
        toast('Ajout√©', 'success');
    }
}

function removeCat(t, c) {
    if (data.categories[t].length > 1 && confirm(`Supprimer "${c}" ?`)) {
        data.categories[t] = data.categories[t].filter(x => x !== c);
        queueSync(); renderTags(); updateFilters();
    }
}

// === NAV ===
function initNav() {
    document.querySelectorAll('.nav-link').forEach(l => {
        l.addEventListener('click', e => { e.preventDefault(); navigateTo(l.dataset.section); });
    });
}

function navigateTo(s) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector(`[data-section="${s}"]`).classList.add('active');
    document.querySelectorAll('.section').forEach(x => x.classList.remove('active'));
    document.getElementById(s).classList.add('active');
    closeSidebar();
    if (s === 'dashboard') updateDashboard();
    if (s === 'settings') renderSettings();
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.add('open');
    document.getElementById('sidebarOverlay').classList.add('active');
}

function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('active');
}

// === PERIOD ===
function initPeriod() {
    const m = document.getElementById('periodMonth');
    const months = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
    m.innerHTML = months.map((n, i) => `<option value="${i}">${n}</option>`).join('');
    m.value = new Date().getMonth();
    
    const y = document.getElementById('periodYear');
    for (let i = 2024; i <= 2030; i++) y.innerHTML += `<option value="${i}">${i}</option>`;
    y.value = new Date().getFullYear();
}

function getPeriod() {
    return {
        type: document.getElementById('periodType').value,
        month: parseInt(document.getElementById('periodMonth').value),
        year: parseInt(document.getElementById('periodYear').value)
    };
}

function updatePeriodVis() {
    const t = document.getElementById('periodType').value;
    document.getElementById('periodMonth').style.display = t === 'month' ? 'block' : 'none';
    document.getElementById('periodYear').style.display = t === 'all' ? 'none' : 'block';
}

function updateDate() {
    const d = new Date();
    const opts = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    const s = d.toLocaleDateString('fr-FR', opts);
    document.getElementById('todayDate').textContent = s.charAt(0).toUpperCase() + s.slice(1);
}

// === DASHBOARD ===
function updateDashboard() {
    updatePeriodVis();
    const p = getPeriod();
    const fr = filterPeriod(data.revenus, p);
    const fd = filterPeriod(data.depenses, p);
    const tr = fr.reduce((s, x) => s + x.montant, 0);
    const td = fd.reduce((s, x) => s + x.montant, 0);
    const net = tr - td;
    const ta = data.abonnements.reduce((s, x) => s + x.montant, 0);
    
    const hc = settings.hideAmounts ? ' hidden-amount' : '';
    document.getElementById('statRevenus').className = 'stat-value' + hc;
    document.getElementById('statDepenses').className = 'stat-value' + hc;
    document.getElementById('statNet').className = 'stat-value' + hc;
    document.getElementById('statAbo').className = 'stat-value' + hc;
    
    document.getElementById('statRevenus').textContent = fmt(tr);
    document.getElementById('statRevenusDetail').textContent = `${fr.length} entr√©es`;
    document.getElementById('statDepenses').textContent = fmt(td);
    document.getElementById('statDepensesDetail').textContent = `${fd.length} entr√©es`;
    document.getElementById('statNet').textContent = fmt(net);
    document.querySelector('.stat-net').className = 'stat-card stat-net ' + (net >= 0 ? 'positive' : 'negative');
    document.getElementById('statNetDetail').textContent = tr > 0 ? `${Math.round(net/tr*100)}% des revenus` : '‚Äî';
    document.getElementById('statAbo').textContent = fmt(ta);
    document.getElementById('statAboDetail').textContent = `${data.abonnements.length} actifs`;
    
    updateCharts(fd, fr);
    updateSummary(fd, fr);
    updateUpcoming();
    updateSavingsCard();
}

function filterPeriod(items, p) {
    if (p.type === 'all') return items;
    return items.filter(i => {
        const d = new Date(i.date);
        return p.type === 'year' ? d.getFullYear() === p.year : (d.getFullYear() === p.year && d.getMonth() === p.month);
    });
}

function updateCharts(fd, fr) {
    if (charts.dep) charts.dep.destroy();
    if (charts.rev) charts.rev.destroy();
    
    const gd = group(fd), gr = group(fr);
    charts.dep = makeChart('chartDep', gd);
    charts.rev = makeChart('chartRev', gr);
    renderLegend('legendDep', gd);
    renderLegend('legendRev', gr);
}

function group(items) {
    const g = {};
    items.forEach(i => { const c = i.categorie || 'Autre'; g[c] = (g[c] || 0) + i.montant; });
    return g;
}

function makeChart(id, d) {
    const ctx = document.getElementById(id).getContext('2d');
    const l = Object.keys(d), v = Object.values(d);
    if (!v.length) return new Chart(ctx, { type: 'doughnut', data: { labels: ['Vide'], datasets: [{ data: [1], backgroundColor: ['#2a2a2a'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
    return new Chart(ctx, { type: 'doughnut', data: { labels: l, datasets: [{ data: v, backgroundColor: colors.slice(0, l.length), borderWidth: 0, spacing: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${fmt(c.raw)}` } } } } });
}

function renderLegend(id, d) {
    const c = document.getElementById(id), l = Object.keys(d);
    c.innerHTML = l.length ? l.map((x, i) => `<span class="legend-item"><span class="legend-dot" style="background:${colors[i % colors.length]}"></span>${x}</span>`).join('') : '<span class="legend-item">Aucune donn√©e</span>';
}

function updateSummary(fd, fr) {
    const topD = fd.length ? fd.reduce((m, x) => x.montant > m.montant ? x : m) : null;
    document.getElementById('sumTopDep').textContent = topD ? `${topD.description.substring(0,15)}${topD.description.length > 15 ? '...' : ''}` : '‚Äî';
    const topR = fr.length ? fr.reduce((m, x) => x.montant > m.montant ? x : m) : null;
    document.getElementById('sumTopRev').textContent = topR ? `${topR.description.substring(0,15)}${topR.description.length > 15 ? '...' : ''}` : '‚Äî';
    document.getElementById('sumAvgDep').textContent = fd.length ? fmt(fd.reduce((s, x) => s + x.montant, 0) / fd.length) : '‚Äî';
    const g = group(fd), tc = Object.entries(g).sort((a, b) => b[1] - a[1])[0];
    document.getElementById('sumTopCat').textContent = tc ? tc[0] : '‚Äî';
}

function updateUpcoming() {
    const c = document.getElementById('upcomingList');
    if (!data.abonnements.length) { c.innerHTML = '<div class="empty-state">Aucun</div>'; return; }
    const t = new Date();
    const u = data.abonnements.map(a => {
        let nd = new Date(t.getFullYear(), t.getMonth(), a.jour || 1);
        if (nd <= t) nd = new Date(t.getFullYear(), t.getMonth() + 1, a.jour || 1);
        return { ...a, nd };
    }).sort((a, b) => a.nd - b.nd).slice(0, 4);
    c.innerHTML = u.map(a => `<div class="upcoming-item"><div class="upcoming-info"><span class="upcoming-name">${a.description}</span><span class="upcoming-date">${fmtDate(a.nd)}</span></div><span class="upcoming-amount">${fmt(a.montant)}</span></div>`).join('');
}

function updateSavingsCard() {
    const t = data.epargne.reduce((s, x) => s + x.solde, 0);
    document.getElementById('savTotal').textContent = fmt(t);
    const c = document.getElementById('savAccounts');
    c.innerHTML = data.epargne.length ? data.epargne.slice(0, 3).map(x => `<div class="savings-account-mini"><span>${x.nom}</span><span>${fmt(x.solde)}</span></div>`).join('') : '<div class="empty-state">Aucun</div>';
}

// === LISTS ===
function renderAll() { renderRevenus(); renderDepenses(); renderAbonnements(); renderEpargne(); renderMouvements(); updateFilters(); }

function renderRevenus() {
    const c = document.getElementById('listRevenus');
    const items = [...data.revenus].sort((a, b) => new Date(b.date) - new Date(a.date));
    c.innerHTML = items.length ? items.map(i => `<div class="list-item" data-id="${i.id}"><div class="list-item-icon green">‚Üë</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">${fmtDate(i.date)} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount green${settings.hideAmounts ? ' hidden-amount' : ''}">+${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('revenu','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('revenus','${i.id}')">√ó</button></div></div>`).join('') : '<div class="empty-state">Aucun revenu</div>';
}

function renderDepenses() {
    const c = document.getElementById('listDepenses');
    const items = [...data.depenses].sort((a, b) => new Date(b.date) - new Date(a.date));
    c.innerHTML = items.length ? items.map(i => `<div class="list-item" data-id="${i.id}"><div class="list-item-icon red">‚Üì</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">${fmtDate(i.date)} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount red${settings.hideAmounts ? ' hidden-amount' : ''}">-${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('depense','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('depenses','${i.id}')">√ó</button></div></div>`).join('') : '<div class="empty-state">Aucune d√©pense</div>';
}

function renderAbonnements() {
    const c = document.getElementById('listAbonnements');
    const tm = data.abonnements.reduce((s, a) => s + a.montant, 0);
    document.getElementById('aboMonth').textContent = fmt(tm);
    document.getElementById('aboYear').textContent = fmt(tm * 12);
    c.innerHTML = data.abonnements.length ? data.abonnements.map(i => `<div class="list-item" data-id="${i.id}"><div class="list-item-icon orange">‚Üª</div><div class="list-item-info"><span class="list-item-title">${i.description}</span><span class="list-item-subtitle">Le ${i.jour || 1} ‚Ä¢ ${i.categorie}</span></div><span class="list-item-amount orange${settings.hideAmounts ? ' hidden-amount' : ''}">${fmt(i.montant)}/mois</span><div class="list-item-actions"><button class="btn-icon" onclick="edit('abonnement','${i.id}')">‚úé</button><button class="btn-icon delete" onclick="del('abonnements','${i.id}')">√ó</button></div></div>`).join('') : '<div class="empty-state">Aucun abonnement</div>';
}

function renderEpargne() {
    const c = document.getElementById('epGrid');
    const t = data.epargne.reduce((s, x) => s + x.solde, 0);
    document.getElementById('epTotal').textContent = fmt(t);
    c.innerHTML = data.epargne.length ? data.epargne.map(x => `<div class="epargne-card"><div class="epargne-card-header"><span class="epargne-card-name">${x.nom}</span><span class="epargne-card-type">${x.type}</span></div><div class="epargne-card-amount${settings.hideAmounts ? ' hidden-amount' : ''}">${fmt(x.solde)}</div><div class="epargne-card-footer"><span class="epargne-card-goal">${x.objectif ? 'Obj: ' + fmt(x.objectif) : 'Pas d\'objectif'}</span><div class="epargne-card-actions"><button class="btn-icon" onclick="edit('epargne','${x.id}')">‚úé</button><button class="btn-icon delete" onclick="del('epargne','${x.id}')">√ó</button></div></div></div>`).join('') : '<div class="empty-state">Aucun compte</div>';
}

function renderMouvements() {
    const c = document.getElementById('listMouvements');
    const items = [...data.mouvements].sort((a, b) => new Date(b.date) - new Date(a.date));
    c.innerHTML = items.length ? items.map(i => {
        const cp = data.epargne.find(e => e.id === i.compteId);
        const d = i.type === 'depot';
        return `<div class="list-item"><div class="list-item-icon ${d ? 'blue' : 'purple'}">${d ? '‚Üë' : '‚Üì'}</div><div class="list-item-info"><span class="list-item-title">${i.description || (d ? 'D√©p√¥t' : 'Retrait')}</span><span class="list-item-subtitle">${fmtDate(i.date)} ‚Ä¢ ${cp ? cp.nom : '?'}</span></div><span class="list-item-amount ${d ? 'blue' : 'purple'}${settings.hideAmounts ? ' hidden-amount' : ''}">${d ? '+' : '-'}${fmt(i.montant)}</span><div class="list-item-actions"><button class="btn-icon delete" onclick="del('mouvements','${i.id}')">√ó</button></div></div>`;
    }).join('') : '<div class="empty-state">Aucun mouvement</div>';
}

function updateFilters() {
    document.getElementById('filterRevCat').innerHTML = '<option value="">Toutes</option>' + data.categories.revenus.map(c => `<option>${c}</option>`).join('');
    document.getElementById('filterDepCat').innerHTML = '<option value="">Toutes</option>' + data.categories.depenses.map(c => `<option>${c}</option>`).join('');
}

function filterList(t) {
    const idMap = { revenus: 'Rev', depenses: 'Dep' };
    const s = document.getElementById('filter' + idMap[t]).value.toLowerCase();
    const cat = document.getElementById('filter' + idMap[t] + 'Cat').value;
    const listId = t === 'revenus' ? 'listRevenus' : 'listDepenses';
    document.querySelectorAll(`#${listId} .list-item`).forEach(i => {
        const ti = i.querySelector('.list-item-title').textContent.toLowerCase();
        const su = i.querySelector('.list-item-subtitle').textContent;
        i.style.display = ti.includes(s) && (!cat || su.includes(cat)) ? 'flex' : 'none';
    });
}

// === MODAL ===
let editId = null, editType = null;

function openModal(type, id = null) {
    editType = type; editId = id;
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    document.querySelector('.modal-footer').style.display = 'flex';
    let html = '';
    
    if (type === 'revenu') {
        const r = id ? data.revenus.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier revenu' : 'Ajouter revenu';
        html = `<div class="form-group"><label>Description</label><input name="description" required value="${r?.description || ''}" placeholder="Ex: Salaire"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="${r?.montant || ''}" placeholder="0.00"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${r?.date || new Date().toISOString().split('T')[0]}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${data.categories.revenus.map(c => `<option ${r?.categorie === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>`;
    } else if (type === 'depense') {
        const d = id ? data.depenses.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier d√©pense' : 'Ajouter d√©pense';
        html = `<div class="form-group"><label>Description</label><input name="description" required value="${d?.description || ''}" placeholder="Ex: Courses"></div><div class="form-row"><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required value="${d?.montant || ''}" placeholder="0.00"></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${d?.date || new Date().toISOString().split('T')[0]}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${data.categories.depenses.map(c => `<option ${d?.categorie === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>`;
    } else if (type === 'abonnement') {
        const a = id ? data.abonnements.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier abonnement' : 'Ajouter abonnement';
        html = `<div class="form-group"><label>Description</label><input name="description" required value="${a?.description || ''}" placeholder="Ex: Netflix"></div><div class="form-row"><div class="form-group"><label>Montant/mois</label><input type="number" name="montant" step="0.01" required value="${a?.montant || ''}" placeholder="0.00"></div><div class="form-group"><label>Jour</label><input type="number" name="jour" min="1" max="31" value="${a?.jour || 1}"></div></div><div class="form-group"><label>Cat√©gorie</label><select name="categorie">${data.categories.abonnements.map(c => `<option ${a?.categorie === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>`;
    } else if (type === 'epargne') {
        const e = id ? data.epargne.find(x => x.id === id) : null;
        title.textContent = id ? 'Modifier compte' : 'Ajouter compte';
        html = `<div class="form-group"><label>Nom</label><input name="nom" required value="${e?.nom || ''}" placeholder="Ex: Livret A"></div><div class="form-row"><div class="form-group"><label>Type</label><select name="type">${data.categories.epargne.map(c => `<option ${e?.type === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div><div class="form-group"><label>Solde</label><input type="number" name="solde" step="0.01" required value="${e?.solde || ''}" placeholder="0.00"></div></div><div class="form-group"><label>Objectif</label><input type="number" name="objectif" step="0.01" value="${e?.objectif || ''}" placeholder="Optionnel"></div>`;
    } else if (type === 'mouvement') {
        title.textContent = 'Mouvement';
        html = `<div class="form-group"><label>Compte</label><select name="compteId">${data.epargne.map(c => `<option value="${c.id}">${c.nom}</option>`).join('')}</select></div><div class="form-row"><div class="form-group"><label>Type</label><select name="type"><option value="depot">D√©p√¥t</option><option value="retrait">Retrait</option></select></div><div class="form-group"><label>Montant</label><input type="number" name="montant" step="0.01" required placeholder="0.00"></div></div><div class="form-group"><label>Date</label><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}"></div><div class="form-group"><label>Description</label><input name="description" placeholder="Optionnel"></div>`;
    }
    
    body.innerHTML = html;
    document.getElementById('modalForm').onsubmit = submitModal;
    document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    editId = null; editType = null;
}

function submitModal(e) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const entry = Object.fromEntries(fd.entries());
    if (entry.montant) entry.montant = parseFloat(entry.montant);
    if (entry.solde) entry.solde = parseFloat(entry.solde);
    if (entry.objectif) entry.objectif = entry.objectif ? parseFloat(entry.objectif) : null;
    if (entry.jour) entry.jour = parseInt(entry.jour);
    
    if (editType === 'revenu') {
        if (editId) { const i = data.revenus.findIndex(x => x.id === editId); data.revenus[i] = { ...data.revenus[i], ...entry }; }
        else { entry.id = genId(); data.revenus.push(entry); }
        renderRevenus();
    } else if (editType === 'depense') {
        if (editId) { const i = data.depenses.findIndex(x => x.id === editId); data.depenses[i] = { ...data.depenses[i], ...entry }; }
        else { entry.id = genId(); data.depenses.push(entry); }
        renderDepenses();
    } else if (editType === 'abonnement') {
        if (editId) { const i = data.abonnements.findIndex(x => x.id === editId); data.abonnements[i] = { ...data.abonnements[i], ...entry }; }
        else { entry.id = genId(); data.abonnements.push(entry); }
        renderAbonnements();
    } else if (editType === 'epargne') {
        if (editId) { const i = data.epargne.findIndex(x => x.id === editId); data.epargne[i] = { ...data.epargne[i], ...entry }; }
        else { entry.id = genId(); data.epargne.push(entry); }
        renderEpargne();
    } else if (editType === 'mouvement') {
        entry.id = genId();
        data.mouvements.push(entry);
        const cp = data.epargne.find(x => x.id === entry.compteId);
        if (cp) cp.solde += entry.type === 'depot' ? entry.montant : -entry.montant;
        renderMouvements(); renderEpargne();
    }
    
    queueSync(); updateDashboard(); closeModal();
    toast('Enregistr√© !', 'success');
}

function edit(t, id) { openModal(t, id); }

function del(col, id) {
    if (confirm('Supprimer ?')) {
        data[col] = data[col].filter(x => x.id !== id);
        queueSync(); renderAll(); updateDashboard();
        toast('Supprim√©', 'success');
    }
}

// === EXPORT/IMPORT ===
function exportJSON() {
    const b = new Blob([JSON.stringify({ data, settings }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(b);
    a.download = `theos_${new Date().toISOString().split('T')[0]}.json`; a.click();
    toast('Export√©', 'success');
}

function exportXLS() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.revenus.map(r => ({ Description: r.description, Montant: r.montant, Date: r.date, Cat√©gorie: r.categorie }))), 'Revenus');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.depenses.map(d => ({ Description: d.description, Montant: d.montant, Date: d.date, Cat√©gorie: d.categorie }))), 'D√©penses');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.abonnements.map(a => ({ Description: a.description, Montant: a.montant, Jour: a.jour, Cat√©gorie: a.categorie }))), 'Abonnements');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.epargne.map(e => ({ Nom: e.nom, Type: e.type, Solde: e.solde, Objectif: e.objectif || '' }))), '√âpargne');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.mouvements.map(m => ({ Description: m.description, Type: m.type, Montant: m.montant, Date: m.date }))), 'Mouvements');
    XLSX.writeFile(wb, `theos_${new Date().toISOString().split('T')[0]}.xlsx`);
    toast('Excel export√©', 'success');
}

function importJSON(e) {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
        try {
            const imp = JSON.parse(ev.target.result);
            if (confirm('Remplacer les donn√©es ?')) {
                if (imp.data) data = imp.data;
                if (imp.settings) settings = { ...settings, ...imp.settings };
                queueSync(); applySettings(); renderAll(); updateDashboard(); renderSettings();
                toast('Import√©', 'success');
            }
        } catch { toast('Erreur', 'error'); }
    };
    r.readAsText(f);
    e.target.value = '';
}

// === UTILS ===
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

function fmt(a) {
    const opts = { style: 'currency', currency: settings.currency || 'EUR' };
    if (!settings.showCents) { opts.minimumFractionDigits = 0; opts.maximumFractionDigits = 0; }
    return new Intl.NumberFormat('fr-FR', opts).format(a);
}

function fmtDate(d) {
    const date = new Date(d);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    if (settings.dateFormat === 'MM/DD/YYYY') return `${month}/${day}/${year}`;
    if (settings.dateFormat === 'YYYY-MM-DD') return `${year}-${month}-${day}`;
    return `${day}/${month}/${year}`;
}

function toast(m, t = 'success') {
    const el = document.getElementById('toast');
    el.textContent = m;
    el.className = `toast show ${t}`;
    setTimeout(() => el.classList.remove('show'), 3000);
}
    </script>
</body>
</html>
